
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="baidu_union_verify" content="d1952c66cf48912e21c18c7c581f382a">
  <meta name="360-site-verification" content="67fbcc5a67f4c65c057315b28fa0b2c8" />
<meta name="google-site-verification" content="2GzxQ0VtXwTSUdmGm6DzcmhTzM_I9QmzCb_pzpMzD88" />
  
    <title>Nginx Rewrite的规则 | 听雨~</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="[object Object]">
    
    <meta name="description" content="来源，未验证，参考即可：http://blog.cafeneko.info/2010/10/nginx_rewrite_note/
在新主机的迁移过程中,最大的困难就是WP permalink rewrite的设置.
因为旧主机是用的Apache, 使用的是WP本身就可以更改的.htaccess,没">
    
    
    
    
    <link rel="alternate" href="atom.xml" title="听雨~" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">

    
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            var _bdId ='391982416296a0d54221f59fe35250d4';
             hm.src = "//hm.baidu.com/hm.js?" + _bdId;
             var s = document.getElementsByTagName("script")[0]; 
             s.parentNode.insertBefore(hm, s);
        })();
    </script>
     
</head>

  <body>
    <header>
      <div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="听雨~">听雨~</a></h1>
				<a class="blog-motto">昨夜卧听风吹雨，不若相忘于江湖。</a>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
					<li>
					
                                            <form class="search" action=http://search.baidu.com/cse/search target="_blank">
                                            <label>Search</label>
                                        <input name="s" type="hidden" value= null ><input type="text" name="q" size="30" placeholder="搜索"><br>
					
					</li>
				</ul>
                            </nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2011/12/14/Nginx-Rewrite的规则/" title="Nginx Rewrite的规则" itemprop="url">Nginx Rewrite的规则</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://umitime.com" title="[object Object]">[object Object]</a>
    </p>
  <p class="article-time">
    <time datetime="2011-12-14T02:29:57.000Z" itemprop="datePublished">12月 14 2011</time>
    更新日期:<time datetime="2014-10-15T04:37:55.000Z" itemprop="dateModified">10月 15 2014</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#/1_Nginx_rewrite基本语法"><span class="toc-number">1.</span> <span class="toc-text">/1 Nginx rewrite基本语法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#/2_Nginx_location_和_rewrite_retry"><span class="toc-number">2.</span> <span class="toc-text">/2 Nginx location 和 rewrite retry</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#/3_实战!_WordPress的Permalink+Supercache_rewrite实现"><span class="toc-number">3.</span> <span class="toc-text">/3 实战! WordPress的Permalink+Supercache rewrite实现</span></a></li></ol>
		</div>
		
		<p>来源，未验证，参考即可：<a href="http://blog.cafeneko.info/2010/10/nginx_rewrite_note/" target="_blank" rel="external">http://blog.cafeneko.info/2010/10/nginx_rewrite_note/</a></p>
<p>在新主机的迁移过程中,最大的困难就是WP permalink rewrite的设置.</p>
<p>因为旧主机是用的Apache, 使用的是WP本身就可以更改的.htaccess,没有太大的难度.而这次在VPS上跑的是Nginx,主要是因为Nginx的速度比Apache要快很多.</p>
<p>但是另一方面就不是那么舒服了,因为Nginx的rewrite跟Apache不同,而且是在服务器上面才能更改.</p>
<p>下面是其间的一些研究笔记.(以下用例如无特别说明均摘自nginx wiki)</p>
<p><span id="more-559"></span></p>
<h2 id="/1_Nginx_rewrite基本语法">/1 Nginx rewrite基本语法</h2>
<p>&nbsp;</p>
<p>Nginx的rewrite语法其实很简单.用到的指令无非是这几个</p>
<ul>
<li>set</li>
<li>if</li>
<li>return</li>
<li>break</li>
<li>rewrite</li>
</ul>
<p>麻雀虽小,<span style="text-decoration: line-through;">可御可萝</span>五脏俱全.只是简单的几个指令却可以做出绝对不输apache的简单灵活的配置.</p>
<p>1.set</p>
<p>set主要是用来设置变量用的,没什么特别的</p>
<p>2.if</p>
<p>if主要用来判断一些在rewrite语句中无法直接匹配的条件,比如检测文件存在与否,http header,cookie等,</p>
<blockquote>
<p>用法: if(条件) {…}</p>
</blockquote>
<ul>
<li><p>当if表达式中的条件为true,则执行if块中的语句</p>
</li>
<li><p>当表达式只是一个变量时,如果值为空或者任何以0开头的字符串都会当作false</p>
</li>
<li><p>直接比较内容时,使用 = 和 !=</p>
</li>
<li><p>使用正则表达式匹配时,使用</p>
</li>
</ul>
<blockquote>
<p>~ 大小写敏感匹配</p>
<p>~* 大小写不敏感匹配</p>
<p>!~ 大小写敏感不匹配</p>
<p>!~* 大小写不敏感不匹配</p>
</blockquote>
<p>这几句话看起来有点绕,总之记住: ~为正则匹配, 后置*为大小写不敏感, 前置!为”非”操作</p>
<p>随便一提,因为nginx使用花括号{}判断区块,所以当正则中包含花括号时,则必须用双引号将正则包起来.对下面讲到的rewrite语句中的正则亦是如此.</p>
<p>比如 “\d{4}\d{2}.+”</p>
<ul>
<li>使用-f,-d,-e,-x检测文件和目录</li>
</ul>
<blockquote>
<p>-f 检测文件存在</p>
<p>-d 检测目录存在</p>
<p>-e 检测文件,目录或者符号链接存在</p>
<p>-x 检测文件可执行</p>
</blockquote>
<p>跟~类似,前置!则为”非”操作</p>
<p>举例</p>
<div class="wp_syntax"><br><div class="code"><br><pre class="bash" style="font-family: monospace;"><span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">(</span><span style="color: #007800;">$http_user_agent</span> ~ MSIE<span style="color: #7a0874; font-weight: bold;">)</span> <span style="color: #7a0874; font-weight: bold;">{</span><br>  rewrite  ^<span style="color: #7a0874; font-weight: bold;">(</span>.<span style="color: #000000; font-weight: bold;">*</span><span style="color: #7a0874; font-weight: bold;">)</span>$  <span style="color: #000000; font-weight: bold;">/</span>msie<span style="color: #000000; font-weight: bold;">/</span><span style="color: #007800;">$1</span>  <span style="color: #7a0874; font-weight: bold;">break</span>;<br><span style="color: #7a0874; font-weight: bold;">}</span></pre><br></div><br></div>

<p>//如果UA包含”MSIE”,rewrite 请求到/msie目录下</p>
<div class="wp_syntax"><br><div class="code"><br><pre class="bash" style="font-family: monospace;"><span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">(</span><span style="color: #007800;">$http_cookie</span> ~<span style="color: #000000; font-weight: bold;">*</span> <span style="color: #ff0000;">“id=([^;] +)(?:;|$)”</span> <span style="color: #7a0874; font-weight: bold;">)</span> <span style="color: #7a0874; font-weight: bold;">{</span><br>  <span style="color: #000000; font-weight: bold;">set</span>  <span style="color: #007800;">$id</span>  <span style="color: #007800;">$1</span>;<br><span style="color: #7a0874; font-weight: bold;">}</span></pre><br></div><br></div>

<p>//如果cookie匹配正则,设置变量$id等于正则引用部分</p>
<div class="wp_syntax"><br><div class="code"><br><pre class="bash" style="font-family: monospace;"><span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">(</span><span style="color: #007800;">$request_method</span> = POST <span style="color: #7a0874; font-weight: bold;">)</span> <span style="color: #7a0874; font-weight: bold;">{</span><br>  <span style="color: #7a0874; font-weight: bold;">return</span> <span style="color: #000000;">405</span>;<br><span style="color: #7a0874; font-weight: bold;">}</span></pre><br></div><br></div>

<p>//如果提交方法为POST,则返回状态405 (Method not allowed)</p>
<div class="wp_syntax"><br><div class="code"><br><pre class="bash" style="font-family: monospace;"><span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">(</span><span style="color: #000000; font-weight: bold;">!</span>-f <span style="color: #007800;">$request_filename</span><span style="color: #7a0874; font-weight: bold;">)</span> <span style="color: #7a0874; font-weight: bold;">{</span><br>  <span style="color: #7a0874; font-weight: bold;">break</span>;<br>  proxy_pass  http:<span style="color: #000000; font-weight: bold;">//</span>127.0.0.1;<br><span style="color: #7a0874; font-weight: bold;">}</span></pre><br></div><br></div>

<p>//如果请求文件名不存在,则反向代理localhost</p>
<div class="wp_syntax"><br><div class="code"><br><pre class="bash" style="font-family: monospace;"><span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">(</span><span style="color: #007800;">$args</span> ~ <span style="color: #007800;">post</span>=<span style="color: #000000;">140</span><span style="color: #7a0874; font-weight: bold;">)</span><span style="color: #7a0874; font-weight: bold;">{</span><br>  rewrite ^ http:<span style="color: #000000; font-weight: bold;">//</span>example.com<span style="color: #000000; font-weight: bold;">/</span> permanent;<br><span style="color: #7a0874; font-weight: bold;">}</span></pre><br></div><br></div>

<p>//如果query string中包含”post=140″,永久重定向到example.com</p>
<p>3.return</p>
<p>return可用来直接设置HTTP返回状态,比如403,404等(301,302不可用return返回,这个下面会在rewrite提到)</p>
<p>4.break</p>
<p>立即停止rewrite检测,跟下面讲到的rewrite的break flag功能是一样的,区别在于前者是一个语句,后者是rewrite语句的flag</p>
<p>5.rewrite</p>
<p>最核心的功能(废话)</p>
<blockquote>
<p>用法: rewrite 正则 替换 标志位</p>
</blockquote>
<p>其中标志位有四种</p>
<blockquote>
<p>break – 停止rewrite检测,也就是说当含有break flag的rewrite语句被执行时,该语句就是rewrite的最终结果</p>
<p>last – 停止rewrite检测,但是跟break有本质的不同,last的语句<span style="font-weight: bold; color: #ff0000;">不一定</span>是最终结果,这点后面会跟nginx的location匹配一起提到</p>
<p>redirect – 返回302临时重定向,一般用于重定向到完整的URL(包含http:部分)</p>
<p>permanent – 返回301永久重定向,一般用于重定向到完整的URL(包含http:部分)</p>
</blockquote>
<p>因为301和302不能简单的只单纯返回状态码,还必须有重定向的URL,这就是return指令无法返回301,302的原因了. 作为替换,rewrite可以更灵活的使用redirect和permanent标志实现301和302. 比如上一篇日志中提到的Blog搬家要做的域名重定向,在nginx中就会这么写</p>
<div class="wp_syntax"><br><div class="code"><br><pre class="bash" style="font-family: monospace;">rewrite ^<span style="color: #7a0874; font-weight: bold;">(</span>.<span style="color: #000000; font-weight: bold;">*</span><span style="color: #7a0874; font-weight: bold;">)</span>$ http:<span style="color: #000000; font-weight: bold;">//</span>newdomain.com<span style="color: #000000; font-weight: bold;">/</span> permanent;</pre><br></div><br></div>

<p>举例来说一下rewrite的实际应用</p>
<div class="wp_syntax"><br><div class="code"><br><pre class="bash" style="font-family: monospace;">rewrite  ^<span style="color: #7a0874; font-weight: bold;">(</span><span style="color: #000000; font-weight: bold;">/</span>download<span style="color: #000000; font-weight: bold;">/</span>.<span style="color: #000000; font-weight: bold;"><em></em></span><span style="color: #7a0874; font-weight: bold;">)</span><span style="color: #000000; font-weight: bold;">/</span>media<span style="color: #000000; font-weight: bold;">/</span><span style="color: #7a0874; font-weight: bold;">(</span>.<span style="color: #000000; font-weight: bold;"></span><span style="color: #7a0874; font-weight: bold;">)</span>..<span style="color: #000000; font-weight: bold;">*</span>$  <span style="color: #007800;">$1</span><span style="color: #000000; font-weight: bold;">/</span>mp3<span style="color: #000000; font-weight: bold;">/</span><span style="color: #007800;">$2</span>.mp3  <span style="color: #c20cb9; font-weight: bold;">last</span>;</pre><br></div><br></div>

<p>如果请求为 /download/eva/media/op1.mp3 则请求被rewrite到 /download/eva/mp3/op1.mp3</p>
<p>使用起来就是这样,很简单不是么? 不过要注意的是rewrite有很多潜规则需要注意</p>
<ul>
<li><p>rewrite的生效区块为sever, location, if</p>
</li>
<li><p>rewrite只对相对路径进行匹配,不包含hostname 比如说以上面301重定向的例子说明</p>
</li>
</ul>
<div class="wp_syntax"><br><div class="code"><br><pre class="bash" style="font-family: monospace;">rewrite ~<span style="color: #000000; font-weight: bold;">*</span> cafeneko.info http:<span style="color: #000000; font-weight: bold;">//</span>newdomain.com<span style="color: #000000; font-weight: bold;">/</span> permanent;</pre><br></div><br></div>

<p>这句是永远无法执行的,以这个URL为例</p>
<blockquote>
<p><a href="http://blog.cafeneko.info/2010/10/neokoseseiki_in_new_home/?utm_source=rss&amp;utm_medium=rss&amp;utm_campaign=neokoseseiki_in_new_home" target="_blank" rel="external">http://blog.cafeneko.info/2010/10/neokoseseiki_in_new_home/?utm_source=rss&amp;utm_medium=rss&amp;utm_campaign=neokoseseiki_in_new_home</a></p>
</blockquote>
<p>其中cafeneko.info叫做hostname,再往后到?为止叫做相对路径,?后面的一串叫做query string</p>
<p>对于rewrite来说,其正则表达式仅对”/2010/10/neokoseseiki_in_new_home”这一部分进行匹配,即不包含hostname,也不包含query string .所以除非相对路径中包含跟域名一样的string,否则是不会匹配的. 如果非要做域名匹配的话就要使用if语句了,比如进行去www跳转</p>
<div class="wp_syntax"><br><div class="code"><br><pre class="bash" style="font-family: monospace;"><span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">(</span><span style="color: #007800;">$host</span> ~<span style="color: #000000; font-weight: bold;"><em></em></span> ^www.<span style="color: #7a0874; font-weight: bold;">(</span>cafeneko.info<span style="color: #7a0874; font-weight: bold;">)</span><span style="color: #7a0874; font-weight: bold;">)</span> <span style="color: #7a0874; font-weight: bold;">{</span><br>  <span style="color: #000000; font-weight: bold;">set</span> <span style="color: #007800;">$host_without_www</span> <span style="color: #007800;">$1</span>;<br>  rewrite ^<span style="color: #7a0874; font-weight: bold;">(</span>.<span style="color: #000000; font-weight: bold;"></span><span style="color: #7a0874; font-weight: bold;">)</span>$ http:<span style="color: #000000; font-weight: bold;">//</span><span style="color: #007800;">$host_without_www</span><span style="color: #007800;">$1</span> permanent;<br><span style="color: #7a0874; font-weight: bold;">}</span></pre><br></div><br></div>

<ul>
<li><p>使用相对路径rewrite时,会根据HTTP header中的HOST跟nginx的server_name匹配后进行rewrite,如果HOST不匹配或者没有HOST信息的话则rewrite到server_name设置的第一个域名,如果没有设置server_name的话,会使用本机的localhost进行rewrite</p>
</li>
<li><p>前面提到过,rewrite的正则是不匹配query string的,所以默认情况下,query string是自动追加到rewrite后的地址上的,如果不想自动追加query string,则在rewrite地址的末尾添加?</p>
</li>
</ul>
<div class="wp_syntax"><br><div class="code"><br><pre class="bash" style="font-family: monospace;">rewrite  ^<span style="color: #000000; font-weight: bold;">/</span>users<span style="color: #000000; font-weight: bold;">/</span><span style="color: #7a0874; font-weight: bold;">(</span>.<span style="color: #000000; font-weight: bold;">*</span><span style="color: #7a0874; font-weight: bold;">)</span>$  <span style="color: #000000; font-weight: bold;">/</span>show?<span style="color: #007800;">user</span>=<span style="color: #007800;">$1</span>?  <span style="color: #c20cb9; font-weight: bold;">last</span>;</pre><br></div><br></div>

<p>rewrite的基本知识就是这么多..但还没有完..还有最头疼的部分没有说…</p>
<p>&nbsp;</p>
<h2 id="/2_Nginx_location_和_rewrite_retry">/2 Nginx location 和 rewrite retry</h2>
<p>&nbsp;</p>
<p>nginx的rewrite有个很奇特的特性 — rewrite后的url会再次进行rewrite检查,最多重试10次,10次后还没有终止的话就会返回HTTP 500</p>
<p>用过nginx的朋友都知道location区块,location区块有点像Apache中的RewriteBase,但对于nginx来说location是控制的级别而已,里面的内容不仅仅是rewrite.</p>
<p>这里必须稍微先讲一点location的知识.location是nginx用来处理对同一个server不同的请求地址使用独立的配置的方式</p>
<p>举例:</p>
<div class="wp_syntax"><br><div class="code"><br><pre class="bash" style="font-family: monospace;">location  = <span style="color: #000000; font-weight: bold;">/</span> <span style="color: #7a0874; font-weight: bold;">{</span><br>  ….配置A<br><span style="color: #7a0874; font-weight: bold;">}</span><br><br>location  <span style="color: #000000; font-weight: bold;">/</span> <span style="color: #7a0874; font-weight: bold;">{</span><br>  ….配置B<br><span style="color: #7a0874; font-weight: bold;">}</span><br><br>location ^~ <span style="color: #000000; font-weight: bold;">/</span>images<span style="color: #000000; font-weight: bold;">/</span> <span style="color: #7a0874; font-weight: bold;">{</span><br>  ….配置C<br><span style="color: #7a0874; font-weight: bold;">}</span><br><br>location ~<span style="color: #000000; font-weight: bold;">*</span> .<span style="color: #7a0874; font-weight: bold;">(</span>gif<span style="color: #000000; font-weight: bold;">|</span>jpg<span style="color: #000000; font-weight: bold;">|</span>jpeg<span style="color: #7a0874; font-weight: bold;">)</span>$ <span style="color: #7a0874; font-weight: bold;">{</span><br>  ….配置D<br><span style="color: #7a0874; font-weight: bold;">}</span></pre><br></div><br></div>

<p>访问 / 会使用配置A</p>
<p>访问 /documents/document.html 会使用配置B</p>
<p>访问 /images/1.gif 会使用配置C</p>
<p>访问 /documents/1.jpg 会使用配置D</p>
<p>如何判断命中哪个location暂且按下不婊, 我们在实战篇再回头来看这个问题.</p>
<p>现在我们只需要明白一个情况: nginx可以有多个location并使用不同的配.</p>
<p>sever区块中如果有包含rewrite规则,则会最先执行,而且只会执行一次, 然后再判断命中哪个location的配置,再去执行该location中的rewrite, 当该location中的rewrite执行完毕时,rewrite并不会停止,而是根据rewrite过的URL再次判断location并执行其中的配置. 那么,这里就存在一个问题,如果rewrite写的不正确的话,是会在location区块间造成无限循环的.所以nginx才会加一个最多重试10次的上限. 比如这个例子</p>
<div class="wp_syntax"><br><div class="code"><br><pre class="bash" style="font-family: monospace;">location <span style="color: #000000; font-weight: bold;">/</span>download<span style="color: #000000; font-weight: bold;">/</span> <span style="color: #7a0874; font-weight: bold;">{</span><br>  rewrite  ^<span style="color: #7a0874; font-weight: bold;">(</span><span style="color: #000000; font-weight: bold;">/</span>download<span style="color: #000000; font-weight: bold;">/</span>.<span style="color: #000000; font-weight: bold;"><em></em></span><span style="color: #7a0874; font-weight: bold;">)</span><span style="color: #000000; font-weight: bold;">/</span>media<span style="color: #000000; font-weight: bold;">/</span><span style="color: #7a0874; font-weight: bold;">(</span>.<span style="color: #000000; font-weight: bold;"></span><span style="color: #7a0874; font-weight: bold;">)</span>..<span style="color: #000000; font-weight: bold;">*</span>$  <span style="color: #007800;">$1</span><span style="color: #000000; font-weight: bold;">/</span>mp3<span style="color: #000000; font-weight: bold;">/</span><span style="color: #007800;">$2</span>.mp3  <span style="color: #c20cb9; font-weight: bold;">last</span>;<br><span style="color: #7a0874; font-weight: bold;">}</span></pre><br></div><br></div>

<p>如果请求为 /download/eva/media/op1.mp3 则请求被rewrite到 /download/eva/mp3/op1.mp3</p>
<p>结果rewrite的结果重新命中了location /download/ 虽然这次并没有命中rewrite规则的正则表达式,但因为缺少终止rewrite的标志,其仍会不停重试download中rewrite规则直到达到10次上限返回HTTP 500</p>
<p>认真的朋友这时就会问了,上面的rewrite规则不是有标志位last么? last不是终止rewrite的意思么?</p>
<p>说到这里我就要抱怨下了,网上能找到关于nginx rewrite的文章中80%对last标志的解释都是</p>
<blockquote>
<p>last – 基本上都用这个Flag</p>
</blockquote>
<p>……这他妈坑爹呢!!! 什么叫基本上都用? 什么是不基本的情况?  =皿=</p>
<p>有兴趣的可以放狗”基本上都用这个Flag”…</p>
<p>我最终还是在stack overflow找到了答案:</p>
<p>last和break最大的不同在于</p>
<ul>
<li>break是终止当前location的rewrite检测,而且不再进行location匹配</li>
</ul>
<p>– last是终止当前location的rewrite检测,但会继续重试location匹配并处理区块中的rewrite规则</p>
<p>还是这个该死的例子</p>
<div class="wp_syntax"><br><div class="code"><br><pre class="bash" style="font-family: monospace;">location <span style="color: #000000; font-weight: bold;">/</span>download<span style="color: #000000; font-weight: bold;">/</span> <span style="color: #7a0874; font-weight: bold;">{</span><br>  rewrite  ^<span style="color: #7a0874; font-weight: bold;">(</span><span style="color: #000000; font-weight: bold;">/</span>download<span style="color: #000000; font-weight: bold;">/</span>.<span style="color: #000000; font-weight: bold;"><em></em></span><span style="color: #7a0874; font-weight: bold;">)</span><span style="color: #000000; font-weight: bold;">/</span>media<span style="color: #000000; font-weight: bold;">/</span><span style="color: #7a0874; font-weight: bold;">(</span>.<span style="color: #000000; font-weight: bold;"></span><span style="color: #7a0874; font-weight: bold;">)</span>..<span style="color: #000000; font-weight: bold;"><em></em></span>$  <span style="color: #007800;">$1</span><span style="color: #000000; font-weight: bold;">/</span>mp3<span style="color: #000000; font-weight: bold;">/</span><span style="color: #007800;">$2</span>.mp3  ;<br>  rewrite  ^<span style="color: #7a0874; font-weight: bold;">(</span><span style="color: #000000; font-weight: bold;">/</span>download<span style="color: #000000; font-weight: bold;">/</span>.<span style="color: #000000; font-weight: bold;"></span><span style="color: #7a0874; font-weight: bold;">)</span><span style="color: #000000; font-weight: bold;">/</span>movie<span style="color: #000000; font-weight: bold;">/</span><span style="color: #7a0874; font-weight: bold;">(</span>.<span style="color: #000000; font-weight: bold;"><em></em></span><span style="color: #7a0874; font-weight: bold;">)</span>..<span style="color: #000000; font-weight: bold;"></span>$  <span style="color: #007800;">$1</span><span style="color: #000000; font-weight: bold;">/</span>avi<span style="color: #000000; font-weight: bold;">/</span><span style="color: #007800;">$2</span>.mp3  ;<br>  rewrite  ^<span style="color: #7a0874; font-weight: bold;">(</span><span style="color: #000000; font-weight: bold;">/</span>download<span style="color: #000000; font-weight: bold;">/</span>.<span style="color: #000000; font-weight: bold;"><em></em></span><span style="color: #7a0874; font-weight: bold;">)</span><span style="color: #000000; font-weight: bold;">/</span>avvvv<span style="color: #000000; font-weight: bold;">/</span><span style="color: #7a0874; font-weight: bold;">(</span>.<span style="color: #000000; font-weight: bold;"></span><span style="color: #7a0874; font-weight: bold;">)</span>..<span style="color: #000000; font-weight: bold;">*</span>$  <span style="color: #007800;">$1</span><span style="color: #000000; font-weight: bold;">/</span>rmvb<span style="color: #000000; font-weight: bold;">/</span><span style="color: #007800;">$2</span>.mp3 ;<br><span style="color: #7a0874; font-weight: bold;">}</span></pre><br></div><br></div>

<p>上面没有写标志位,请各位自行脑补…</p>
<p>如果请求为 /download/acg/moive/UBW.avi</p>
<p>last的情况是: 在第2行rewrite处终止,并重试location /download..死循环</p>
<p>break的情况是: 在第2行rewrite处终止,其结果为最终的rewrite地址.</p>
<p>也就是说,上面的某位试图下载eva op不但没下到反而被HTTP 500射了一脸的例子正是因为用了last标志所以才会造成死循环,如果用break就没事了.</p>
<div class="wp_syntax"><br><div class="code"><br><pre class="bash" style="font-family: monospace;">location <span style="color: #000000; font-weight: bold;">/</span>download<span style="color: #000000; font-weight: bold;">/</span> <span style="color: #7a0874; font-weight: bold;">{</span><br>  rewrite  ^<span style="color: #7a0874; font-weight: bold;">(</span><span style="color: #000000; font-weight: bold;">/</span>download<span style="color: #000000; font-weight: bold;">/</span>.<span style="color: #000000; font-weight: bold;"><em></em></span><span style="color: #7a0874; font-weight: bold;">)</span><span style="color: #000000; font-weight: bold;">/</span>media<span style="color: #000000; font-weight: bold;">/</span><span style="color: #7a0874; font-weight: bold;">(</span>.<span style="color: #000000; font-weight: bold;"></span><span style="color: #7a0874; font-weight: bold;">)</span>..<span style="color: #000000; font-weight: bold;">*</span>$  <span style="color: #007800;">$1</span><span style="color: #000000; font-weight: bold;">/</span>mp3<span style="color: #000000; font-weight: bold;">/</span><span style="color: #007800;">$2</span>.mp3  <span style="color: #7a0874; font-weight: bold;">break</span>;<br><span style="color: #7a0874; font-weight: bold;">}</span></pre><br></div><br></div>

<p>对于这个问题,我个人的建议是,如果是全局性质的rewrite,最好放在server区块中并减少不必要的location区块.location区块中的rewrite要想清楚是用last还是break.</p>
<p>有人可能会问,用break不就万无一失了么?</p>
<p>不对.有些情况是要用last的. 典型的例子就是wordpress的permalink rewrite</p>
<p>常见的情况下, wordpress的rewrite是放在location /下面,并将请求rewrite到/index.php</p>
<p>这时如果这里使用break乃就挂了,不信试试. ｂ（￣▽￣）ｄ…因为nginx返回的是没有解释的index.php的源码…</p>
<p>这里一定要使用last才可以在结束location / 的rewrite, 并再次命中location ~ .php$,将其交给fastcgi进行解释.其后返回给浏览器的才是解释过的html代码.</p>
<p>关于nginx rewrite的简介到这里就全部讲完了,水平及其有限,请大家指出错漏…</p>
<p>&nbsp;</p>
<h2 id="/3_实战!_WordPress的Permalink+Supercache_rewrite实现">/3 实战! WordPress的Permalink+Supercache rewrite实现</h2>
<p>&nbsp;</p>
<p>这个rewrite写法其实是来自supercache作者本家的某个评论中,网上很容易查到,做了一些修改. 先给出该配置文件的全部内容..部分内容码掉了..绝对路径什么的你知道也没啥用对吧?</p>
<div class="wp_syntax"><br><div class="code"><br><pre class="bash" style="font-family: monospace;">server <span style="color: #7a0874; font-weight: bold;">{</span><br>    listen   <span style="color: #000000;">80</span>;<br>    server<em>name  cafeneko.info www.cafeneko.info;<br><br>    access_log  <span style="color: #000000; font-weight: bold;"><strong><em></em></strong></span>;<br>    error_log   <span style="color: #000000; font-weight: bold;"></span></em> ;<br><br>    root   <span style="color: #000000; font-weight: bold;"><em>**</em></span>;<br>    index  index.php;<br><br>    gzip_static on;<br><br>    <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">(</span>-f <span style="color: #007800;">$request_filename</span><span style="color: #7a0874; font-weight: bold;">)</span> <span style="color: #7a0874; font-weight: bold;">{</span><br>        <span style="color: #7a0874; font-weight: bold;">break</span>;<br>    <span style="color: #7a0874; font-weight: bold;">}</span><br><br>    <span style="color: #000000; font-weight: bold;">set</span> <span style="color: #007800;">$supercache_file</span> <span style="color: #ff0000;">‘’</span>;<br>    <span style="color: #000000; font-weight: bold;">set</span> <span style="color: #007800;">$supercache_uri</span> <span style="color: #007800;">$request_uri</span>;<br><br>    <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">(</span><span style="color: #007800;">$request_method</span> = POST<span style="color: #7a0874; font-weight: bold;">)</span> <span style="color: #7a0874; font-weight: bold;">{</span><br>        <span style="color: #000000; font-weight: bold;">set</span> <span style="color: #007800;">$supercache_uri</span> <span style="color: #ff0000;">‘’</span>;<br>    <span style="color: #7a0874; font-weight: bold;">}</span><br><br>    <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">(</span><span style="color: #007800;">$query_string</span><span style="color: #7a0874; font-weight: bold;">)</span> <span style="color: #7a0874; font-weight: bold;">{</span><br>        <span style="color: #000000; font-weight: bold;">set</span> <span style="color: #007800;">$supercache_uri</span> <span style="color: #ff0000;">‘’</span>;<br>    <span style="color: #7a0874; font-weight: bold;">}</span><br><br>    <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">(</span><span style="color: #007800;">$http_cookie</span> ~<span style="color: #000000; font-weight: bold;"></span> <span style="color: #ff0000;">“comment_author|wordpress<em>logged</em>|wp-postpass_”</span> <span style="color: #7a0874; font-weight: bold;">)</span> <span style="color: #7a0874; font-weight: bold;">{</span><br>        <span style="color: #000000; font-weight: bold;">set</span> <span style="color: #007800;">$supercache_uri</span> <span style="color: #ff0000;">‘’</span>;<br>    <span style="color: #7a0874; font-weight: bold;">}</span><br><br>    <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">(</span><span style="color: #007800;">$supercache_uri</span> ~ ^<span style="color: #7a0874; font-weight: bold;">(</span>.+<span style="color: #7a0874; font-weight: bold;">)</span>$<span style="color: #7a0874; font-weight: bold;">)</span> <span style="color: #7a0874; font-weight: bold;">{</span><br>        <span style="color: #000000; font-weight: bold;">set</span> <span style="color: #007800;">$supercache_file</span> <span style="color: #000000; font-weight: bold;">/</span>wp-content<span style="color: #000000; font-weight: bold;">/</span>cache<span style="color: #000000; font-weight: bold;">/</span>supercache<span style="color: #000000; font-weight: bold;">/</span><span style="color: #007800;">$http_host</span><span style="color: #000000; font-weight: bold;">/</span><span style="color: #007800;">$1</span>index.html;<br>    <span style="color: #7a0874; font-weight: bold;">}</span><br><br>    <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">(</span>-f <span style="color: #007800;">$document_root</span><span style="color: #007800;">$supercache_file</span><span style="color: #7a0874; font-weight: bold;">)</span> <span style="color: #7a0874; font-weight: bold;">{</span><br>        rewrite ^<span style="color: #7a0874; font-weight: bold;">(</span>.<span style="color: #000000; font-weight: bold;"><em></em></span><span style="color: #7a0874; font-weight: bold;">)</span>$ <span style="color: #007800;">$supercache_file</span> <span style="color: #7a0874; font-weight: bold;">break</span>;<br>    <span style="color: #7a0874; font-weight: bold;">}</span><br><br>    <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">(</span><span style="color: #000000; font-weight: bold;">!</span>-e <span style="color: #007800;">$request_filename</span><span style="color: #7a0874; font-weight: bold;">)</span> <span style="color: #7a0874; font-weight: bold;">{</span><br>        rewrite . <span style="color: #000000; font-weight: bold;">/</span>index.php <span style="color: #c20cb9; font-weight: bold;">last</span>;<br>    <span style="color: #7a0874; font-weight: bold;">}</span><br><br>    location ~ .php$ <span style="color: #7a0874; font-weight: bold;">{</span><br><br>        fastcgi_pass   127.0.0.1:<span style="color: #000000;">9000</span>;<br>        fastcgi_index  index.php;<br>        fastcgi_param  SCRIPT_FILENAME  <span style="color: #000000; font-weight: bold;">**</span><span style="color: #007800;">$fastcgi_script_name</span>;<br>        include        fastcgi_params;<br>    <span style="color: #7a0874; font-weight: bold;">}</span><br><br>    location ~ <span style="color: #000000; font-weight: bold;">/</span>.ht <span style="color: #7a0874; font-weight: bold;">{</span><br>        deny  all;<br>    <span style="color: #7a0874; font-weight: bold;">}</span><br><span style="color: #7a0874; font-weight: bold;">}</span></pre><br></div><br></div>

<p>下面是解释:</p>
<div class="wp_syntax"><br><div class="code"><br><pre class="bash" style="font-family: monospace;">gzip_static on;</pre><br></div><br></div>

<p>如果浏览器支持gzip,则在压缩前先寻找是否存在压缩好的同名gz文件避免再次压缩浪费资源,配合supercache的压缩功能一起使用效果最好,相比supercache原生的Apache mod_rewrite实现,nginx的实现简单的多. Apache mod_rewrite足足用了两套看起来一模一样的条件判断来分别rewrite支持gzip压缩和不支持的情况.</p>
<div class="wp_syntax"><br><div class="code"><br><pre class="bash" style="font-family: monospace;"><span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">(</span>-f <span style="color: #007800;">$request_filename</span><span style="color: #7a0874; font-weight: bold;">)</span> <span style="color: #7a0874; font-weight: bold;">{</span><br>    <span style="color: #7a0874; font-weight: bold;">break</span>;<br><span style="color: #7a0874; font-weight: bold;">}</span></pre><br></div><br></div>

<p>//如果是直接请求某个真实存在的文件,则用break语句停止rewrite检查</p>
<div class="wp_syntax"><br><div class="code"><br><pre class="bash" style="font-family: monospace;"><span style="color: #000000; font-weight: bold;">set</span> <span style="color: #007800;">$supercache_file</span> <span style="color: #ff0000;">‘’</span>;<br><span style="color: #000000; font-weight: bold;">set</span> <span style="color: #007800;">$supercache_uri</span> <span style="color: #007800;">$request_uri</span>;</pre><br></div><br></div>

<p>//用$request_uri初始化变量 $supercache_uri.</p>
<div class="wp_syntax"><br><div class="code"><br><pre class="bash" style="font-family: monospace;"><span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">(</span><span style="color: #007800;">$request_method</span> = POST<span style="color: #7a0874; font-weight: bold;">)</span> <span style="color: #7a0874; font-weight: bold;">{</span><br>    <span style="color: #000000; font-weight: bold;">set</span> <span style="color: #007800;">$supercache_uri</span> <span style="color: #ff0000;">‘’</span>;<br><span style="color: #7a0874; font-weight: bold;">}</span></pre><br></div><br></div>

<p>//如果请求方式为POST,则不使用supercache.这里用清空$supercache_uri的方法来跳过检测,下面会看到</p>
<div class="wp_syntax"><br><div class="code"><br><pre class="bash" style="font-family: monospace;"><span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">(</span><span style="color: #007800;">$query_string</span><span style="color: #7a0874; font-weight: bold;">)</span> <span style="color: #7a0874; font-weight: bold;">{</span><br>    <span style="color: #000000; font-weight: bold;">set</span> <span style="color: #007800;">$supercache_uri</span> <span style="color: #ff0000;">‘’</span>;<br><span style="color: #7a0874; font-weight: bold;">}</span></pre><br></div><br></div>

<p>//因为使用了rewrite的原因,正常情况下不应该有query_string(一般只有后台才会出现query string),有的话则不使用supercache</p>
<div class="wp_syntax"><br><div class="code"><br><pre class="bash" style="font-family: monospace;"><span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">(</span><span style="color: #007800;">$http<em>cookie</em></span> ~<span style="color: #000000; font-weight: bold;">*</span> <span style="color: #ff0000;">“comment_author|wordpress<em>logged</em>|wp-postpass_”</span> <span style="color: #7a0874; font-weight: bold;">)</span> <span style="color: #7a0874; font-weight: bold;">{</span><br>    <span style="color: #000000; font-weight: bold;">set</span> <span style="color: #007800;">$supercache_uri</span> <span style="color: #ff0000;">‘’</span>;<br><span style="color: #7a0874; font-weight: bold;">}</span></pre><br></div><br></div>

<p>//默认情况下,supercache是仅对unknown user使用的.其他诸如登录用户或者评论过的用户则不使用.</p>
<p>comment_author是测试评论用户的cookie, wordpress_logged是测试登录用户的cookie. wp-postpass不大清楚,字面上来看可能是曾经发表过文章的?只要cookie中含有这些字符串则条件成立.</p>
<p>原来的写法中检测登录用户cookie用的是wordpress<em>,但是我在测试中发现登入/登出以后还会有一个叫wordpress_test_cookie存在,不知道是什么作用,我也不清楚一般用户是否会产生这个cookie.由于考虑到登出以后这个cookie依然存在可能会影响到cache的判断,于是把这里改成了匹配wordpress_logged</em></p>
<div class="wp_syntax"><br><div class="code"><br><pre class="bash" style="font-family: monospace;"><span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">(</span><span style="color: #007800;">$supercache_uri</span> ~ ^<span style="color: #7a0874; font-weight: bold;">(</span>.+<span style="color: #7a0874; font-weight: bold;">)</span>$<span style="color: #7a0874; font-weight: bold;">)</span> <span style="color: #7a0874; font-weight: bold;">{</span><br>    <span style="color: #000000; font-weight: bold;">set</span> <span style="color: #007800;">$supercache_file</span> <span style="color: #000000; font-weight: bold;">/</span>wp-content<span style="color: #000000; font-weight: bold;">/</span>cache<span style="color: #000000; font-weight: bold;">/</span>supercache<span style="color: #000000; font-weight: bold;">/</span><span style="color: #007800;">$http_host</span><span style="color: #007800;">$1</span>index.html;<br><span style="color: #7a0874; font-weight: bold;">}</span></pre><br></div><br></div>

<p>//如果变量$supercache_uri不为空,则设置cache file的路径</p>
<p>这里稍微留意下$http_host$1index.html这串东西,其实写成 $http_host/$1/index.html 就好懂很多</p>
<p>以这个rewrite形式的url为例</p>
<blockquote>
<p>cafeneko.info/2010/09/tsukihime-doujin_part01/</p>
</blockquote>
<p>其中</p>
<p>$http_host = ‘cafeneko.info’ , $1 = $request_uri = ‘/2010/09/tsukihime-doujin_part01/’</p>
<p>则 $http_host$1index.html = ‘cafeneko.info/2010/09/tsukihime-doujin_part01/index.html’</p>
<p>而 $http_host/$1/index.html = ‘cafeneko.info//2010/09/tsukihime-doujin_part01//index.html’</p>
<p>虽然在调试过程中两者并没有不同,不过为了保持正确的路径,还是省略了中间的/符号.</p>
<p>最后上例rewrite后的url = ‘cafeneko.info/wp-content/cache/supercache/cafeneko.info/2010/09/tsukihime-doujin_part01/index.html’</p>
<div class="wp_syntax"><br><div class="code"><br><pre class="bash" style="font-family: monospace;"><span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">(</span>-f <span style="color: #007800;">$document_root</span><span style="color: #007800;">$supercache_file</span><span style="color: #7a0874; font-weight: bold;">)</span> <span style="color: #7a0874; font-weight: bold;">{</span><br>    rewrite ^<span style="color: #7a0874; font-weight: bold;">(</span>.<span style="color: #000000; font-weight: bold;">*</span><span style="color: #7a0874; font-weight: bold;">)</span>$ <span style="color: #007800;">$supercache_file</span> <span style="color: #7a0874; font-weight: bold;">break</span>;<br><span style="color: #7a0874; font-weight: bold;">}</span></pre><br></div><br></div>

<p>//检查cache文件是否存在,存在的话则执行rewrite,留意这里因为是rewrite到html静态文件,所以可以直接用break终止掉.</p>
<div class="wp_syntax"><br><div class="code"><br><pre class="bash" style="font-family: monospace;"><span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">(</span><span style="color: #000000; font-weight: bold;">!</span>-e <span style="color: #007800;">$request_filename</span><span style="color: #7a0874; font-weight: bold;">)</span> <span style="color: #7a0874; font-weight: bold;">{</span><br>    rewrite . <span style="color: #000000; font-weight: bold;">/</span>index.php <span style="color: #c20cb9; font-weight: bold;">last</span>;<br><span style="color: #7a0874; font-weight: bold;">}</span></pre><br></div><br></div>

<p>//执行到此则说明不使用suercache,进行wordpress的permalink rewrite</p>
<p>检查请求的文件/目录是否存在,如果不存在则条件成立, rewrite到index.php</p>
<p>顺便说一句,当时这里这句rewrite看的我百思不得其解. .</p>
<p>只能匹配一个字符啊?这是什么意思?</p>
<p>一般情况下,想调试nginx rewrite最简单的方法就是把flag写成redirect,这样就能在浏览器地址栏里看到真实的rewrite地址.</p>
<p>然而对于permalink rewrite却不能用这种方法,因为一旦写成redirect以后,不管点什么链接,只要没有supercache,都是跳转回首页了.</p>
<p>后来看了一些文章才明白了rewrite的本质,其实是在保持请求地址不变的情况下,在服务器端将请求转到特定的页面.</p>
<p>乍一看supercache的性质有点像302到静态文件,所以可以用redirect调试.</p>
<p>但是permalink却是性质完全不同的rewrite,这跟wordpress的处理方式有关. 我研究不深就不多说了,简单说就是保持URL不变将请求rewrite到index.php,WP将分析其URL结构再对其并进行匹配(文章,页面,tag等),然后再构建页面. 所以其实这条rewrite</p>
<div class="wp_syntax"><br><div class="code"><br><pre class="bash" style="font-family: monospace;">rewrite . <span style="color: #000000; font-weight: bold;">/</span>index.php <span style="color: #c20cb9; font-weight: bold;">last</span>;</pre><br></div><br></div>

<p>说的是,任何请求都会被rewrite到index.php.因为”.”匹配任意字符,所以这条rewrite其实可以写成任何形式的能任意命中的正则.比如说</p>
<div class="wp_syntax"><br><div class="code"><br><pre class="bash" style="font-family: monospace;">rewrite . <span style="color: #000000; font-weight: bold;">/</span>index.php <span style="color: #c20cb9; font-weight: bold;">last</span>;<br>rewrite ^ <span style="color: #000000; font-weight: bold;">/</span>index.php <span style="color: #c20cb9; font-weight: bold;">last</span>;<br>rewrite .<span style="color: #000000; font-weight: bold;">*</span> <span style="color: #000000; font-weight: bold;">/</span>index.php <span style="color: #c20cb9; font-weight: bold;">last</span>;</pre><br></div><br></div>

<p>效果都是一样的,都能做到permalink rewrite.</p>
<p>最后要提的就是有人可能注意到我的rewrite规则是放在server块中的.网上能找到的大多数关于wordpress的nginx rewrite规则都是放在location /下面的,但是上面我却放在了server块中,为何?</p>
<p>原因是WP或某个插件会在当前页面做一个POST的XHR请求,本来没什么特别,但问题就出在其XHR请求的URL结构上.</p>
<p>正常的permalink一般为: domain.com/year/month/postname/ 或者 domain.com/tags/tagname/ 之类.</p>
<p>但这个XHR请求的URL却是 domain.com/year/month/postname/index.php 或者 domain.com/tags/tagname/index.php</p>
<p>这样一来就命中了location ~ .php$而交给fastcgi,但因为根本没有做过rewrite其页面不可能存在,结果就是这个XHR返回一个404</p>
<p>鉴于location之间匹配优先级的原因,我将主要的rewrite功能全部放进了server区块中,这样就得以保证在进行location匹配之前是一定做过rewrite的.</p>
<p>这时有朋友又要问了,为什么命中的是location ~ .php$而不是location / ?</p>
<p>…望天…长叹…这就要扯到天杀的location匹配问题了….</p>
<p>locatoin并非像rewrite那样逐条执行,而是有着匹配优先级的,当一条请求同时满足几个location的匹配时,其只会选择其一的配置执行.</p>
<p>其寻找的方法为:</p>
<blockquote>
<p>1. 首先寻找所有的常量匹配,如location /, location /av/, 以相对路径自左向右匹配,匹配长度最高的会被使用,</p>
<p>2. 然后按照配置文件中出现的顺序依次测试正则表达式,如 location ~ download\/$, location ~* .wtf, 第一个匹配会被使用</p>
<p>3. 如果没有匹配的正则,则使用之前的常量匹配</p>
</blockquote>
<p>而下面几种方法当匹配时会立即终止其他location的尝试</p>
<blockquote>
<p>1. = 完全匹配,location = /download/</p>
<p>2. ^~ 终止正则测试,如location ^~ /download/ 如果这条是最长匹配,则终止正则测试,这个符号只能匹配常量</p>
<p>3. 在没有=或者^~的情况下,如果常量完全匹配,也会立即终止测试,比如请求为 /download/ 会完全命中location /download/而不继续其他的正则测试</p>
</blockquote>
<p>总结:</p>
<blockquote>
<p>1. 如果完全匹配(不管有没有=),尝试会立即终止</p>
<p>2. 以最长匹配测试各个常量,如果常量匹配并有 ^~, 尝试会终止</p>
<p>3. 按在配置文件中出现的顺序测试各个正则表达式</p>
<p>4. 如果第3步有命中,则使用其匹配location,否则使用第2步的location</p>
</blockquote>
<p>另外还可以定义一种特殊的named location,以@开头,如location @thisissparta 不过这种location定义不用于一般的处理,而是专门用于try_file, error_page的处理,这里不再深入.</p>
<p>晕了没? 用前文的例子来看看</p>
<div class="wp_syntax"><br><div class="code"><br><pre class="bash" style="font-family: monospace;">location  = <span style="color: #000000; font-weight: bold;">/</span> <span style="color: #7a0874; font-weight: bold;">{</span><br>  ….配置A<br><span style="color: #7a0874; font-weight: bold;">}</span><br><br>location  <span style="color: #000000; font-weight: bold;">/</span> <span style="color: #7a0874; font-weight: bold;">{</span><br>  ….配置B<br><span style="color: #7a0874; font-weight: bold;">}</span><br><br>location ^~ <span style="color: #000000; font-weight: bold;">/</span>images<span style="color: #000000; font-weight: bold;">/</span> <span style="color: #7a0874; font-weight: bold;">{</span><br>  ….配置C<br><span style="color: #7a0874; font-weight: bold;">}</span><br><br>location ~<span style="color: #000000; font-weight: bold;">*</span> .<span style="color: #7a0874; font-weight: bold;">(</span>gif<span style="color: #000000; font-weight: bold;">|</span>jpg<span style="color: #000000; font-weight: bold;">|</span>jpeg<span style="color: #7a0874; font-weight: bold;">)</span>$ <span style="color: #7a0874; font-weight: bold;">{</span><br>  ….配置D<br><span style="color: #7a0874; font-weight: bold;">}</span></pre><br></div><br></div>

<p>访问 / 会使用配置A -&gt; 完全命中</p>
<p>访问 /documents/document.html 会使用配置B -&gt; 匹配常量B,不匹配正则C和D,所以用B</p>
<p>访问 /images/1.gif 会使用配置C -&gt; 匹配常量B,匹配正则C,使用首个命中的正则,所以用C</p>
<p>访问 /documents/1.jpg 会使用配置D -&gt; 匹配常量B,不匹配正则C,匹配正则D,使用首个命中的正则,所以用D</p>
<p>那么再回头看我们刚才说的问题.为什么那个URL结果奇怪的XHR请求会命中location ~ .php$而不是location / ? 我相信你应该已经知道答案了.</p>
<p>所以要解决这个问题最简单的方法就是把rewrite规则放在比location先执行的server块里面就可以了哟.</p>
<p>这次的研究笔记就到此为止了.</p>
<p>最后留一个思考题,如果不将rewrite规则放入server块,还有什么方法可以解决这个XHR 404的问题?</p>
<p>原来的location /块包含从location ~ .php$到root为止的部分.</p>
<p>答案是存在的.在用使用目前的方法前我死脑筋的在保留location /的前提下尝试了很多种方法…请不要尝试为各种permalink构建独立的location.因为wp的permalink种类很多,包括单篇文章,页面,分类,tag,作者,存档等等..欢迎在回复中讨论 /</p>
<blockquote>
<p>参考:</p>
<p><a href="http://wiki.nginx.org" target="_blank" rel="external">Nginx wiki</a></p>
</blockquote>
<p>-EOF-</p>
<p>&nbsp;</p>
<p>更新  @2010.10.23</p>
<p>之前的supercache rewrite规则适用于大部分的WP.但是并不适用于mobile press插件的移动设备支持.</p>
<p>因为其中并没有检测移动设备的user agent,从而导致移动设备也会被rewrite到cache上.这样的结果是在移动设备上也是看到的跟PC一样的完全版blog. 对于性能比较好的手机比如iphone安卓什么的大概没什么问题,但比较一般的比如nokia上用opera mini等看就会比较辛苦了,这次把supercache原本在htaccess中的移动设备检测的代码块也移植了过来.</p>
<p>在前文的配置文件中cookie检测后面加入以下代码段</p>
<div class="wp_syntax"><br><div class="code"><br><pre class="bash" style="font-family: monospace;">    <span style="color: #666666; font-style: italic;"># Bypass special user agent</span><br>    <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">(</span><span style="color: #007800;">$http<em>user_agent</em></span> ~<span style="color: #000000; font-weight: bold;"><em></em></span> <span style="color: #ff0000;">“2.0 MMP|240x320|400X240|AvantGo|BlackBerry|Blazer|Cellphone|Danger|DoCoMo|Elaine/3.0|EudoraWeb|Googlebot-Mobile|hiptop|IEMobile|KYOCERA/WX310K|LG/U990|MIDP-2.|MMEF20|MOT-V|NetFront|Newt|Nintendo Wii|Nitro|Nokia|Opera Mini|Palm|PlayStation Portable|portalmmm|Proxinet|ProxiNet|SHARP-TQ-GX10|SHG-i900|Small|SonyEricsson|Symbian OS|SymbianOS|TS21i-10|UP.Browser|UP.Link|webOS|Windows CE|WinWAP|YahooSeeker/M1A1-R2D2|iPhone|iPod|Android|BlackBerry9530|LG-TU915 Obigo|LGE VX|webOS|Nokia5800”</span><span style="color: #7a0874; font-weight: bold;">)</span> <span style="color: #7a0874; font-weight: bold;">{</span><br>        <span style="color: #000000; font-weight: bold;">set</span> <span style="color: #007800;">$supercache_uri</span> <span style="color: #ff0000;">‘’</span>;<br>    <span style="color: #7a0874; font-weight: bold;">}</span><br><br>    <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #7a0874; font-weight: bold;">(</span><span style="color: #007800;">$http_user_agent</span> ~<span style="color: #000000; font-weight: bold;"></span> <span style="color: #ff0000;">“w3c |w3c-|acs-|alav|alca|amoi|audi|avan|benq|bird|blac|blaz|brew|cell|cldc|cmd-|dang|doco|eric|hipt|htc|inno|ipaq|ipod|jigs|kddi|keji|leno|lg-c|lg-d|lg-g|lge-|lg/u|maui|maxo|midp|mits|mmef|mobi|mot-|moto|mwbp|nec-|newt|noki|palm|pana|pant|phil|play|port|prox|qwap|sage|sams|sany|sch-|sec-|send|seri|sgh-|shar|sie-|siem|smal|smar|sony|sph-|symb|t-mo|teli|tim-|tosh|tsm-|upg1|upsi|vk-v|voda|wap-|wapa|wapi|wapp|wapr|webc|winw|winw|xda\ |xda-“</span><span style="color: #7a0874; font-weight: bold;">)</span> <span style="color: #7a0874; font-weight: bold;">{</span><br>        <span style="color: #000000; font-weight: bold;">set</span> <span style="color: #007800;">$supercache_uri</span> <span style="color: #ff0000;">‘’</span>;<br>    <span style="color: #7a0874; font-weight: bold;">}</span></pre><br></div><br></div>

<p>这样就可以对移动设备绕开cache规则,而直接使用mobile press产生的移动版的效果了.</p>
<script type="text/javascript">// < ![CDATA[
// < ![CDATA[
AKPC_IDS += "431,";
// ]]&gt;</script>  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/服务器/">服务器</a><a href="/tags/nginx/">nginx</a><a href="/tags/nginx-rewrite/">nginx rewrite</a>
  </div>




<div class="article-share" id="share">

  <div data-url="http://umitime.com/2011/12/14/Nginx-Rewrite的规则/" data-title="Nginx Rewrite的规则 | 听雨~" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2011/12/14/用Jsoup对用户输入内容的HTML安全过滤/" title="用Jsoup对用户输入内容的HTML安全过滤">
  <strong>PREVIOUS:</strong><br/>
  <span>
  用Jsoup对用户输入内容的HTML安全过滤</span>
</a>
</div>


<div class="next">
<a href="/2011/12/13/ubuntu-mongodb安装及备份与恢复/"  title="ubuntu mongodb安装及备份与恢复">
 <strong>NEXT:</strong><br/> 
 <span>ubuntu mongodb安装及备份与恢复
</span>
</a>
</div>

</nav>

	
</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#/1_Nginx_rewrite基本语法"><span class="toc-number">1.</span> <span class="toc-text">/1 Nginx rewrite基本语法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#/2_Nginx_location_和_rewrite_retry"><span class="toc-number">2.</span> <span class="toc-text">/2 Nginx location 和 rewrite retry</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#/3_实战!_WordPress的Permalink+Supercache_rewrite实现"><span class="toc-number">3.</span> <span class="toc-text">/3 实战! WordPress的Permalink+Supercache rewrite实现</span></a></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">
<div id="authorInfo">
	
		<div class="author-logo"></div>		
	
	<div class="social-list" class="clearfix">
		
		
		
		
		
	</div>
</div>

  

  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			<li><a href="/tags/2012/" title="2012">2012<sup>1</sup></a></li>
		
			<li><a href="/tags/3cols-layout/" title="3cols layout">3cols layout<sup>1</sup></a></li>
		
			<li><a href="/tags/3栏布局/" title="3栏布局">3栏布局<sup>1</sup></a></li>
		
			<li><a href="/tags/Balsamiq-Mockups/" title="Balsamiq Mockups">Balsamiq Mockups<sup>1</sup></a></li>
		
			<li><a href="/tags/BigPipe/" title="BigPipe">BigPipe<sup>1</sup></a></li>
		
			<li><a href="/tags/Books/" title="Books">Books<sup>4</sup></a></li>
		
			<li><a href="/tags/CORS/" title="CORS">CORS<sup>1</sup></a></li>
		
			<li><a href="/tags/CSS3背景透明/" title="CSS3背景透明">CSS3背景透明<sup>1</sup></a></li>
		
			<li><a href="/tags/CSS背景透明/" title="CSS背景透明">CSS背景透明<sup>1</sup></a></li>
		
			<li><a href="/tags/Callbacks/" title="Callbacks">Callbacks<sup>1</sup></a></li>
		
			<li><a href="/tags/Error-configuring-AutoCommit/" title="Error configuring AutoCommit">Error configuring AutoCommit<sup>1</sup></a></li>
		
			<li><a href="/tags/Finder/" title="Finder">Finder<sup>1</sup></a></li>
		
			<li><a href="/tags/HTML5专业编程/" title="HTML5专业编程">HTML5专业编程<sup>1</sup></a></li>
		
			<li><a href="/tags/Hadoop/" title="Hadoop">Hadoop<sup>1</sup></a></li>
		
			<li><a href="/tags/Hammer-js/" title="Hammer.js">Hammer.js<sup>1</sup></a></li>
		
			<li><a href="/tags/JavaScript/" title="JavaScript">JavaScript<sup>43</sup></a></li>
		
			<li><a href="/tags/JavaScript作用域/" title="JavaScript作用域">JavaScript作用域<sup>1</sup></a></li>
		
			<li><a href="/tags/MapReduce/" title="MapReduce">MapReduce<sup>1</sup></a></li>
		
			<li><a href="/tags/NERDTree/" title="NERDTree">NERDTree<sup>1</sup></a></li>
		
			<li><a href="/tags/RequireJS/" title="RequireJS">RequireJS<sup>1</sup></a></li>
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
      <li><a href="http://gengbiao.me" target="_blank" title="gengbiao">Coney's Blog</a></li>
      <li><a href="http://hexo.io" target="_blank" title="Hexo">Hexo</a></li>
    </ul>
</div>


  <div class="rsspart">
	<a href="atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  
  <div class="tagcloudlist">
    <p class="asidetitle">标签云</p>
    <div class="tagcloudlist clearfix">
       <a href="/tags/2012/" style="font-size: 10.00px;">2012</a><a href="/tags/3cols-layout/" style="font-size: 10.00px;">3cols layout</a><a href="/tags/3栏布局/" style="font-size: 10.00px;">3栏布局</a><a href="/tags/Balsamiq-Mockups/" style="font-size: 10.00px;">Balsamiq Mockups</a><a href="/tags/BigPipe/" style="font-size: 10.00px;">BigPipe</a><a href="/tags/Books/" style="font-size: 13.33px;">Books</a><a href="/tags/CORS/" style="font-size: 10.00px;">CORS</a><a href="/tags/CSS3背景透明/" style="font-size: 10.00px;">CSS3背景透明</a><a href="/tags/CSS背景透明/" style="font-size: 10.00px;">CSS背景透明</a><a href="/tags/Callbacks/" style="font-size: 10.00px;">Callbacks</a><a href="/tags/Error-configuring-AutoCommit/" style="font-size: 10.00px;">Error configuring AutoCommit</a><a href="/tags/Finder/" style="font-size: 10.00px;">Finder</a><a href="/tags/HTML5专业编程/" style="font-size: 10.00px;">HTML5专业编程</a><a href="/tags/Hadoop/" style="font-size: 10.00px;">Hadoop</a><a href="/tags/Hammer-js/" style="font-size: 10.00px;">Hammer.js</a><a href="/tags/JavaScript/" style="font-size: 20.00px;">JavaScript</a><a href="/tags/JavaScript作用域/" style="font-size: 10.00px;">JavaScript作用域</a><a href="/tags/MapReduce/" style="font-size: 10.00px;">MapReduce</a><a href="/tags/NERDTree/" style="font-size: 10.00px;">NERDTree</a><a href="/tags/RequireJS/" style="font-size: 10.00px;">RequireJS</a><a href="/tags/TransactionException/" style="font-size: 10.00px;">TransactionException</a><a href="/tags/Varnish/" style="font-size: 10.00px;">Varnish</a><a href="/tags/Weinre/" style="font-size: 10.00px;">Weinre</a><a href="/tags/WordPress/" style="font-size: 16.67px;">WordPress</a><a href="/tags/WordPress，代码高亮，定制样式，自定义css，自定义js/" style="font-size: 10.00px;">WordPress，代码高亮，定制样式，自定义css，自定义js</a><a href="/tags/XMLHttpRequest/" style="font-size: 10.00px;">XMLHttpRequest</a><a href="/tags/ajax/" style="font-size: 10.00px;">ajax</a><a href="/tags/ajax登录/" style="font-size: 10.00px;">ajax登录</a><a href="/tags/angular-js/" style="font-size: 10.00px;">angular.js</a><a href="/tags/animate/" style="font-size: 10.00px;">animate</a><a href="/tags/api/" style="font-size: 10.00px;">api</a><a href="/tags/attribute/" style="font-size: 10.00px;">attribute</a><a href="/tags/backbone/" style="font-size: 10.00px;">backbone</a><a href="/tags/bad-gateway/" style="font-size: 10.00px;">bad gateway</a><a href="/tags/base64/" style="font-size: 10.00px;">base64</a><a href="/tags/bug/" style="font-size: 10.00px;">bug</a><a href="/tags/canvas/" style="font-size: 10.00px;">canvas</a><a href="/tags/canvas-图片/" style="font-size: 10.00px;">canvas 图片</a><a href="/tags/cdn/" style="font-size: 10.00px;">cdn</a><a href="/tags/checked-exception/" style="font-size: 10.00px;">checked exception</a>
    </div>
  </div>


</aside>
</div>
    </div>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>






<script>
     window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["qzone","tsina","weixin","renren","tqq","tieba","douban","sqq","diandian","huaban","youdao","mail","ty","fbook","twi","linkedin","copy","print"],"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"4","bdPos":"right","bdTop":"350"},"image":{"viewList":["weixin","qzone","tsina","renren","douban","tqq"],"viewText":"分享：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["weixin","qzone","tsina","renren","douban","tqq"]}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script>


<script type="text/javascript">
    var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
    var _bdId = '391982416296a0d54221f59fe35250d4';
    document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F" + _bdId +"'  type='text/javascript'%3E%3C/script%3E"));
</script>



<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'null', 'null');  
ga('send', 'pageview');
</script>


  </body>
</html>
