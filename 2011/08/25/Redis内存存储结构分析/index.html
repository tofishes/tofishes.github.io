
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>Redis内存存储结构分析 | 听雨~</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="ToFishes">
    
    <meta name="description" content="来源于：http://www.searchtb.com/2011/05/redis-storage.html
1 Redis 内存存储结构
本文是基于 Redis-v2.2.4 版本进行分析.
1.1 Redis 内存存储总体结构
Redis 是支持多key-value数据库(表)的,并用 Redi">
    
    
    
    
    <link rel="alternate" href="atom.xml" title="听雨~" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">

     
</head>

  <body>
    <header>
      <div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="听雨~">听雨~</a></h1>
				<a class="blog-motto">昨夜卧听风吹雨，不若相忘于江湖。</a>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
					<li>
					
                                            <form class="search" action=http://search.baidu.com/cse/search target="_blank">
                                            <label>Search</label>
                                        <input name="s" type="hidden" value= null ><input type="text" name="q" size="30" placeholder="搜索"><br>
					
					</li>
				</ul>
                            </nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2011/08/25/Redis内存存储结构分析/" title="Redis内存存储结构分析" itemprop="url">Redis内存存储结构分析</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://umitime.com" title="[object Object]">[object Object]</a>
    </p>
  <p class="article-time">
    <time datetime="2011-08-25T07:07:21.000Z" itemprop="datePublished">8月 25 2011</time>
    更新日期:<time datetime="2014-10-15T04:37:55.000Z" itemprop="dateModified">10月 15 2014</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1_Redis_内存存储结构"><span class="toc-number">1.</span> <span class="toc-text">1 Redis 内存存储结构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1_Redis_内存存储总体结构"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 Redis 内存存储总体结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2_Dict_结构"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 Dict 结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3_zipmap_结构"><span class="toc-number">1.3.</span> <span class="toc-text">1.3 zipmap 结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4_ziplist_结构"><span class="toc-number">1.4.</span> <span class="toc-text">1.4 ziplist 结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-5_adlist_结构"><span class="toc-number">1.5.</span> <span class="toc-text">1.5 adlist 结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-6_intset_结构"><span class="toc-number">1.6.</span> <span class="toc-text">1.6 intset 结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-7_zset_结构"><span class="toc-number">1.7.</span> <span class="toc-text">1.7 zset 结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-7-1_Skip_List_介绍"><span class="toc-number">1.7.1.</span> <span class="toc-text">1.7.1 Skip List 介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-7-1-1_有序链表"><span class="toc-number">1.7.1.1.</span> <span class="toc-text">1.7.1.1 有序链表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-7-1-2_SkipList(跳跃表)定义"><span class="toc-number">1.7.1.2.</span> <span class="toc-text">1.7.1.2 SkipList(跳跃表)定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-7-1-3_SkipList(跳跃表)操作"><span class="toc-number">1.7.1.3.</span> <span class="toc-text">1.7.1.3 SkipList(跳跃表)操作</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-7-2_redis_SkipList_实现"><span class="toc-number">1.7.2.</span> <span class="toc-text">1.7.2 redis SkipList 实现</span></a></li></ol></li></ol></li></ol>
		</div>
		
		<p><span style="color: #008000;">来源于：<a href="http://www.searchtb.com/2011/05/redis-storage.html" target="_blank" rel="external">http://www.searchtb.com/2011/05/redis-storage.html</a></span></p>
<h1 id="1_Redis_内存存储结构">1 Redis 内存存储结构</h1>
<p>本文是基于 Redis-v2.2.4 版本进行分析.</p>
<h2 id="1-1_Redis_内存存储总体结构">1.1 Redis 内存存储总体结构</h2>
<p>Redis 是支持多key-value数据库(表)的,并用 RedisDb 来表示一个key-value数据库(表). redisServer 中有一个 redisDb *db; 成员变量, RedisServer 在初始化时,会根据配置文件的 db 数量来创建一个 redisDb 数组. 客户端在连接后,通过 SELECT 指令来选择一个 reidsDb,如果不指定,则缺省是redisDb数组的第1个(即下标是 0 ) redisDb. 一个客户端在选择 redisDb 后,其后续操作都是在此 redisDb 上进行的. 下面会详细介绍一下 redisDb 的内存结构.</p>
<p><a href="http://www.searchtb.com/wp-content/uploads/2011/04/Image011710.jpg" target="_blank" rel="external"><img src="http://www.searchtb.com/wp-content/uploads/2011/04/Image011710.jpg" alt=""></a></p>
<p><span id="more-362"></span></p>
<p>redisDb 的定义:</p>
<pre class="brush: cpp; title: ;">typedef struct redisDb

{

dict *dict;                 /* The keyspace for this DB */

dict *expires;              /* Timeout of keys with a timeout set */

dict *blocking_keys;    /* Keys with clients waiting for data (BLPOP) */

dict *io_keys;              /* Keys with clients waiting for VM I/O */

dict *watched_keys;         /* WATCHED keys for MULTI/EXEC CAS */

int id;

} redisDb;

struct</pre>

<p>redisDb 中 ,dict 成员是与实际存储数据相关的. dict 的定义如下:</p>
<pre class="brush: cpp; title: ;">typedef struct dictEntry

{

void *key;

void *val;

struct dictEntry *next;

} dictEntry;

typedef struct dictType

{

unsigned int (*hashFunction)(const void *key);

void *(*keyDup)(void *privdata, const void *key);

void *(*valDup)(void *privdata, const void *obj);

int (*keyCompare)(void *privdata, const void *key1, const void *key2);

void (*keyDestructor)(void *privdata, void *key);

void (*valDestructor)(void *privdata, void *obj);

} dictType;

/* This is our hash table structure. Every dictionary has two of this as we

* implement incremental rehashing, for the old to the new table. */

typedef struct dictht

{

dictEntry **table;

unsigned long size;

unsigned long sizemask;

unsigned long used;

} dictht;

typedef struct dict

{

dictType *type;

void *privdata;

dictht ht[2];

int rehashidx; /* rehashing not in progress if rehashidx == -1 */

int iterators; /* number of iterators currently running */

} dict;</pre>

<p>dict 是主要是由 struct dictht 的 哈唏表构成的, 之所以定义成长度为2的( dictht ht[2] ) 哈唏表数组,是因为 redis 采用渐进的 rehash,即当需要 rehash 时,每次像 hset,hget 等操作前,先执行N 步 rehash. 这样就把原来一次性的 rehash过程拆散到进行, 防止一次性 rehash 期间 redis 服务能力大幅下降. 这种渐进的 rehash 需要一个额外的 struct dictht 结构来保存.</p>
<p>struct dictht 主要是由一个 struct dictEntry 指针数组组成的, hash 表的冲突是通过链表法来解决的.</p>
<p>struct dictEntry 中的 key 指针指向用 sds 类型表示的 key 字符串, val 指针指向一个 struct redisObject 结构体, 其定义如下:</p>
<pre class="brush: cpp; title: ;">typedef struct redisObject

{

unsigned type:4;

unsigned storage:2;   /* REDIS_VM_MEMORY or REDIS_VM_SWAPPING */

unsigned encoding:4;

unsigned lru:22;        /* lru time (relative to server.lruclock) */

int refcount;

void *ptr;

/* VM fields are only allocated if VM is active, otherwise the

* object allocation function will just allocate

* sizeof(redisObjct) minus sizeof(redisObjectVM), so using

* Redis without VM active will not have any overhead. */

} robj;

//type 占 4 bit,用来表示 key-value 中 value 值的类型,目前 redis 支持: string, list, set,zset,hash 5种类型的值.

/* Object types */

#define REDIS_STRING 0

#define REDIS_LIST 1

#define REDIS_SET 2

#define REDIS_ZSET 3

#define REDIS_HASH 4

#define REDIS_VMPOINTER 8
// storage 占 2 bit ,表示 此值是在 内存中,还是 swap 在硬盘上.
// encoding 占 4 bit ,表示值的编码类型,目前有 8种类型:

/* Objects encoding. Some kind of objects like Strings and Hashes can be

* internally represented in multiple ways. The 'encoding' field of the object

* is set to one of this fields for this object. */

#define REDIS_ENCODING_RAW 0     /* Raw representation */

#define REDIS_ENCODING_INT 1     /* Encoded as integer */

#define REDIS_ENCODING_HT 2      /* Encoded as hash table */

#define REDIS_ENCODING_ZIPMAP 3  /* Encoded as zipmap */

#define REDIS_ENCODING_LINKEDLIST 4 /* Encoded as regular linked list */

#define REDIS_ENCODING_ZIPLIST 5 /* Encoded as ziplist */

#define REDIS_ENCODING_INTSET 6  /* Encoded as intset */

#define REDIS_ENCODING_SKIPLIST 7  /* Encoded as skiplist */

/* 如 type 是 REDIS_STRING 类型的,则其值如果是数字,就可以编码成 REDIS_ENCODING_INT,以节约内存.

* 如 type 是 REDIS_HASH 类型的,如果其 entry 小于配置值: hash-max-zipmap-entries 或 value字符串的长度小于 hash-max-zipmap-value, 则可以编码成 REDIS_ENCODING_ZIPMAP 类型存储,以节约内存. 否则采用 Dict 来存储.

* 如 type 是 REDIS_LIST 类型的,如果其 entry 小于配置值: list-max-ziplist-entries 或 value字符串的长度小于 list-max-ziplist-value, 则可以编码成 REDIS_ENCODING_ZIPLIST 类型存储,以节约内存; 否则采用 REDIS_ENCODING_LINKEDLIST 来存储.

*  如 type 是 REDIS_SET 类型的,如果其值可以表示成数字类型且 entry 小于配置值set-max-intset-entries, 则可以编码成 REDIS_ENCODING_INTSET 类型存储,以节约内存; 否则采用 Dict类型来存储.

*  lru: 是时间戳

*  refcount: 引用次数

*  void * ptr : 指向实际存储的 value 值内存块,其类型可以是 string, set, zset,list,hash ,编码方式可以是上述 encoding 表示的一种.

* 至于一个 key 的 value 采用哪种类型来保存,完全是由客户端的指令来决定的,如 hset ,则值是采用REDIS_HASH 类型表示的,至于那种编码(encoding),则由 redis 根据配置自动决定.
*/</pre>

<h2 id="1-2_Dict_结构">1.2 Dict 结构</h2>
<p><a href="http://www.searchtb.com/wp-content/uploads/2011/04/Image011720.jpg" target="_blank" rel="external"><img src="http://www.searchtb.com/wp-content/uploads/2011/04/Image011720.jpg" alt=""></a></p>
<p>Dict 结构在&lt;1.1Redis 内存存储结构&gt;; 已经描述过了,这里不再赘述.</p>
<h2 id="1-3_zipmap_结构">1.3 zipmap 结构</h2>
<p>如果redisObject的type 成员值是 REDIS_HASH 类型的,则当该hash 的 entry 小于配置值: hash-max-zipmap-entries 或者value字符串的长度小于 hash-max-zipmap-value, 则可以编码成 REDIS_ENCODING_ZIPMAP 类型存储,以节约内存. 否则采用 Dict 来存储.</p>
<p>zipmap 其实质是用一个字符串数组来依次保存key和value,查询时是依次遍列每个 key-value 对,直到查到为止. 其结构示意图如下:</p>
<p><a href="http://www.searchtb.com/wp-content/uploads/2011/04/Image011730.jpg" target="_blank" rel="external"><img src="http://www.searchtb.com/wp-content/uploads/2011/04/Image011730.jpg" alt=""></a></p>
<p>为了节约内存,这里使用了一些小技巧来保存 key 和 value 的长度. 如果 key 或 value 的长度小于ZIPMAP_BIGLEN(254),则用一个字节来表示,如果大于ZIPMAP_BIGLEN(254),则用5个字节保存,第一个字节为保存ZIPMAP_BIGLEN(254),后面4个字节保存 key或value 的长度.</p>
<ol>
<li>初始化时只有2个字节,第1个字节表示 zipmap 保存的 key-value 对的个数(如果key-value 对的个数超过 254,则一直用254来表示, zipmap 中实际保存的 key-value 对个数可以通过 zipmapLen() 函数计算得到).</li>
<li><p>hset(nick,wuzhu) 后,</p>*   第1个字节保存key-value 对(即 zipmap 的entry 数量)的数量1<p></p>
<ul>
<li>第2个字节保存key_len 值 4</li>
<li>第3~6 保存 key “nick”</li>
<li>第 7 字节保存 value_len 值 5</li>
<li>第 8 字节保存空闭的字节数 0 (当 该 key 的值被重置时,其新值的长度与旧值的长度不一定相等,如果新值长度比旧值的长度大,则 realloc 扩大内存; 如果新值长度比旧值的长度小,且相差大于 4 bytes ,则 realloc 缩小内存,如果相差小于 4,则将值往前移,并用 empty_len 保存空闲的byte 数)</li>
<li>第 9~13字节保存 value 值 “wuzhu”</li>
</ul>
</li>
<li><p>hset(age,30)插入 key-value 对 (“age”,30)</p>
</li>
<li>hset(nick,tide)插入 key-value 对 (“nick”,”tide”), 后可以看到 empty_len 为1 ,</li>
</ol>
<h2 id="1-4_ziplist_结构">1.4 ziplist 结构</h2>
<p>如果redisObject的type 成员值是 REDIS_LIST 类型的,则当该list 的 elem数小于配置值: hash-max-ziplist-entries 或者elem_value字符串的长度小于 hash-max-ziplist-value, 则可以编码成 REDIS_ENCODING_ZIPLIST 类型存储,以节约内存. 否则采用 Dict 来存储.</p>
<p>ziplist 其实质是用一个字符串数组形式的双向链表. 其结构示意图如下:</p>
<p><a href="http://www.searchtb.com/wp-content/uploads/2011/04/Image011740.jpg" target="_blank" rel="external"><img src="http://www.searchtb.com/wp-content/uploads/2011/04/Image011740.jpg" alt=""></a></p>
<ol>
<li><p>ziplist header由3个字段组成:</p>
<ul>
<li>ziplist_bytes: 用一个uint32_t 来保存, 构成 ziplist 的字符串数组的总长度,包括 ziplist header,</li>
<li>ziplist_tail_offset: 用一个uint32_t 来保存,记录 ziplist 的尾部偏移位置.</li>
<li>ziplist_length: 用一个 uint16_t 来保存,记录 ziplist 中 elem 的个数</li>
</ul>
</li>
<li><p>ziplist node 也由 3 部分组成:</p>
<ul>
<li>prevrawlen: 保存上一个 ziplist node 的占用的字节数,包括: 保存prevarwlen,currawlen 的字节数和elem value 的字节数.</li>
<li>currawlen&amp;encoding: 当前elem value 的raw 形式存款所需的字节数及在ziplist 中保存时的编码方式(例如,值可以转换成整数,如示意图中的”1024”, raw_len 是 4 字节,但在 ziplist 保存时转换成 uint16_t 来保存,占2 个字节).</li>
<li>(编码后的)value</li>
</ul>
</li>
</ol>
<p>可以通过 prevrawlen 和 currawlen&amp;encoding 来遍列 ziplist.</p>
<p>ziplist 还能到一些小技巧来节约内存.</p>
<ul>
<li>len 的存储: 如果 len 小于 ZIP_BIGLEN(254),则用一个字节来保存; 否则需要 5 个字节来保存,第 1 个字节存 ZIP_BIGLEN,作为标识符.</li>
<li>value 的存储: 如果 value 是数字类型的,则根据其值的范围转换成 ZIP_INT_16B, ZIP_INT_32B或ZIP_INT_64B 来保存,否则用 raw 形式保存.</li>
</ul>
<h2 id="1-5_adlist_结构">1.5 adlist 结构</h2>
<pre class="brush: cpp; title: ;">typedef struct listNode
{

struct listNode *prev;

struct listNode *next;

void *value;

} listNode;

typedef struct listIter

{

listNode *next;

int direction;

} listIter;

typedef struct list

{

listNode *head;

listNode *tail;

void *(*dup)(void *ptr);

void (*free)(void *ptr);

int (*match)(void *ptr, void *key);

unsigned int len;

} list;</pre>

<p>常见的双向链表,不作分析.</p>
<h2 id="1-6_intset_结构">1.6 intset 结构</h2>
<p><a href="http://www.searchtb.com/wp-content/uploads/2011/04/Image011750.jpg" target="_blank" rel="external"><img src="http://www.searchtb.com/wp-content/uploads/2011/04/Image011750.jpg" alt=""></a></p>
<p>intset 是用一个有序的整数数组来实现集合(set). struct intset 的定义如下:</p>
<pre class="brush: cpp; title: ;">typedef struct intset

{

uint32_t encoding;

uint32_t length;

int8_t contents[];

} intset;</pre>

<ul>
<li>encoding: 来标识数组是 int16_t 类型, int32_t 类型还是 int64_t 类型的数组. 至于怎么先择是那种类型的数组,是根据其保存的值的取值范围来决定的,初始化时是 int16_t, 根据 set 中的最大值在 [INT16_MIN, INT16_MAX] , [INT32_MIN, INT32_MAX], [INT64_MIN, INT64_MAX]的那个取值范围来动态确定整个数组的类型. 例如set一开始是 int16_t 类型,当一个取值范围在 [INT32_MIN, INT32_MAX]的值加入到 set 时,则将保存 set 的数组升级成 int32_t 的数组.</li>
<li>length: 表示 set 中值的个数</li>
<li>contents: 指向整数数组的指针</li>
</ul>
<h2 id="1-7_zset_结构">1.7 zset 结构</h2>
<p>首先，介绍一下 skip list 的概念，然后再分析 zset 的实现.</p>
<h3 id="1-7-1_Skip_List_介绍">1.7.1 Skip List 介绍</h3>
<h4 id="1-7-1-1_有序链表">1.7.1.1 有序链表</h4>
<p>1) Searching a key in a Sorted linked list</p>
<p><a href="http://www.searchtb.com/wp-content/uploads/2011/04/Image011760.jpg" target="_blank" rel="external"><img src="http://www.searchtb.com/wp-content/uploads/2011/04/Image011760.jpg" alt=""></a></p>
<pre class="brush: cpp; title: ;">//Searching an element &lt;em&gt;x&lt;/em&gt;

cell *p =head ;

while (p-&gt;next-&gt;key &lt; x )  p=p-&gt;next ;

return p ;</pre>

<p>Note: we return the element proceeding either the element containing <em>x</em>, or the smallest element with a key larger than <em>x</em> (if <em>x</em> does not exists)</p>
<p>2) inserting a key into a Sorted linked list</p>
<p><a href="http://www.searchtb.com/wp-content/uploads/2011/04/Image011770.jpg" target="_blank" rel="external"><img src="http://www.searchtb.com/wp-content/uploads/2011/04/Image011770.jpg" alt=""></a></p>
<pre class="brush: cpp; title: ;">//To insert 35 -

p=find(35);

CELL *p1 = (CELL *) malloc(sizeof(CELL));

p1-&gt;key=35;

p1-&gt;next = p-&gt;next ;

p-&gt;next  = p1 ;</pre>

<p>3) deleteing a key from a sorted list</p>
<p><a href="http://www.searchtb.com/wp-content/uploads/2011/04/Image011780.jpg" target="_blank" rel="external"><img src="http://www.searchtb.com/wp-content/uploads/2011/04/Image011780.jpg" alt=""></a></p>
<pre class="brush: cpp; title: ;">//To delete 37 -

p=find(37);

CELL *p1 =p-&gt;next;

p-&gt;next = p1-&gt;next ;

free(p1);</pre>

<h4 id="1-7-1-2_SkipList(跳跃表)定义">1.7.1.2 SkipList(跳跃表)定义</h4>
<p>SKIP LIST : A data structure for maintaing a set of keys in a sorted order.</p>
<p>Consists of several <strong>levels. </strong></p>
<p>All keys appear in level 1</p>
<p>Each level is a sorted list.</p>
<p>If key <em>x</em> appears in level <em>i</em>, then it also appears in all levels below <em>i </em></p>
<p><a href="http://www.searchtb.com/wp-content/uploads/2011/04/Image011790.jpg" target="_blank" rel="external"><img src="http://www.searchtb.com/wp-content/uploads/2011/04/Image011790.jpg" alt=""></a></p>
<p>An element in level<em> i _points (via down pointer) to the element with the same key in the level below.</em> _</p>
<p>In each level the keys and appear. (In our implementation, INT_MIN and INT_MAX</p>
<p>Top points to the smallest element in the highest level.</p>
<p><a href="http://www.searchtb.com/wp-content/uploads/2011/04/Image011800.jpg" target="_blank" rel="external"><img src="http://www.searchtb.com/wp-content/uploads/2011/04/Image011800.jpg" alt=""></a></p>
<h4 id="1-7-1-3_SkipList(跳跃表)操作">1.7.1.3 SkipList(跳跃表)操作</h4>
<p>1) An empty SkipList</p>
<p><a href="http://www.searchtb.com/wp-content/uploads/2011/04/Image011810.jpg" target="_blank" rel="external"><img src="http://www.searchtb.com/wp-content/uploads/2011/04/Image011810.jpg" alt=""></a></p>
<p>2) Finding an element with key <em>x</em></p>
<p><a href="http://www.searchtb.com/wp-content/uploads/2011/04/Image011820.jpg" target="_blank" rel="external"><img src="http://www.searchtb.com/wp-content/uploads/2011/04/Image011820.jpg" alt=""></a></p>
<pre class="brush: cpp; title: ;">p=top

While(1)

{

while (p-&gt;next-&gt;key &lt; x ) p=p-&gt;next;

If (p-&gt;down == NULL ) return p-&gt;next

p=p-&gt;down ;

}</pre>

<p><em> _Observe that we return _x</em>, if exists, or <em>succ(x)</em> if <em>x</em> is not in the SkipList</p>
<p>3) Inserting new element <em>X</em></p>
<p>&nbsp;</p>
<p>Determine <strong><em>k</em></strong> the number of levels in which <em>x</em> participates (explained later)</p>
<p>Do find(x), and insert x to the appropriate places in the lowest <strong><em>k</em></strong> levels. (after the elements at which the search path turns down or terminates)</p>
<p>Example – inserting 119. <strong><em>k</em></strong>=2<em> </em></p>
<p>If <strong><em>k </em></strong>is larger than the current number of levels, add new levels (and update top)</p>
<p>Example – inser(119) when k=4</p>
<p><a href="http://www.searchtb.com/wp-content/uploads/2011/04/Image011840.jpg" target="_blank" rel="external"><img src="http://www.searchtb.com/wp-content/uploads/2011/04/Image011840.jpg" alt=""></a></p>
<p>Determining <em>k</em></p>
<p>k – the number of levels at which an element x participate.</p>
<p>Use a random function OurRnd() — returns 1 or 0 (True/False) with equal probability.</p>
<p>k=1 ;</p>
<p>While( OurRnd() ) k++ ;</p>
<p>Deleteing a key <em>x</em></p>
<p>Find x in all the levels it participates, and delete it using the standard ‘delete from a linked list’ method.</p>
<p>If one or more of the upper levels are empty, remove them (and update top)</p>
<p><em> <a href="http://www.searchtb.com/wp-content/uploads/2011/04/Image011850.jpg" target="_blank" rel="external"><img src="http://www.searchtb.com/wp-content/uploads/2011/04/Image011850.jpg" alt=""></a></em></p>
<p>Facts about SkipList</p>
<p>The expected number of levels is O( log <em>n</em> )</p>
<p>(here <em>n</em> is the numer of elements)</p>
<p>The expected time for insert/delete/find is O( log <em>n</em> )</p>
<p>The expected size (number of cells) is O(<em>n </em>)</p>
<h3 id="1-7-2_redis_SkipList_实现">1.7.2 redis SkipList 实现</h3>
<p>/<em> ZSETs use a specialized version of Skiplists </em>/</p>
<pre class="brush: cpp; title: ;">typedef struct zskiplistNode

{

robj *obj;

double score;

struct zskiplistNode *backward;

struct zskiplistLevel

{

struct zskiplistNode *forward;

unsigned int span;

} level[];

} zskiplistNode;

typedef struct zskiplist

{

struct zskiplistNode *header, *tail;

unsigned long length;

int level;

} zskiplist;

typedef struct zset

{

dict *dict;

zskiplist *zsl;

} zset;</pre>

<p>zset 的实现用到了2个数据结构: hash_table 和 skip list (跳跃表),其中 hash table 是使用 redis 的 dict 来实现的,主要是为了保证查询效率为 O(1),而 skip list (跳跃表) 是用来保证元素有序并能够保证 INSERT 和 REMOVE 操作是 O(logn)的复杂度。</p>
<p>1) zset初始化状态</p>
<p>createZsetObject函数来创建并初始化一个 zset</p>
<pre class="brush: cpp; title: ;">robj *createZsetObject(void)

{

zset *zs = zmalloc(sizeof(*zs));

robj *o;

zs-&gt;dict = dictCreate(&amp;zsetDictType,NULL);

zs-&gt;zsl = zslCreate();

o = createObject(REDIS_ZSET,zs);

o-&gt;encoding = REDIS_ENCODING_SKIPLIST;

return o;

}</pre>

<p>zslCreate()函数用来创建并初如化一个 skiplist。 其中，skiplist 的 level 最大值为 ZSKIPLIST_MAXLEVEL=32 层。</p>
<pre class="brush: cpp; title: ;">zskiplist *zslCreate(void)

{

int j;

zskiplist *zsl;

zsl = zmalloc(sizeof(*zsl));

zsl-&gt;level = 1;

zsl-&gt;length = 0;

zsl-&gt;header = zslCreateNode(ZSKIPLIST_MAXLEVEL,0,NULL);

for (j = 0; j &lt; ZSKIPLIST_MAXLEVEL; j++) {

zsl-&gt;header-&gt;level[j].forward = NULL;

zsl-&gt;header-&gt;level[j].span = 0;

}

zsl-&gt;header-&gt;backward = NULL;

zsl-&gt;tail = NULL;

return zsl;

}</pre>

<p><a href="http://www.searchtb.com/wp-content/uploads/2011/04/Image011860.jpg" target="_blank" rel="external"><img src="http://www.searchtb.com/wp-content/uploads/2011/04/Image011860.jpg" alt=""></a></p>
<p>2) ZADD myzset 1 “one”</p>
<p>ZADD 命令格式：</p>
<p>ZADD key score member</p>
<ol>
<li>根据 key 从 redisDb 进行查询，返回 zset 对象。</li>
<li>以 member 作为 key,score 作为 value ，向 zset的 dict 进行中插入;</li>
<li>如果返回成功，表明 member 没有在 dict 中出现过，直接向 skiplist 进行插入。</li>
<li>如果步骤返回失败，表明以 member 已经在 dict中出现过，则需要先从 skiplist 中删除，然后以现在的 score 值重新插入。</li>
</ol>
<p><a href="http://www.searchtb.com/wp-content/uploads/2011/04/Image011870.jpg" target="_blank" rel="external"><img src="http://www.searchtb.com/wp-content/uploads/2011/04/Image011870.jpg" alt=""></a></p>
<p>3) ZADD myzset 3 “three”</p>
<p><a href="http://www.searchtb.com/wp-content/uploads/2011/04/Image011880.jpg" target="_blank" rel="external"><img src="http://www.searchtb.com/wp-content/uploads/2011/04/Image011880.jpg" alt=""></a></p>
<p>4) ZADD myzset 2 “two”</p>
<p><a href="http://www.searchtb.com/wp-content/uploads/2011/04/Image011890.jpg" target="_blank" rel="external"><img src="http://www.searchtb.com/wp-content/uploads/2011/04/Image011890.jpg" alt=""></a></p>
  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/拓展/">拓展</a>
  </div>




<div class="article-share" id="share">

  <div data-url="http://umitime.com/2011/08/25/Redis内存存储结构分析/" data-title="Redis内存存储结构分析 | 听雨~" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2011/08/25/Redis内存使用优化与存储/" title="Redis内存使用优化与存储">
  <strong>PREVIOUS:</strong><br/>
  <span>
  Redis内存使用优化与存储</span>
</a>
</div>


<div class="next">
<a href="/2011/08/25/为什么使用-Redis及其产品定位/"  title="为什么使用 Redis及其产品定位">
 <strong>NEXT:</strong><br/> 
 <span>为什么使用 Redis及其产品定位
</span>
</a>
</div>

</nav>

	
</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1_Redis_内存存储结构"><span class="toc-number">1.</span> <span class="toc-text">1 Redis 内存存储结构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1_Redis_内存存储总体结构"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 Redis 内存存储总体结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2_Dict_结构"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 Dict 结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3_zipmap_结构"><span class="toc-number">1.3.</span> <span class="toc-text">1.3 zipmap 结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4_ziplist_结构"><span class="toc-number">1.4.</span> <span class="toc-text">1.4 ziplist 结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-5_adlist_结构"><span class="toc-number">1.5.</span> <span class="toc-text">1.5 adlist 结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-6_intset_结构"><span class="toc-number">1.6.</span> <span class="toc-text">1.6 intset 结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-7_zset_结构"><span class="toc-number">1.7.</span> <span class="toc-text">1.7 zset 结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-7-1_Skip_List_介绍"><span class="toc-number">1.7.1.</span> <span class="toc-text">1.7.1 Skip List 介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-7-1-1_有序链表"><span class="toc-number">1.7.1.1.</span> <span class="toc-text">1.7.1.1 有序链表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-7-1-2_SkipList(跳跃表)定义"><span class="toc-number">1.7.1.2.</span> <span class="toc-text">1.7.1.2 SkipList(跳跃表)定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-7-1-3_SkipList(跳跃表)操作"><span class="toc-number">1.7.1.3.</span> <span class="toc-text">1.7.1.3 SkipList(跳跃表)操作</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-7-2_redis_SkipList_实现"><span class="toc-number">1.7.2.</span> <span class="toc-text">1.7.2 redis SkipList 实现</span></a></li></ol></li></ol></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">
<div id="authorInfo">
	
		<div class="author-logo"></div>		
	
	<div class="social-list" class="clearfix">
		
		
		
		<a href="https://github.com/tofishes" target="_blank" title="github"></a>
		
		
		
	</div>
</div>

  

  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			<li><a href="/tags/2012/" title="2012">2012<sup>1</sup></a></li>
		
			<li><a href="/tags/3cols-layout/" title="3cols layout">3cols layout<sup>1</sup></a></li>
		
			<li><a href="/tags/3栏布局/" title="3栏布局">3栏布局<sup>1</sup></a></li>
		
			<li><a href="/tags/Balsamiq-Mockups/" title="Balsamiq Mockups">Balsamiq Mockups<sup>1</sup></a></li>
		
			<li><a href="/tags/BigPipe/" title="BigPipe">BigPipe<sup>1</sup></a></li>
		
			<li><a href="/tags/Books/" title="Books">Books<sup>4</sup></a></li>
		
			<li><a href="/tags/CORS/" title="CORS">CORS<sup>1</sup></a></li>
		
			<li><a href="/tags/CSS3背景透明/" title="CSS3背景透明">CSS3背景透明<sup>1</sup></a></li>
		
			<li><a href="/tags/CSS背景透明/" title="CSS背景透明">CSS背景透明<sup>1</sup></a></li>
		
			<li><a href="/tags/Callbacks/" title="Callbacks">Callbacks<sup>1</sup></a></li>
		
			<li><a href="/tags/Error-configuring-AutoCommit/" title="Error configuring AutoCommit">Error configuring AutoCommit<sup>1</sup></a></li>
		
			<li><a href="/tags/Finder/" title="Finder">Finder<sup>1</sup></a></li>
		
			<li><a href="/tags/HTML5专业编程/" title="HTML5专业编程">HTML5专业编程<sup>1</sup></a></li>
		
			<li><a href="/tags/Hadoop/" title="Hadoop">Hadoop<sup>1</sup></a></li>
		
			<li><a href="/tags/Hammer-js/" title="Hammer.js">Hammer.js<sup>1</sup></a></li>
		
			<li><a href="/tags/JavaScript/" title="JavaScript">JavaScript<sup>43</sup></a></li>
		
			<li><a href="/tags/JavaScript作用域/" title="JavaScript作用域">JavaScript作用域<sup>1</sup></a></li>
		
			<li><a href="/tags/MapReduce/" title="MapReduce">MapReduce<sup>1</sup></a></li>
		
			<li><a href="/tags/NERDTree/" title="NERDTree">NERDTree<sup>1</sup></a></li>
		
			<li><a href="/tags/RequireJS/" title="RequireJS">RequireJS<sup>1</sup></a></li>
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
      <li><a href="http://gengbiao.me" target="_blank" title="gengbiao">Coney's Blog</a></li>
      <li><a href="http://hexo.io" target="_blank" title="Hexo">Hexo</a></li>
    </ul>
</div>


  <div class="rsspart">
	<a href="atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  
  <div class="tagcloudlist">
    <p class="asidetitle">标签云</p>
    <div class="tagcloudlist clearfix">
       <a href="/tags/2012/" style="font-size: 10.00px;">2012</a><a href="/tags/3cols-layout/" style="font-size: 10.00px;">3cols layout</a><a href="/tags/3栏布局/" style="font-size: 10.00px;">3栏布局</a><a href="/tags/Balsamiq-Mockups/" style="font-size: 10.00px;">Balsamiq Mockups</a><a href="/tags/BigPipe/" style="font-size: 10.00px;">BigPipe</a><a href="/tags/Books/" style="font-size: 13.33px;">Books</a><a href="/tags/CORS/" style="font-size: 10.00px;">CORS</a><a href="/tags/CSS3背景透明/" style="font-size: 10.00px;">CSS3背景透明</a><a href="/tags/CSS背景透明/" style="font-size: 10.00px;">CSS背景透明</a><a href="/tags/Callbacks/" style="font-size: 10.00px;">Callbacks</a><a href="/tags/Error-configuring-AutoCommit/" style="font-size: 10.00px;">Error configuring AutoCommit</a><a href="/tags/Finder/" style="font-size: 10.00px;">Finder</a><a href="/tags/HTML5专业编程/" style="font-size: 10.00px;">HTML5专业编程</a><a href="/tags/Hadoop/" style="font-size: 10.00px;">Hadoop</a><a href="/tags/Hammer-js/" style="font-size: 10.00px;">Hammer.js</a><a href="/tags/JavaScript/" style="font-size: 20.00px;">JavaScript</a><a href="/tags/JavaScript作用域/" style="font-size: 10.00px;">JavaScript作用域</a><a href="/tags/MapReduce/" style="font-size: 10.00px;">MapReduce</a><a href="/tags/NERDTree/" style="font-size: 10.00px;">NERDTree</a><a href="/tags/RequireJS/" style="font-size: 10.00px;">RequireJS</a><a href="/tags/TransactionException/" style="font-size: 10.00px;">TransactionException</a><a href="/tags/Varnish/" style="font-size: 10.00px;">Varnish</a><a href="/tags/Weinre/" style="font-size: 10.00px;">Weinre</a><a href="/tags/WordPress/" style="font-size: 16.67px;">WordPress</a><a href="/tags/WordPress，代码高亮，定制样式，自定义css，自定义js/" style="font-size: 10.00px;">WordPress，代码高亮，定制样式，自定义css，自定义js</a><a href="/tags/XMLHttpRequest/" style="font-size: 10.00px;">XMLHttpRequest</a><a href="/tags/ajax/" style="font-size: 10.00px;">ajax</a><a href="/tags/ajax登录/" style="font-size: 10.00px;">ajax登录</a><a href="/tags/angular-js/" style="font-size: 10.00px;">angular.js</a><a href="/tags/animate/" style="font-size: 10.00px;">animate</a><a href="/tags/api/" style="font-size: 10.00px;">api</a><a href="/tags/attribute/" style="font-size: 10.00px;">attribute</a><a href="/tags/backbone/" style="font-size: 10.00px;">backbone</a><a href="/tags/bad-gateway/" style="font-size: 10.00px;">bad gateway</a><a href="/tags/base64/" style="font-size: 10.00px;">base64</a><a href="/tags/bug/" style="font-size: 10.00px;">bug</a><a href="/tags/canvas/" style="font-size: 10.00px;">canvas</a><a href="/tags/canvas-图片/" style="font-size: 10.00px;">canvas 图片</a><a href="/tags/cdn/" style="font-size: 10.00px;">cdn</a><a href="/tags/checked-exception/" style="font-size: 10.00px;">checked exception</a>
    </div>
  </div>


</aside>
</div>
    </div>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>





<script>
     window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["qzone","tsina","weixin","renren","tqq","tieba","douban","sqq","diandian","huaban","youdao","mail","ty","fbook","twi","linkedin","copy","print"],"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"4","bdPos":"right","bdTop":"350"},"image":{"viewList":["weixin","qzone","tsina","renren","douban","tqq"],"viewText":"分享：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["weixin","qzone","tsina","renren","douban","tqq"]}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script>


  </body>
</html>
