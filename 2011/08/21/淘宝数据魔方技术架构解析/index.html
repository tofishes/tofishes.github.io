
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="baidu_union_verify" content="d1952c66cf48912e21c18c7c581f382a">
  <meta name="360-site-verification" content="67fbcc5a67f4c65c057315b28fa0b2c8" />
<meta name="google-site-verification" content="2GzxQ0VtXwTSUdmGm6DzcmhTzM_I9QmzCb_pzpMzD88" />
  
    <title>淘宝数据魔方技术架构解析 | 听雨~</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="[object Object]">
    
    <meta name="description" content="来源于： http://howe.im/网络/淘宝数据魔方技术架构解析.html
淘宝网拥有国内最具商业价值的海量数据。截至当前，每天有超过30亿的店铺、商品浏览记录，10亿在线商品数，上千万的成交、收藏和评价数据。如何从这些数据中挖掘出真正的商业价值，进而帮助淘宝、商家进行企业的数据化运营，帮助消">
    
    
    
    
    <link rel="alternate" href="atom.xml" title="听雨~" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">

    
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            var _bdId ='391982416296a0d54221f59fe35250d4';
             hm.src = "//hm.baidu.com/hm.js?" + _bdId;
             var s = document.getElementsByTagName("script")[0]; 
             s.parentNode.insertBefore(hm, s);
        })();
    </script>
     
</head>

  <body>
    <header>
      <div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="听雨~">听雨~</a></h1>
				<a class="blog-motto">昨夜卧听风吹雨，不若相忘于江湖。</a>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
					<li>
					
                                            <form class="search" action=http://search.baidu.com/cse/search target="_blank">
                                            <label>Search</label>
                                        <input name="s" type="hidden" value= null ><input type="text" name="q" size="30" placeholder="搜索"><br>
					
					</li>
				</ul>
                            </nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2011/08/21/淘宝数据魔方技术架构解析/" title="淘宝数据魔方技术架构解析" itemprop="url">淘宝数据魔方技术架构解析</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://umitime.com" title="[object Object]">[object Object]</a>
    </p>
  <p class="article-time">
    <time datetime="2011-08-21T05:11:10.000Z" itemprop="datePublished">8月 21 2011</time>
    更新日期:<time datetime="2014-10-15T04:37:55.000Z" itemprop="dateModified">10月 15 2014</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
		</div>
		
		<p><span style="color: #008000;">来源于： <a href="http://howe.im/网络/淘宝数据魔方技术架构解析.html" target="_blank" rel="external">http://howe.im/网络/淘宝数据魔方技术架构解析.html</a></span></p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">淘宝网拥有国内最具商业价值的海量数据。截至当前，每天有超过</span><span style="font-family: Verdana; background-color: #f9f9f9;">30</span><span style="font-family: 宋体; background-color: #f9f9f9;">亿的店铺、商品浏览记录，</span><span style="font-family: Verdana; background-color: #f9f9f9;">10</span><span style="font-family: 宋体; background-color: #f9f9f9;">亿在线商品数，上千万的成交、收藏和评价数据。如何</span><span style="font-family: 宋体; background-color: #f9f9f9;">从这些数据中挖掘出真正的商业价值，进而帮助淘宝、商家进行企业的数据化运营，帮助消费者进行理性的购物决策，是淘宝数据平台与产品部的使命。</span></span></p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">为此，我们进行了一系列数据产品的研发，比如为大家所熟知的量子统计、数据魔方和淘宝指数等。尽管从业务层面来讲，数据产品的研发难度并不高；但在</span><span style="font-family: Verdana; background-color: #f9f9f9;"> “</span><span style="font-family: 宋体; background-color: #f9f9f9;">海量</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">的限定下，数据产品的计算、存储和检索难度陡然上升。本文将以数据魔方为例，向大家介绍淘宝在海量数据产品技术架构方面的探索。</span></span></p>
<p><span style="color: black; font-size: 18pt;"><strong><span style="font-family: 宋体; background-color: #f9f9f9;">淘宝海量数据产品技术架构</span></strong></span></p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">数据产品的一个最大特点是数据的非实时写入，正因为如此，我们可以认为，在一定的时间段内，整个系统的数据是只读的。这为我们设计缓存奠定了非常重要的基础。</span></span></p>
<p><a href="http://howe.im/wp-content/uploads/2011/08/03225917_b2JI.png" target="_blank" rel="external"><img src="http://howe.im/wp-content/uploads/2011/08/080311_1659_1.png" alt=""></a></p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">图</span><span style="font-family: Verdana; background-color: #f9f9f9;">1 </span><span style="font-family: 宋体; background-color: #f9f9f9;">淘宝海量数据产品技术架构</span></span></p>
<p><span id="more-354"></span></p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">按照数据的流向来划分，我们把淘宝数据产品的技术架构分为五层（如图</span><span style="font-family: Verdana; background-color: #f9f9f9;">1</span><span style="font-family: 宋体; background-color: #f9f9f9;">所示），分别是数据源、计算层、存储层、查询层和产品层。位于架构顶端的是我</span><span style="font-family: 宋体; background-color: #f9f9f9;">们的数据来源层，这里有淘宝主站的用户、店铺、商品和交易等数据库，还有用户的浏览、搜索等行为日志等。这一系列的数据是数据产品最原始的生命力所在。</span></span></p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">在数据源层实时产生的数据，通过淘宝自主研发的数据传输组件</span><span style="font-family: Verdana; background-color: #f9f9f9;">DataX</span><span style="font-family: 宋体; background-color: #f9f9f9;">、</span><span style="font-family: Verdana; background-color: #f9f9f9;">DbSync</span><span style="font-family: 宋体; background-color: #f9f9f9;">和</span><span style="font-family: Verdana; background-color: #f9f9f9;">Timetunnel</span><span style="font-family: 宋体; background-color: #f9f9f9;">准实时地传输到一个有</span><span style="font-family: Verdana; background-color: #f9f9f9;">1500</span><span style="font-family: 宋体; background-color: #f9f9f9;">个节点的</span><span style="font-family: Verdana; background-color: #f9f9f9;"> Hadoop</span><span style="font-family: 宋体; background-color: #f9f9f9;">集群上，这个集群我们称之为</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">云梯</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">，是计算层的主要组成部分。在</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">云梯</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">上，我们每天有大约</span><span style="font-family: Verdana; background-color: #f9f9f9;">40000</span><span style="font-family: 宋体; background-color: #f9f9f9;">个作业对</span><span style="font-family: Verdana; background-color: #f9f9f9;">1.5PB</span><span style="font-family: 宋体; background-color: #f9f9f9;">的原始数据按照产</span><span style="font-family: 宋体; background-color: #f9f9f9;">品需求进行不同的</span><span style="font-family: Verdana; background-color: #f9f9f9;">MapReduce</span><span style="font-family: 宋体; background-color: #f9f9f9;">计算。这一计算过程通常都能在凌晨两点之前完成。相对于前端产品看到的数据，这里的计算结果很可能是一个处于中间状态</span><span style="font-family: 宋体; background-color: #f9f9f9;">的结果，这往往是在数据冗余与前端计算之间做了适当平衡的结果。</span></span></p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">不得不提的是，一些对实效性要求很高的数据，例如针对搜索词的统计数据，我们希望能尽快推送到数据产品前端。这种需求再采用</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">云梯</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">来计算效率将是</span><span style="font-family: 宋体; background-color: #f9f9f9;">比较低的，为此我们做了流式数据的实时计算平台，称之为</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">银河</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">。</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">银河</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">也是一个分布式系统，它接收来自</span><span style="font-family: Verdana; background-color: #f9f9f9;">TimeTunnel</span><span style="font-family: 宋体; background-color: #f9f9f9;">的实时消息，在内存中做实</span><span style="font-family: 宋体; background-color: #f9f9f9;">时计算，并把计算结果在尽可能短的时间内刷新到</span><span style="font-family: Verdana; background-color: #f9f9f9;">NoSQL</span><span style="font-family: 宋体; background-color: #f9f9f9;">存储设备中，供前端产品调用。</span></span></p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">容易理解，</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">云梯</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">或者</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">银河</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">并不适合直接向产品提供实时的数据查询服务。这是因为，对于</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">云梯</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">来说，它的定位只是做离线计算的，无法支持较高</span><span style="font-family: 宋体; background-color: #f9f9f9;">的性能和并发需求；而对于</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">银河</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">而言，尽管所有的代码都掌握在我们手中，但要完整地将数据接收、实时计算、存储和查询等功能集成在一个分布式系统中，避</span><span style="font-family: 宋体; background-color: #f9f9f9;">免不了分层，最终仍然落到了目前的架构上。</span></span></p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">为此，我们针对前端产品设计了专门的存储层。在这一层，我们有基于</span><span style="font-family: Verdana; background-color: #f9f9f9;">MySQL</span><span style="font-family: 宋体; background-color: #f9f9f9;">的分布式关系型数据库集群</span><span style="font-family: Verdana; background-color: #f9f9f9;">MyFOX</span><span style="font-family: 宋体; background-color: #f9f9f9;">和基于</span><span style="font-family: Verdana; background-color: #f9f9f9;">HBase</span><span style="font-family: 宋体; background-color: #f9f9f9;">的</span><span style="font-family: Verdana; background-color: #f9f9f9;">NoSQL</span><span style="font-family: 宋体; background-color: #f9f9f9;">存储集群</span><span style="font-family: Verdana; background-color: #f9f9f9;">Prom</span><span style="font-family: 宋体; background-color: #f9f9f9;">，在后面的文字中，我将重点介绍这两个集群的实现原理。除此之外，其他第三方的模块也被我们纳入存储层的范畴。</span></span></p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">存储层异构模块的增多，对前端产品的使用带来了挑战。为此，我们设计了通用的数据中间层</span><span style="font-family: Verdana; background-color: #f9f9f9;">——glider——</span><span style="font-family: 宋体; background-color: #f9f9f9;">来屏蔽这个影响。</span><span style="font-family: Verdana; background-color: #f9f9f9;">glider</span><span style="font-family: 宋体; background-color: #f9f9f9;">以</span><span style="font-family: Verdana; background-color: #f9f9f9;">HTTP</span><span style="font-family: 宋体; background-color: #f9f9f9;">协议对外提供</span><span style="font-family: Verdana; background-color: #f9f9f9;">restful</span><span style="font-family: 宋体; background-color: #f9f9f9;">方式的接口。数据产品可以通过一个唯一的</span><span style="font-family: Verdana; background-color: #f9f9f9;">URL</span><span style="font-family: 宋体; background-color: #f9f9f9;">获取到它想要的数据。</span></span></p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">以上是淘宝海量数据产品在技术架构方面的一个概括性的介绍，接下来我将重点从四个方面阐述数据魔方设计上的特点。</span></span></p>
<p>&nbsp;</p>
<p><span style="color: black; font-size: 18pt;"><strong><span style="font-family: 宋体; background-color: #f9f9f9;">关系型数据库仍然是王道</span></strong></span></p>
<p>&nbsp;</p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">关系型数据库（</span><span style="font-family: Verdana; background-color: #f9f9f9;">RDBMS</span><span style="font-family: 宋体; background-color: #f9f9f9;">）自</span><span style="font-family: Verdana; background-color: #f9f9f9;">20</span><span style="font-family: 宋体; background-color: #f9f9f9;">世纪</span><span style="font-family: Verdana; background-color: #f9f9f9;">70</span><span style="font-family: 宋体; background-color: #f9f9f9;">年代提出以来，在工业生产中得到了广泛的使用。经过三十多年的长足发展，诞生了一批优秀的数据库软件，例如</span><span style="font-family: Verdana; background-color: #f9f9f9;">Oracle</span><span style="font-family: 宋体; background-color: #f9f9f9;">、</span><span style="font-family: Verdana; background-color: #f9f9f9;">MySQL</span><span style="font-family: 宋体; background-color: #f9f9f9;">、</span><span style="font-family: Verdana; background-color: #f9f9f9;">DB2</span><span style="font-family: 宋体; background-color: #f9f9f9;">、</span><span style="font-family: Verdana; background-color: #f9f9f9;">Sybase</span><span style="font-family: 宋体; background-color: #f9f9f9;">和</span><span style="font-family: Verdana; background-color: #f9f9f9;">SQL Server</span><span style="font-family: 宋体; background-color: #f9f9f9;">等。</span></span></p>
<p>&nbsp;</p>
<p><a href="http://howe.im/wp-content/uploads/2011/08/03225917_W8YS.png" target="_blank" rel="external"><img src="http://howe.im/wp-content/uploads/2011/08/080311_1659_2.png" alt=""></a></p>
<p>&nbsp;</p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">图</span><span style="font-family: Verdana; background-color: #f9f9f9;">2 MyFOX</span><span style="font-family: 宋体; background-color: #f9f9f9;">中的数据增长曲线</span></span></p>
<p>&nbsp;</p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">尽管相对于非关系型数据库而言，关系型数据库在分区容忍性（</span><span style="font-family: Verdana; background-color: #f9f9f9;">Tolerance to Network Partitions</span><span style="font-family: 宋体; background-color: #f9f9f9;">）方面存在劣势，但由于它强大的语义表达能力以及数据之间的关系表达能力，在数据产品中仍然占据着不可替代的作用。</span></span></p>
<p>&nbsp;</p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">淘宝数据产品选择</span><span style="font-family: Verdana; background-color: #f9f9f9;">MySQL</span><span style="font-family: 宋体; background-color: #f9f9f9;">的</span><span style="font-family: Verdana; background-color: #f9f9f9;">MyISAM</span><span style="font-family: 宋体; background-color: #f9f9f9;">引擎作为底层的数据存储引擎。在此基础上，为了应对海量数据，我们设计了分布式</span><span style="font-family: Verdana; background-color: #f9f9f9;">MySQL</span><span style="font-family: 宋体; background-color: #f9f9f9;">集群的查询代理层</span><span style="font-family: Verdana; background-color: #f9f9f9;">——MyFOX</span><span style="font-family: 宋体; background-color: #f9f9f9;">，使得分区对前端应用透明。</span></span></p>
<p>&nbsp;</p>
<p><a href="http://howe.im/wp-content/uploads/2011/08/03225918_KXQF.png" target="_blank" rel="external"><img src="http://howe.im/wp-content/uploads/2011/08/080311_1659_3.png" alt=""></a></p>
<p>&nbsp;</p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">图</span><span style="font-family: Verdana; background-color: #f9f9f9;">3 MyFOX</span><span style="font-family: 宋体; background-color: #f9f9f9;">的数据查询过程</span></span></p>
<p>&nbsp;</p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">目前，存储在</span><span style="font-family: Verdana; background-color: #f9f9f9;">MyFOX</span><span style="font-family: 宋体; background-color: #f9f9f9;">中的统计结果数据已经达到</span><span style="font-family: Verdana; background-color: #f9f9f9;">10TB</span><span style="font-family: 宋体; background-color: #f9f9f9;">，占据着数据魔方总数据量的</span><span style="font-family: Verdana; background-color: #f9f9f9;">95%</span><span style="font-family: 宋体; background-color: #f9f9f9;">以上，并且正在以每天超过</span><span style="font-family: Verdana; background-color: #f9f9f9;">6</span><span style="font-family: 宋体; background-color: #f9f9f9;">亿的增量增长着（如图</span><span style="font-family: Verdana; background-color: #f9f9f9;">2</span><span style="font-family: 宋体; background-color: #f9f9f9;">所示）。这些数据被我们近似均匀地分布到</span><span style="font-family: Verdana; background-color: #f9f9f9;">20</span><span style="font-family: 宋体; background-color: #f9f9f9;">个</span><span style="font-family: Verdana; background-color: #f9f9f9;">MySQL</span><span style="font-family: 宋体; background-color: #f9f9f9;">节点上，在查询时，经由</span><span style="font-family: Verdana; background-color: #f9f9f9;">MyFOX</span><span style="font-family: 宋体; background-color: #f9f9f9;">透明地对外服务（如图</span><span style="font-family: Verdana; background-color: #f9f9f9;">3</span><span style="font-family: 宋体; background-color: #f9f9f9;">所示）。</span></span></p>
<p>&nbsp;</p>
<p><a href="http://howe.im/wp-content/uploads/2011/08/03225918_hWzo.png" target="_blank" rel="external"><img src="http://howe.im/wp-content/uploads/2011/08/080311_1659_4.png" alt=""></a></p>
<p>&nbsp;</p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">图</span><span style="font-family: Verdana; background-color: #f9f9f9;">4 MyFOX</span><span style="font-family: 宋体; background-color: #f9f9f9;">节点结构</span></span></p>
<p>&nbsp;</p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">值得一提的是，在</span><span style="font-family: Verdana; background-color: #f9f9f9;">MyFOX</span><span style="font-family: 宋体; background-color: #f9f9f9;">现有的</span><span style="font-family: Verdana; background-color: #f9f9f9;">20</span><span style="font-family: 宋体; background-color: #f9f9f9;">个节点中，并不是所有节点都是</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">平等</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">的。一般而言，数据产品的用户更多地只关心</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">最近几天</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">的数据，越早的数据，越容易被冷落。为此，出于硬件成本考虑，我们在这</span><span style="font-family: Verdana; background-color: #f9f9f9;">20</span><span style="font-family: 宋体; background-color: #f9f9f9;">个节点中分出了</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">热节点</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">和</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">冷节点</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">（如图</span><span style="font-family: Verdana; background-color: #f9f9f9;">4</span><span style="font-family: 宋体; background-color: #f9f9f9;">所示）。</span></span></p>
<p>&nbsp;</p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">顾名思义，</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">热节点</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">存放最新的、被访问频率较高的数据。对于这部分数据，我们希望能给用户提供尽可能快的查询速度，所以在硬盘方面，我们选择了每</span><span style="font-family: 宋体; background-color: #f9f9f9;">分钟</span><span style="font-family: Verdana; background-color: #f9f9f9;">15000</span><span style="font-family: 宋体; background-color: #f9f9f9;">转的</span><span style="font-family: Verdana; background-color: #f9f9f9;">SAS</span><span style="font-family: 宋体; background-color: #f9f9f9;">硬盘，按照一个节点两台机器来计算，单位数据的存储成本约为</span><span style="font-family: Verdana; background-color: #f9f9f9;">4.5W/TB</span><span style="font-family: 宋体; background-color: #f9f9f9;">。相对应地，</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">冷数据</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">我们选择了每分钟</span><span style="font-family: Verdana; background-color: #f9f9f9;">7500</span><span style="font-family: 宋体; background-color: #f9f9f9;">转的</span><span style="font-family: Verdana; background-color: #f9f9f9;"> SATA</span><span style="font-family: 宋体; background-color: #f9f9f9;">硬盘，单碟上能够存放更多的数据，存储成本约为</span><span style="font-family: Verdana; background-color: #f9f9f9;">1.6W/TB</span><span style="font-family: 宋体; background-color: #f9f9f9;">。</span></span></p>
<p>&nbsp;</p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">将冷热数据进行分离的另外一个好处是可以有效降低内存磁盘比。从图</span><span style="font-family: Verdana; background-color: #f9f9f9;">4</span><span style="font-family: 宋体; background-color: #f9f9f9;">可以看出，</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">热节点</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">上单机只有</span><span style="font-family: Verdana; background-color: #f9f9f9;">24GB</span><span style="font-family: 宋体; background-color: #f9f9f9;">内存，而磁盘装满大约有</span><span style="font-family: Verdana; background-color: #f9f9f9;"> 1.8TB</span><span style="font-family: 宋体; background-color: #f9f9f9;">（</span><span style="font-family: Verdana; background-color: #f9f9f9;">300 <em> 12 </em> 0.5 / 1024</span><span style="font-family: 宋体; background-color: #f9f9f9;">），内存磁盘比约为</span><span style="font-family: Verdana; background-color: #f9f9f9;">4:300</span><span style="font-family: 宋体; background-color: #f9f9f9;">，远远低于</span><span style="font-family: Verdana; background-color: #f9f9f9;">MySQL</span><span style="font-family: 宋体; background-color: #f9f9f9;">服务器的一个合理值。内存磁盘比过低导致的后</span></span></p>
<p><span style="font-family: 宋体; background-color: #f9f9f9;">果是，总有一天，即使所有内存用完也存不下数据的索引了</span><span style="font-family: Verdana; background-color: #f9f9f9;">——</span><span style="font-family: 宋体; background-color: #f9f9f9;">这个时候，大量的查询请求都需要从磁盘中读取索引，效率大打折扣。</span></p>
<p>&nbsp;</p>
<p><span style="color: black; font-size: 18pt;"><strong><span style="font-family: Verdana; background-color: #f9f9f9;">NoSQL</span><span style="font-family: 宋体; background-color: #f9f9f9;">是</span><span style="font-family: Verdana; background-color: #f9f9f9;">SQL</span><span style="font-family: 宋体; background-color: #f9f9f9;">的有益补充</span></strong></span></p>
<p>&nbsp;</p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">在</span><span style="font-family: Verdana; background-color: #f9f9f9;">MyFOX</span><span style="font-family: 宋体; background-color: #f9f9f9;">出现之后，一切都看起来那么完美，开发人员甚至不会意识到</span><span style="font-family: Verdana; background-color: #f9f9f9;">MyFOX</span><span style="font-family: 宋体; background-color: #f9f9f9;">的存在，一条不用任何特殊修饰的</span><span style="font-family: Verdana; background-color: #f9f9f9;">SQL</span><span style="font-family: 宋体; background-color: #f9f9f9;">语句就可以满足需求。这个状态持续了很长一段时间，直到有一天，我们碰到了传统的关系型数据库无法解决的问题</span><span style="font-family: Verdana; background-color: #f9f9f9;">——</span><span style="font-family: 宋体; background-color: #f9f9f9;">全属性选择器（如图</span><span style="font-family: Verdana; background-color: #f9f9f9;">5</span><span style="font-family: 宋体; background-color: #f9f9f9;">所示）。</span></span></p>
<p>&nbsp;</p>
<p><a href="http://howe.im/wp-content/uploads/2011/08/03225919_TUcu.png" target="_blank" rel="external"><img src="http://howe.im/wp-content/uploads/2011/08/080311_1659_5.png" alt=""></a></p>
<p>&nbsp;</p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">图</span><span style="font-family: Verdana; background-color: #f9f9f9;">5 </span><span style="font-family: 宋体; background-color: #f9f9f9;">全属性选择器</span></span></p>
<p>&nbsp;</p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">这是一个非常典型的例子。为了说明问题，我们仍然以关系型数据库的思路来描述。对于笔记本电脑这个类目，用户某一次查询所选择的过滤条件可能包括</span><span style="font-family: Verdana; background-color: #f9f9f9;"> “</span><span style="font-family: 宋体; background-color: #f9f9f9;">笔记本尺寸</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">、</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">笔记本定位</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">、</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">硬盘容量</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">等一系列属性（字段），并且在每个可能用在过滤条件的属性上，属性值的分布是极不均匀的。在图</span><span style="font-family: Verdana; background-color: #f9f9f9;">5</span><span style="font-family: 宋体; background-color: #f9f9f9;">中我们可以</span><span style="font-family: 宋体; background-color: #f9f9f9;">看到，笔记本电脑的尺寸这一属性有着</span><span style="font-family: Verdana; background-color: #f9f9f9;">10</span><span style="font-family: 宋体; background-color: #f9f9f9;">个枚举值，而</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">蓝牙功能</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">这个属性值是个布尔值，数据的筛选性非常差。</span></span></p>
<p>&nbsp;</p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">在用户所选择的过滤条件不确定的情况下，解决全属性问题的思路有两个：一个是穷举所有可能的过滤条件组合，在</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">云梯</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">上进行预先计算，存入数据库供</span><span style="font-family: 宋体; background-color: #f9f9f9;">查询；另一个是存储原始数据，在用户查询时根据过滤条件筛选出相应的记录进行现场计算。很明显，由于过滤条件的排列组合几乎是无法穷举的，第一种方案在现</span><span style="font-family: 宋体; background-color: #f9f9f9;">实中是不可取的；而第二种方案中，原始数据存储在什么地方？如果仍然用关系型数据库，那么你打算怎样为这个表建立索引？</span></span></p>
<p>&nbsp;</p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">这一系列问题把我们引到了</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">创建定制化的存储、现场计算并提供查询服务的引擎</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">的思路上来，这就是</span><span style="font-family: Verdana; background-color: #f9f9f9;">Prometheus</span><span style="font-family: 宋体; background-color: #f9f9f9;">（如图</span><span style="font-family: Verdana; background-color: #f9f9f9;">6</span><span style="font-family: 宋体; background-color: #f9f9f9;">所示）。</span></span></p>
<p>&nbsp;</p>
<p><a href="http://howe.im/wp-content/uploads/2011/08/03225919_kmaS.png" target="_blank" rel="external"><img src="http://howe.im/wp-content/uploads/2011/08/080311_1659_6.png" alt=""></a></p>
<p>&nbsp;</p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">图</span><span style="font-family: Verdana; background-color: #f9f9f9;">6 Prom</span><span style="font-family: 宋体; background-color: #f9f9f9;">的存储结构</span></span></p>
<p>&nbsp;</p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">从图</span><span style="font-family: Verdana; background-color: #f9f9f9;">6</span><span style="font-family: 宋体; background-color: #f9f9f9;">可以看出，我们选择了</span><span style="font-family: Verdana; background-color: #f9f9f9;">HBase</span><span style="font-family: 宋体; background-color: #f9f9f9;">作为</span><span style="font-family: Verdana; background-color: #f9f9f9;">Prom</span><span style="font-family: 宋体; background-color: #f9f9f9;">的底层存储引擎。之所以选择</span><span style="font-family: Verdana; background-color: #f9f9f9;">HBase</span><span style="font-family: 宋体; background-color: #f9f9f9;">，主要是因为它是建立在</span><span style="font-family: Verdana; background-color: #f9f9f9;">HDFS</span><span style="font-family: 宋体; background-color: #f9f9f9;">之上的，并且对于</span><span style="font-family: Verdana; background-color: #f9f9f9;"> MapReduce</span><span style="font-family: 宋体; background-color: #f9f9f9;">有良好的编程接口。尽管</span><span style="font-family: Verdana; background-color: #f9f9f9;">Prom</span><span style="font-family: 宋体; background-color: #f9f9f9;">是一个通用的、解决共性问题的服务框架，但在这里，我们仍然以全属性选择为例，来说明</span><span style="font-family: Verdana; background-color: #f9f9f9;">Prom</span><span style="font-family: 宋体; background-color: #f9f9f9;">的工作原</span><span style="font-family: 宋体; background-color: #f9f9f9;">理。这里的原始数据是前一天在淘宝上的交易明细，在</span><span style="font-family: Verdana; background-color: #f9f9f9;">HBase</span><span style="font-family: 宋体; background-color: #f9f9f9;">集群中，我们以属性对（属性与属性值的组合）作为</span><span style="font-family: Verdana; background-color: #f9f9f9;">row-key</span><span style="font-family: 宋体; background-color: #f9f9f9;">进行存储。而</span><span style="font-family: Verdana; background-color: #f9f9f9;">row-key </span><span style="font-family: 宋体; background-color: #f9f9f9;">对应的值，我们设计了两个</span><span style="font-family: Verdana; background-color: #f9f9f9;">column-family</span><span style="font-family: 宋体; background-color: #f9f9f9;">，即存放交易</span><span style="font-family: Verdana; background-color: #f9f9f9;">ID</span><span style="font-family: 宋体; background-color: #f9f9f9;">列表的</span><span style="font-family: Verdana; background-color: #f9f9f9;">index</span><span style="font-family: 宋体; background-color: #f9f9f9;">字段和原始交易明细的</span><span style="font-family: Verdana; background-color: #f9f9f9;">data</span><span style="font-family: 宋体; background-color: #f9f9f9;">字段。在存储的时候，我们有意识地让</span><span style="font-family: 宋体; background-color: #f9f9f9;">每个字段中的每一个元素都是定长的，这是为了支持通过偏移量快速地找到相应记录，避免复杂的查找算法和磁盘的大量随机读取请求。</span></span></p>
<p>&nbsp;</p>
<p><a href="http://howe.im/wp-content/uploads/2011/08/03225920_QHkh.png" target="_blank" rel="external"><img src="http://howe.im/wp-content/uploads/2011/08/080311_1659_7.png" alt=""></a></p>
<p>&nbsp;</p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">图</span><span style="font-family: Verdana; background-color: #f9f9f9;">7 Prom</span><span style="font-family: 宋体; background-color: #f9f9f9;">查询过程</span></span></p>
<p>&nbsp;</p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">图</span><span style="font-family: Verdana; background-color: #f9f9f9;">7</span><span style="font-family: 宋体; background-color: #f9f9f9;">用一个典型的例子描述的</span><span style="font-family: Verdana; background-color: #f9f9f9;">Prom</span><span style="font-family: 宋体; background-color: #f9f9f9;">在提供查询服务时的工作原理，限于篇幅，这里不做详细描述。值得一提的是，</span><span style="font-family: Verdana; background-color: #f9f9f9;">Prom</span><span style="font-family: 宋体; background-color: #f9f9f9;">支持的计算并不仅限于求和</span><span style="font-family: Verdana; background-color: #f9f9f9;"> SUM</span><span style="font-family: 宋体; background-color: #f9f9f9;">运算，统计意义上的常用计算都是支持的。在现场计算方面，我们对</span><span style="font-family: Verdana; background-color: #f9f9f9;">Hbase</span><span style="font-family: 宋体; background-color: #f9f9f9;">进行了扩展，</span><span style="font-family: Verdana; background-color: #f9f9f9;">Prom</span><span style="font-family: 宋体; background-color: #f9f9f9;">要求每个节点返回的数据是已经经过</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">本地计算</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">的局</span><span style="font-family: 宋体; background-color: #f9f9f9;">部最优解，最终的全局最优解只是各个节点返回的局部最优解的一个简单汇总。很显然，这样的设计思路是要充分利用各个节点的并行计算能力，并且避免大量明细</span><span style="font-family: 宋体; background-color: #f9f9f9;">数据的网络传输开销。</span></span></p>
<p>&nbsp;</p>
<p><span style="color: black; font-size: 18pt;"><strong><span style="font-family: 宋体; background-color: #f9f9f9;">用中间层隔离前后端</span></strong></span></p>
<p>&nbsp;</p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">上文提到过，</span><span style="font-family: Verdana; background-color: #f9f9f9;">MyFOX</span><span style="font-family: 宋体; background-color: #f9f9f9;">和</span><span style="font-family: Verdana; background-color: #f9f9f9;">Prom</span><span style="font-family: 宋体; background-color: #f9f9f9;">为数据产品的不同需求提供了数据存储和底层查询的解决方案，但随之而来的问题是，各种异构的存储模块给前端产品的使用带来了很大的挑战。并且，前端产品的一个请求所需要的数据往往不可能只从一个模块获取。</span></span></p>
<p>&nbsp;</p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">举个例子，我们要在数据魔方中看昨天做热销的商品，首先从</span><span style="font-family: Verdana; background-color: #f9f9f9;">MyFOX</span><span style="font-family: 宋体; background-color: #f9f9f9;">中拿到一个热销排行榜的数据，但这里的</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">商品</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">只是一个</span><span style="font-family: Verdana; background-color: #f9f9f9;">ID</span><span style="font-family: 宋体; background-color: #f9f9f9;">，并没有</span><span style="font-family: Verdana; background-color: #f9f9f9;">ID</span><span style="font-family: 宋体; background-color: #f9f9f9;">所对应</span><span style="font-family: 宋体; background-color: #f9f9f9;">的商品描述、图片等数据。这个时候我们要从淘宝主站提供的接口中去获取这些数据，然后一一对应到热销排行榜中，最终呈现给用户。</span></span></p>
<p>&nbsp;</p>
<p><a href="http://howe.im/wp-content/uploads/2011/08/03225920_K5qy.png" target="_blank" rel="external"><img src="http://howe.im/wp-content/uploads/2011/08/080311_1659_8.png" alt=""></a></p>
<p>&nbsp;</p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">图</span><span style="font-family: Verdana; background-color: #f9f9f9;">8 glider</span><span style="font-family: 宋体; background-color: #f9f9f9;">的技术架构</span></span></p>
<p>&nbsp;</p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">有经验的读者一定可以想到，从本质上来讲，这就是广义上的异构</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">表</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">之间的</span><span style="font-family: Verdana; background-color: #f9f9f9;">JOIN</span><span style="font-family: 宋体; background-color: #f9f9f9;">操作。那么，谁来负责这个事情呢？很容易想到，在存储层与前端产</span><span style="font-family: 宋体; background-color: #f9f9f9;">品之间增加一个中间层，它负责各个异构</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">表</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">之间的数据</span><span style="font-family: Verdana; background-color: #f9f9f9;">JOIN</span><span style="font-family: 宋体; background-color: #f9f9f9;">和</span><span style="font-family: Verdana; background-color: #f9f9f9;">UNION</span><span style="font-family: 宋体; background-color: #f9f9f9;">等计算，并且隔离前端产品和后端存储，提供统一的数据查询服务。这个中间层就</span><span style="font-family: 宋体; background-color: #f9f9f9;">是</span><span style="font-family: Verdana; background-color: #f9f9f9;">glider</span><span style="font-family: 宋体; background-color: #f9f9f9;">（如图</span><span style="font-family: Verdana; background-color: #f9f9f9;">8</span><span style="font-family: 宋体; background-color: #f9f9f9;">所示）。</span></span></p>
<p>&nbsp;</p>
<p><span style="color: black; font-size: 18pt;"><strong><span style="font-family: 宋体; background-color: #f9f9f9;">缓存是系统化的工程</span></strong></span></p>
<p>&nbsp;</p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">除了起到隔离前后端以及异构</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">表</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">之间的数据整合的作用之外，</span><span style="font-family: Verdana; background-color: #f9f9f9;">glider</span><span style="font-family: 宋体; background-color: #f9f9f9;">的另外一个不容忽视的作用便是缓存管理。上文提到过，在特定的时间段内，我们认为数据产品中的数据是只读的，这是利用缓存来提高性能的理论基础。</span></span></p>
<p>&nbsp;</p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">在图</span><span style="font-family: Verdana; background-color: #f9f9f9;">8</span><span style="font-family: 宋体; background-color: #f9f9f9;">中我们看到，</span><span style="font-family: Verdana; background-color: #f9f9f9;">glider</span><span style="font-family: 宋体; background-color: #f9f9f9;">中存在两层缓存，分别是基于各个异构</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">表</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">（</span><span style="font-family: Verdana; background-color: #f9f9f9;">datasource</span><span style="font-family: 宋体; background-color: #f9f9f9;">）的二级缓存和整合之后基于独立请求的一级缓存。</span></span></p>
<p><span style="font-family: 宋体; background-color: #f9f9f9;">除此之外，各个异构</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">表</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">内部可能还存在自己的缓存机制。细心的读者一定注意到了图</span><span style="font-family: Verdana; background-color: #f9f9f9;">3</span><span style="font-family: 宋体; background-color: #f9f9f9;">中</span><span style="font-family: Verdana; background-color: #f9f9f9;">MyFOX</span><span style="font-family: 宋体; background-color: #f9f9f9;">的缓存设计，我们没有选择对汇总计算后的最终结果进行缓</span><span style="font-family: 宋体; background-color: #f9f9f9;">存，而是针对每个分片进行缓存，其目的在于提高缓存的命中率，并且降低数据的冗余度。</span></p>
<p>&nbsp;</p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">大量使用缓存的最大问题就是数据一致性问题。如何保证底层数据的变化在尽可能短的时间内体现给最终用户呢？这一定是一个系统化的工程，尤其对于分层较多的系统来说。</span></span></p>
<p>&nbsp;</p>
<p><a href="http://howe.im/wp-content/uploads/2011/08/03225920_beKf.png" target="_blank" rel="external"><img src="http://howe.im/wp-content/uploads/2011/08/080311_1659_9.png" alt=""></a></p>
<p>&nbsp;</p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">图</span><span style="font-family: Verdana; background-color: #f9f9f9;">9 </span><span style="font-family: 宋体; background-color: #f9f9f9;">缓存控制体系</span></span></p>
<p>&nbsp;</p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">图</span><span style="font-family: Verdana; background-color: #f9f9f9;">9</span><span style="font-family: 宋体; background-color: #f9f9f9;">向我们展示了数据魔方在缓存控制方面的设计思路。用户的请求中一定是带了缓存控制的</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">命令</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">的，这包括</span><span style="font-family: Verdana; background-color: #f9f9f9;">URL</span><span style="font-family: 宋体; background-color: #f9f9f9;">中的</span><span style="font-family: Verdana; background-color: #f9f9f9;">query string</span><span style="font-family: 宋体; background-color: #f9f9f9;">，和</span><span style="font-family: Verdana; background-color: #f9f9f9;"> HTTP</span><span style="font-family: 宋体; background-color: #f9f9f9;">头中的</span><span style="font-family: Verdana; background-color: #f9f9f9;">“If-None-Match”</span><span style="font-family: 宋体; background-color: #f9f9f9;">信息。并且，这个缓存控制</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">命令</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">一定会经过层层传递，最终传递到底层存储的异构</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">表</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">模块。各异构</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">表</span><span style="font-family: Verdana; background-color: #f9f9f9;">” </span><span style="font-family: 宋体; background-color: #f9f9f9;">除了返回各自的数据之外，还会返回各自的数据缓存过期时间（</span><span style="font-family: Verdana; background-color: #f9f9f9;">ttl</span><span style="font-family: 宋体; background-color: #f9f9f9;">），而</span><span style="font-family: Verdana; background-color: #f9f9f9;">glider</span><span style="font-family: 宋体; background-color: #f9f9f9;">最终输出的过期时间是各个异构</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">表</span><span style="font-family: Verdana; background-color: #f9f9f9;">“</span><span style="font-family: 宋体; background-color: #f9f9f9;">过期时间的最小值。这一过期时间</span><span style="font-family: 宋体; background-color: #f9f9f9;">也一定是从底层存储层层传递，最终通过</span><span style="font-family: Verdana; background-color: #f9f9f9;">HTTP</span><span style="font-family: 宋体; background-color: #f9f9f9;">头返回给用户浏览器的。</span></span></p>
<p>&nbsp;</p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">缓存系统不得不考虑的另一个问题是缓存穿透与失效时的雪崩效应。缓存穿透是指查询一个一定不存在的数据，由于缓存是不命中时被动写的，并且出于容错考虑，如果从存储层查不到数据则不写入缓存，这将导致这个存在的数据每次请求都要到存储层去查询，失去了缓存的意义。</span></span></p>
<p>&nbsp;</p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">有很多种方法可以有效地解决缓存穿透问题，最常见的则是采用布隆过滤器，将所有可能存在的数据哈希到一个足够大的</span><span style="font-family: Verdana; background-color: #f9f9f9;">bitmap</span><span style="font-family: 宋体; background-color: #f9f9f9;">中，一个一定不存在的</span><span style="font-family: 宋体; background-color: #f9f9f9;">数据会被这个</span><span style="font-family: Verdana; background-color: #f9f9f9;">bitmap</span><span style="font-family: 宋体; background-color: #f9f9f9;">拦截掉，从而避免了对底层存储系统的查询压力。在数据魔方里，我们采用了一个更为简单粗暴的方法，如果一个查询返回的数据为空</span><span style="font-family: 宋体; background-color: #f9f9f9;">（不管是数据不存在，还是系统故障），我们仍然把这个空结果进行缓存，但它的过期时间会很短，最长不超过五分钟。</span></span></p>
<p>&nbsp;</p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">缓存失效时的雪崩效应对底层系统的冲击非常可怕。遗憾的是，这个问题目前并没有很完美的解决方案。大多数系统设计者考虑用加锁或者队列的方式保证缓</span><span style="font-family: 宋体; background-color: #f9f9f9;">存的单线程（进程）写，从而避免失效时大量的并发请求落到底层存储系统上。在数据魔方中，我们设计的缓存过期机制理论上能够将各个客户端的数据失效时间均</span><span style="font-family: 宋体; background-color: #f9f9f9;">匀地分布在时间轴上，一定程度上能够避免缓存同时失效带来的雪崩效应。</span></span></p>
<p>&nbsp;</p>
<p><span style="color: black; font-size: 18pt;"><strong><span style="font-family: 宋体; background-color: #f9f9f9;">结束语</span></strong></span></p>
<p>&nbsp;</p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">正是基于本文所描述的架构特点，数据魔方目前已经能够提供压缩前</span><span style="font-family: Verdana; background-color: #f9f9f9;">80TB</span><span style="font-family: 宋体; background-color: #f9f9f9;">的数据存储空间，数据中间层</span><span style="font-family: Verdana; background-color: #f9f9f9;">glider</span><span style="font-family: 宋体; background-color: #f9f9f9;">支持每天</span><span style="font-family: Verdana; background-color: #f9f9f9;">4000</span><span style="font-family: 宋体; background-color: #f9f9f9;">万的查询请求，平均响应时间在</span><span style="font-family: Verdana; background-color: #f9f9f9;">28</span><span style="font-family: 宋体; background-color: #f9f9f9;">毫秒（</span><span style="font-family: Verdana; background-color: #f9f9f9;">6</span><span style="font-family: 宋体; background-color: #f9f9f9;">月</span><span style="font-family: Verdana; background-color: #f9f9f9;">1</span><span style="font-family: 宋体; background-color: #f9f9f9;">日数据），足以满足未来一段时间内的业务增长需求。</span></span></p>
<p>&nbsp;</p>
<p><span style="color: black; font-size: 10pt;"><span style="font-family: 宋体; background-color: #f9f9f9;">尽管如此，整个系统中仍然存在很多不完善的地方。一个典型的例子莫过于各个分层之间使用短连接模式的</span><span style="font-family: Verdana; background-color: #f9f9f9;">HTTP</span><span style="font-family: 宋体; background-color: #f9f9f9;">协议进行通信。这样的策略直接导致在流</span><span style="font-family: 宋体; background-color: #f9f9f9;">量高峰期单机的</span><span style="font-family: Verdana; background-color: #f9f9f9;">TCP</span><span style="font-family: 宋体; background-color: #f9f9f9;">连接数非常高。所以说，一个良好的架构固然能够在很大程度上降低开发和维护的成本，但它自身一定是随着数据量和流量的变化而不断变化</span><span style="font-family: 宋体; background-color: #f9f9f9;">的。我相信，过不了几年，淘宝数据产品的技术架构一定会是另外的样子。</span></span></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>原文地址: <a href="http://www.oschina.net/question/3307_25131" target="_blank" rel="external">http://www.oschina.net/question/3307_25131</a></p>
  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/solution/">solution</a>
  </div>




<div class="article-share" id="share">

  <div data-url="http://umitime.com/2011/08/21/淘宝数据魔方技术架构解析/" data-title="淘宝数据魔方技术架构解析 | 听雨~" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2011/08/25/为什么使用-Redis及其产品定位/" title="为什么使用 Redis及其产品定位">
  <strong>PREVIOUS:</strong><br/>
  <span>
  为什么使用 Redis及其产品定位</span>
</a>
</div>


<div class="next">
<a href="/2011/08/21/使用-Node-js-作为完整的云环境开发堆栈/"  title="使用 Node.js 作为完整的云环境开发堆栈">
 <strong>NEXT:</strong><br/> 
 <span>使用 Node.js 作为完整的云环境开发堆栈
</span>
</a>
</div>

</nav>

	
</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
  
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">
<div id="authorInfo">
	
		<div class="author-logo"></div>		
	
	<div class="social-list" class="clearfix">
		
		
		
		
		
	</div>
</div>

  

  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			<li><a href="/tags/2012/" title="2012">2012<sup>1</sup></a></li>
		
			<li><a href="/tags/3cols-layout/" title="3cols layout">3cols layout<sup>1</sup></a></li>
		
			<li><a href="/tags/3栏布局/" title="3栏布局">3栏布局<sup>1</sup></a></li>
		
			<li><a href="/tags/Balsamiq-Mockups/" title="Balsamiq Mockups">Balsamiq Mockups<sup>1</sup></a></li>
		
			<li><a href="/tags/BigPipe/" title="BigPipe">BigPipe<sup>1</sup></a></li>
		
			<li><a href="/tags/Books/" title="Books">Books<sup>4</sup></a></li>
		
			<li><a href="/tags/CORS/" title="CORS">CORS<sup>1</sup></a></li>
		
			<li><a href="/tags/CSS3背景透明/" title="CSS3背景透明">CSS3背景透明<sup>1</sup></a></li>
		
			<li><a href="/tags/CSS背景透明/" title="CSS背景透明">CSS背景透明<sup>1</sup></a></li>
		
			<li><a href="/tags/Callbacks/" title="Callbacks">Callbacks<sup>1</sup></a></li>
		
			<li><a href="/tags/Error-configuring-AutoCommit/" title="Error configuring AutoCommit">Error configuring AutoCommit<sup>1</sup></a></li>
		
			<li><a href="/tags/Finder/" title="Finder">Finder<sup>1</sup></a></li>
		
			<li><a href="/tags/HTML5专业编程/" title="HTML5专业编程">HTML5专业编程<sup>1</sup></a></li>
		
			<li><a href="/tags/Hadoop/" title="Hadoop">Hadoop<sup>1</sup></a></li>
		
			<li><a href="/tags/Hammer-js/" title="Hammer.js">Hammer.js<sup>1</sup></a></li>
		
			<li><a href="/tags/JavaScript/" title="JavaScript">JavaScript<sup>43</sup></a></li>
		
			<li><a href="/tags/JavaScript作用域/" title="JavaScript作用域">JavaScript作用域<sup>1</sup></a></li>
		
			<li><a href="/tags/MapReduce/" title="MapReduce">MapReduce<sup>1</sup></a></li>
		
			<li><a href="/tags/NERDTree/" title="NERDTree">NERDTree<sup>1</sup></a></li>
		
			<li><a href="/tags/RequireJS/" title="RequireJS">RequireJS<sup>1</sup></a></li>
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
      <li><a href="http://gengbiao.me" target="_blank" title="gengbiao">Coney's Blog</a></li>
      <li><a href="http://hexo.io" target="_blank" title="Hexo">Hexo</a></li>
    </ul>
</div>


  <div class="rsspart">
	<a href="atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  
  <div class="tagcloudlist">
    <p class="asidetitle">标签云</p>
    <div class="tagcloudlist clearfix">
       <a href="/tags/2012/" style="font-size: 10.00px;">2012</a><a href="/tags/3cols-layout/" style="font-size: 10.00px;">3cols layout</a><a href="/tags/3栏布局/" style="font-size: 10.00px;">3栏布局</a><a href="/tags/Balsamiq-Mockups/" style="font-size: 10.00px;">Balsamiq Mockups</a><a href="/tags/BigPipe/" style="font-size: 10.00px;">BigPipe</a><a href="/tags/Books/" style="font-size: 13.33px;">Books</a><a href="/tags/CORS/" style="font-size: 10.00px;">CORS</a><a href="/tags/CSS3背景透明/" style="font-size: 10.00px;">CSS3背景透明</a><a href="/tags/CSS背景透明/" style="font-size: 10.00px;">CSS背景透明</a><a href="/tags/Callbacks/" style="font-size: 10.00px;">Callbacks</a><a href="/tags/Error-configuring-AutoCommit/" style="font-size: 10.00px;">Error configuring AutoCommit</a><a href="/tags/Finder/" style="font-size: 10.00px;">Finder</a><a href="/tags/HTML5专业编程/" style="font-size: 10.00px;">HTML5专业编程</a><a href="/tags/Hadoop/" style="font-size: 10.00px;">Hadoop</a><a href="/tags/Hammer-js/" style="font-size: 10.00px;">Hammer.js</a><a href="/tags/JavaScript/" style="font-size: 20.00px;">JavaScript</a><a href="/tags/JavaScript作用域/" style="font-size: 10.00px;">JavaScript作用域</a><a href="/tags/MapReduce/" style="font-size: 10.00px;">MapReduce</a><a href="/tags/NERDTree/" style="font-size: 10.00px;">NERDTree</a><a href="/tags/RequireJS/" style="font-size: 10.00px;">RequireJS</a><a href="/tags/TransactionException/" style="font-size: 10.00px;">TransactionException</a><a href="/tags/Varnish/" style="font-size: 10.00px;">Varnish</a><a href="/tags/Weinre/" style="font-size: 10.00px;">Weinre</a><a href="/tags/WordPress/" style="font-size: 16.67px;">WordPress</a><a href="/tags/WordPress，代码高亮，定制样式，自定义css，自定义js/" style="font-size: 10.00px;">WordPress，代码高亮，定制样式，自定义css，自定义js</a><a href="/tags/XMLHttpRequest/" style="font-size: 10.00px;">XMLHttpRequest</a><a href="/tags/ajax/" style="font-size: 10.00px;">ajax</a><a href="/tags/ajax登录/" style="font-size: 10.00px;">ajax登录</a><a href="/tags/angular-js/" style="font-size: 10.00px;">angular.js</a><a href="/tags/animate/" style="font-size: 10.00px;">animate</a><a href="/tags/api/" style="font-size: 10.00px;">api</a><a href="/tags/attribute/" style="font-size: 10.00px;">attribute</a><a href="/tags/backbone/" style="font-size: 10.00px;">backbone</a><a href="/tags/bad-gateway/" style="font-size: 10.00px;">bad gateway</a><a href="/tags/base64/" style="font-size: 10.00px;">base64</a><a href="/tags/bug/" style="font-size: 10.00px;">bug</a><a href="/tags/canvas/" style="font-size: 10.00px;">canvas</a><a href="/tags/canvas-图片/" style="font-size: 10.00px;">canvas 图片</a><a href="/tags/cdn/" style="font-size: 10.00px;">cdn</a><a href="/tags/checked-exception/" style="font-size: 10.00px;">checked exception</a>
    </div>
  </div>


</aside>
</div>
    </div>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>






<script>
     window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["qzone","tsina","weixin","renren","tqq","tieba","douban","sqq","diandian","huaban","youdao","mail","ty","fbook","twi","linkedin","copy","print"],"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"4","bdPos":"right","bdTop":"350"},"image":{"viewList":["weixin","qzone","tsina","renren","douban","tqq"],"viewText":"分享：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["weixin","qzone","tsina","renren","douban","tqq"]}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script>


<script type="text/javascript">
    var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
    var _bdId = '391982416296a0d54221f59fe35250d4';
    document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F" + _bdId +"'  type='text/javascript'%3E%3C/script%3E"));
</script>



<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'null', 'null');  
ga('send', 'pageview');
</script>


  </body>
</html>
