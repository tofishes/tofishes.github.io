
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>HTML5 XMLHttpRequest中的新功能 | 听雨~</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="ToFishes">
    
    <meta name="description" content="来源于：http://www.html5rocks.com/zh/tutorials/file/xhr2/
简介
HTML5 世界中有这样一位无名英雄：XMLHttpRequest。严格地说，XHR2 并不属于 HTML5。不过，它是浏览器供应商对于核心平台不断做出的改进中的一部分。我之所以将 XHR2 加入我们新的百宝囊中，就是因为它在如今复杂的网络应用中扮演了不可或缺的角色。
结果呢，我们这位老朋友来了个大变身，很多人都不知道它的新功能了。2 级 XMLHttpRequest 引入了大量的新功能（例如跨源请求、上传进度事件以及对上传/下载二进制数据的支持等），一举封杀了我们网络应用中的疯狂黑客。这使得 AJAX 可以与很多尖端的 HTML5 API 结合使用，例如 File System API、Web Audio API 和 WebGL。
此教程重点介绍 XMLHttpRequest 中的新功能，尤其是可用于处理文件的功能。
&amp;nbsp;
抓取数据
以前通过 XHR 抓取二进制 blob 形式的文件是很痛苦的事情。从技术上来说，这甚至是不可能的实现。有一种广为流传的一种技巧，是将 MIME 类型替换为由用户定义的字符集，如下所示：
提取图片的旧方法：
var xhr =newXMLHttpRequest();
xhr.open(&#39;GET&#39;,&#39;/path/to/image.png&#39;,true);// Hack to pass bytes through unprocessed.**xhr.overrideMimeType(&#39;text/plain; charset=x-user-defined&#39;);**

xhr.onreadystatechange =function(e){if(this.readyState ==4&amp;amp;&amp;amp;this.status ==200){var binStr =this.responseText;for(var i =0, len = binStr.length; i &amp;lt; len;++i){**var c = binStr.charCodeAt(i);****//String.fromCharCode(c &amp;amp; 0xff);****varbyte= c &amp;amp;0xff;// byte at offset i**}}};

xhr.send();
虽然这种方法可行，但是 `responseText` 中实际返回的并不是二进制 blob，而是代表图片文件的二进制字符串。我们要巧妙地让服务器在不作处理的情况下，将这些数据传递回去。虽然这个技巧有用，但是我不推荐大家走这种歪门邪道。只要是通过玩弄字符代码和字符串操控技巧，强行将数据转化成所需的格式，都会出现问题。

### 指定响应格式

在前一个示例中，我们通过替换服务器的 MIME 类型并将响应文本作为二进制字符串处理，下载了二进制“文件”形式的图片。现在，让我们利用 `XMLHttpRequest` 新增的 `responseType` 和 `response` 属性，告知浏览器我们希望返回什么格式的数据。

xhr.**responseType**在发送请求前，根据您的数据需要，将 `xhr.responseType` 设置为“text”、“arraybuffer”、“blob”或“document”。请注意，设置（或忽略）`xhr.responseType = &#39;&#39;` 会默认将响应设为“text”。xhr.**response**成功发送请求后，xhr 的响应属性会包含 `DOMString`、`ArrayBuffer`、`Blob` 或 `Document` 形式（具体取决于 `responseTyp ` 的设置）的请求数据。凭借这个优秀的新属性，我们可以修改上一个示例：以 `ArrayBuffer` 而非字符串的形式抓取图片。将缓冲区移交给 `BlobBuilder` API 可创建 `Blob`：
BlobBuilder= window.MozBlobBuilder|| window.WebKitBlobBuilder|| window.BlobBuilder;var xhr =newXMLHttpRequest();
xhr.open(&#39;GET&#39;,&#39;/path/to/image.png&#39;,true);**xhr.responseType =&#39;arraybuffer&#39;;****xhr.onload**=function(e){if(this.status ==200){var bb =newBlobBuilder();
    bb.append(**this.response**);// Note: not xhr.responseTextvar blob = bb.getBlob(&#39;image/png&#39;);...}};

xhr.send();
好多了！

#### ArrayBuffer 响应

[`ArrayBuffer`](https://developer.mozilla.org/en/JavaScript_typed_arrays/ArrayBuffer) 是二进制数据通用的固定长度容器。如果您需要原始数据的通用缓冲区，ArrayBuffer 就非常好用，但是它真正强大的功能是让您使用 [JavaScript 类型数组](https://developer.mozilla.org/en/JavaScript_typed_arrays)创建底层数据的“视图”。实际上，可以通过单个 `ArrayBuffer` 来源创建多个视图。例如，您可以创建一个 8 位整数数组，与来自相同数据的现有 32 位整数数组共享同一个 `ArrayBuffer`。底层数据保持不变，我们只是创建其不同的表示方法。

例如，下面以 `ArrayBuffer` 的形式抓取我们相同的图片，但是现在，会通过该数据缓冲区创建无符号的 8 位整数数组。
var xhr =newXMLHttpRequest();
xhr.open(&#39;GET&#39;,&#39;/path/to/image.png&#39;,true);**xhr.responseType =&#39;arraybuffer&#39;;****xhr.onload**=function(e){var uInt8Array =new**Uint8Array**(**this.response**);// this.response == uInt8Array.buffer// var byte3 = uInt8Array[4]; // byte at offset 4...};

xhr.send();

Blob 响应
如果您要直接处理 Blob 且/或不需要操作任何文件的字节，可使用 xhr.responseType=&amp;#39;blob&amp;#39;：
window.URL = window.URL || window.webkitURL;// Take care of vendor prefixes.var xhr =newXMLHttpRequest();
xhr.open(&#39;GET&#39;,&#39;/path/to/image.png&#39;,true);**xhr.responseType =&#39;blob&#39;;****xhr.onload**=function(e){if(this.status ==200){var blob =**this.response**;var img = document.createElement(&#39;img&#39;);
    img.onload =function(e){**window.URL.revokeObjectURL(img.src);**// Clean up after yourself.};
    img.src =**window.URL.createObjectURL(blob);**
    document.body.appendChild(img);...}};

xhr.send();
`Blob` 可用于很多场合，包括保存到 [indexedDB](/tutorials/indexeddb/todo/)、写入 HTML5 [文件系统](/tutorials/file/filesystem/) 或[创建 Blob 网址](/tutorials/workers/basics/#toc-inlineworkers-bloburis)（如本例中所示）。

## 发送数据

能够[下载各种格式的数据](#toc-response)固然是件好事，但是如果不能将这些丰富格式的数据送回本垒（服务器），那就毫无意义了。`XMLHttpRequest` 有时候会限制我们发送 `DOMString` 或 `Document` (XML) 数据。但是现在不会了。现已替换成经过修改的 `send()` 方法，可接受以下任何类型：`DOMString`、`Document`、`FormData`、`Blob`、`File`、`ArrayBuffer`。本部分的其余内容中的示例演示了如何使用各类型发送数据。

### 发送字符串数据：xhr.send(DOMString)

function sendText(txt){var xhr =newXMLHttpRequest();
  xhr.open(&#39;POST&#39;,&#39;/server&#39;,true);
  xhr.onload =function(e){if(this.status ==200){
      console.log(**this.responseText**);}};

  xhr.send(txt);}

sendText(**&#39;test string&#39;**);
function sendTextNew(txt){var xhr =newXMLHttpRequest();
  xhr.open(&#39;POST&#39;,&#39;/server&#39;,true);**xhr.responseType =&#39;text&#39;;**
  xhr.onload =function(e){if(this.status ==200){
      console.log(**this.response**);}};
  xhr.send(txt);}

sendText2(**&#39;test string&#39;**);
这没有新内容，只是正确的代码段略有不同。其中设置了 `responseType=&#39;text&#39;` 作为对比。再次说明，省略此行会得到同样的结果。

### 提交表单：xhr.send(FormData)

很多人可能习惯于使用 [jQuery 插件](http://jquery.malsup.com/form/)或其他库来处理 AJAX 表单提交。而我们可以改用 [`FormData`](https://developer.mozilla.org/en/XMLHttpRequest/FormData)，这是另一种针对 XHR2 设计的新数据类型。使用 `FormData` 能够很方便地实时以 JavaScript 创建 HTML `&amp;lt;form&amp;gt;`。然后可以使用 AJAX 提交该表单：
function sendForm(){var formData =new**FormData**();**formData.append**(&#39;username&#39;,&#39;johndoe&#39;);**formData.append**(&#39;id&#39;,123456);var xhr =newXMLHttpRequest();
  xhr.open(&#39;POST&#39;,&#39;/server&#39;,true);
  xhr.onload =function(e){...};

  xhr.send(**formData**);}
实质上，我们只是动态创建了 `&amp;lt;form&amp;gt;`，并通过调用 append 方法为其附加了 `&amp;lt;input&amp;gt;` 值。

当然，您无需从一开始就创建 `&amp;lt;form&amp;gt;`。`FormData` 对象可通过页面上现有的 `HTMLFormElement` 进行初始化。例如：
&amp;lt;formid=&quot;myform&quot;name=&quot;myform&quot;action=&quot;/server&quot;&amp;gt;&amp;lt;inputtype=&quot;text&quot;name=&quot;username&quot;value=&quot;johndoe&quot;&amp;gt;&amp;lt;inputtype=&quot;number&quot;name=&quot;id&quot;value=&quot;123456&quot;&amp;gt;&amp;lt;inputtype=&quot;submit&quot;onclick=&quot;**return sendForm(this.form);**&quot;&amp;gt;&amp;lt;/form&amp;gt;
function sendForm(form){var formData =new**FormData**(form);**formData.append**(&#39;secret_token&#39;,&#39;1234567890&#39;);// Append extra data before send.var xhr =newXMLHttpRequest();
  xhr.open(&#39;POST&#39;, form.action,true);
  xhr.onload =function(e){...};

  xhr.send(**formData**);returnfalse;// Prevent page from submitting.}
HTML 表单可包含文件上传（例如 `&amp;lt;input type=&quot;file&quot;&amp;gt;`），而 `FormData` 也可以处理此操作。只需附加文件，浏览器就会在调用 `send()` 时构建 `multipart/form-data` 请求。
function uploadFiles(url, files){var formData =new**FormData**();for(var i =0, file; file = files[i];++i){**formData.append(file.name, file);**}var xhr =newXMLHttpRequest();
  xhr.open(&#39;POST&#39;, url,true);
  xhr.onload =function(e){...};

  xhr.send(**formData**);// multipart/form-data}

document.querySelector(&#39;input[type=&quot;file&quot;]&#39;).addEventListener(&#39;change&#39;,function(e){
  uploadFiles(&#39;/server&#39;,this.files);},false);

上传文件或 blob：xhr.send(Blob)
我们也可以使用 XHR 发送 File 或 Blob。请注意，所有 File 都是 Blob，所以在此使用两者皆可。
该示例使用 BlobBuilder API 从头开始创建新的文本文件，并将该 Blob 上传到服务器。该代码还设置了一个处理程序，用于通知用户上传进度：
&amp;lt;progressmin=&quot;0&quot;max=&quot;100&quot;value=&quot;0&quot;&amp;gt;0% complete&amp;lt;/progress&amp;gt;
function upload(blobOrFile){var xhr =newXMLHttpRequest();
  xhr.open(&#39;POST&#39;,&#39;/server&#39;,true);
  xhr.onload =function(e){...};// Listen to the upload progress.var progressBar = document.querySelector(&#39;progress&#39;);**xhr.upload.onprogress**=function(e){if(e.lengthComputable){
      progressBar.value =(e.loaded / e.total)*100;
      progressBar.textContent = progressBar.value;// Fallback for unsupported browsers.}};

  xhr.send(**blobOrFile**);}// Take care of vendor prefixes.BlobBuilder= window.MozBlobBuilder|| window.WebKitBlobBuilder|| window.BlobBuilder;var bb =new**BlobBuilder**();**bb.append**(&#39;hello world&#39;);

upload(**bb.getBlob(&#39;text/plain&#39;)**);

上传字节：xhr.send(ArrayBuffer)
最后也是相当重要的一点就是，我们能以 XHR 的有效负载形式发送 ArrayBuffer。
function sendArrayBuffer(){var xhr =newXMLHttpRequest();
  xhr.open(&#39;POST&#39;,&#39;/server&#39;,true);
  xhr.onload =function(e){...};**var uInt8Array =new****Uint8Array**([1,2,3]);

  xhr.send(**uInt8Array.buffer**);}

跨源资源共享 (CORS)
CORS 允许一个域上的网络应用向另一个域提交跨域 AJAX 请求。启用此功能非常简单，只需由服务器发送一个响应标头即可。
启用 CORS 请求
假设您的应用已经在 example.com 上了，而您想要从 www.example2.com 提取数据。一般情况下，如果您尝试进行这种类型的 AJAX 调用，请求将会失败，而浏览器将会出现“源不匹配”的错误。利用 CORS，www.example2.com 只需添加一个标头，就可以允许来自 example.com 的请求：
Access-Control-Allow-Origin: http://example.com
可将 `Access-Control-Allow-Origin` 添加到某网站下或整个域中的单个资源。要允许任何域向您提交请求，请设置如下：
Access-Control-Allow-Origin:*****

其实，该网站 (html5rocks.com) 已在其所有网页上均启用了 CORS。启用开发人员工具后，您就会在我们的响应中看到 `Access-Control-Allow-Origin` 了：

![Access-Control-Allow-Origin header on html5rocks.com](access_control_header.png &quot;html5rocks.com 上的 Access-Control-Allow-Origin 标头&quot;)
html5rocks.com 上的 `Access-Control-Allow-Origin` 标头启用跨源请求是非常简单的，因此如果您的数据是公开的，请务必[启用 CORS](http://enable-cors.org/)！

### 提交跨域请求

如果服务器端已启用了 CORS，那么提交跨域请求就和普通的 `XMLHttpRequest` 请求没什么区别。例如，现在 `example.com` 可以向 `www.example2.com` 提交请求了：
var xhr =newXMLHttpRequest();
xhr.open(&#39;GET&#39;,&#39;http://www.example2.com/hello.json&#39;);
xhr.onload =function(e){var data = JSON.parse(**this.response**);...}
xhr.send();

实际示例：
下载文件并保存到 HTML5 文件系统
假设您有一个图片库，想要提取一些图片，然后使用 HTML5 文件系统本地保存这些图片。一种方法是以 ArrayBuffer 形式请求图片，通过数据构建 Blob，并使用 FileWriter 写入 blob：
window.requestFileSystem  = window.requestFileSystem || window.webkitRequestFileSystem;function onError(e){  console.log(‘Error’, e);}var xhr =newXMLHttpRequest();xhr.open(‘GET’,‘/path/to/image.png’,true);xhr.responseType =‘arraybuffer’;**xhr.onload=function(e){window.requestFileSystem*(TEMPORARY,10241024,function(fs){    fs.root.getFile(‘image.png’,{create:true},function(fileEntry){      fileEntry.createWriter(function(writer){
    writer&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;.&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pln&quot;&amp;gt;onwrite &amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;=&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;kwd&quot;&amp;gt;function&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;(&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pln&quot;&amp;gt;e&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;)&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;{&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;...&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;};&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pln&quot;&amp;gt;
    writer&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;.&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pln&quot;&amp;gt;onerror &amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;=&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;kwd&quot;&amp;gt;function&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;(&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pln&quot;&amp;gt;e&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;)&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;{&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;...&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;};&amp;lt;/span&amp;gt;**&amp;lt;span class=&quot;kwd&quot;&amp;gt;var&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pln&quot;&amp;gt; bb &amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;=&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;kwd&quot;&amp;gt;new&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;typ&quot;&amp;gt;BlobBuilder&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;();&amp;lt;/span&amp;gt;****&amp;lt;span class=&quot;pln&quot;&amp;gt;bb&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;.&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pln&quot;&amp;gt;append&amp;lt;/span&amp;gt;**&amp;lt;span class=&quot;pun&quot;&amp;gt;(&amp;lt;/span&amp;gt;**&amp;lt;span class=&quot;pln&quot;&amp;gt;xhr&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;.&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pln&quot;&amp;gt;response&amp;lt;/span&amp;gt;**&amp;lt;span class=&quot;pun&quot;&amp;gt;);&amp;lt;/span&amp;gt;**&amp;lt;span class=&quot;pln&quot;&amp;gt;writer&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;.&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pln&quot;&amp;gt;write&amp;lt;/span&amp;gt;**&amp;lt;span class=&quot;pun&quot;&amp;gt;(&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pln&quot;&amp;gt;bb&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;.&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pln&quot;&amp;gt;getBlob&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;(&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;str&quot;&amp;gt;&#39;image/png&#39;&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;));&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;},&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pln&quot;&amp;gt; onError&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;);&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;},&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pln&quot;&amp;gt; onError&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;);&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;},&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pln&quot;&amp;gt; onError&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;);&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;};&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pln&quot;&amp;gt;
xhr.send();请注意：要使用此代码，请参阅“探索 FileSystem API”教程中的浏览器支持和存储限制。
分割文件并上传各个部分
使用 File API，我们可以将操作简化为上传大文件。我们采用的技术是：将要上传的文件分割成多个部分，为每个部分生成一个 XHR，然后在服务器上将各部分组合成文件。这类似于 Gmail 快速上传大附件的方法。使用这种技术还可以规避 Google 应用引擎对 http 请求的 32 MB 限制。
window.BlobBuilder= window.MozBlobBuilder|| window.WebKitBlobBuilder||                     window.BlobBuilder;function upload(blobOrFile){var xhr =newXMLHttpRequest();  xhr.open(‘POST’,‘/server’,true);  xhr.onload =function(e){…};  xhr.send(blobOrFile);}
document.querySelector(‘input[type=”file”]’).addEventListener(‘change’,function(e){var blob =this.files[0];const BYTES_PER_CHUNK =1024*1024;// 1MB chunk sizes.const SIZE = blob.size;var start =0;varend= BYTES_PER_CHUNK;while(start &amp;lt; SIZE){// Note: blob.slice has changed semantics and been prefixed. See http://goo.gl/U9mE5.if(‘mozSlice’in blob){var chunk = blob.mozSlice(start,end);}else{var chunk = blob.webkitSlice(start,end);}
upload&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;(&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pln&quot;&amp;gt;chunk&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;);&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pln&quot;&amp;gt;

start &amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;=&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;kwd&quot;&amp;gt;end&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;;&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;kwd&quot;&amp;gt;end&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;=&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pln&quot;&amp;gt; start &amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;+&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pln&quot;&amp;gt; BYTES_PER_CHUNK&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;;&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;}&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;},&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;kwd&quot;&amp;gt;false&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;);&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;pun&quot;&amp;gt;})();&amp;lt;/span&amp;gt;&amp;lt;/pre&amp;gt;
用于在服务器上重组文件的代码并未在此显示。
赶快试试吧！
#bytes/chunk: 

参考

2 级 XMLHttpRequest 规范
跨源资源共享 (CORS) 规范
File API 规范
FileSystem API 规范">
    
    
    
    
    <link rel="alternate" href="atom.xml" title="听雨~" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">

     
</head>

  <body>
    <header>
      <div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="听雨~">听雨~</a></h1>
				<a class="blog-motto">昨夜卧听风吹雨，不若相忘于江湖。</a>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
					<li>
					
                                            <form class="search" action=http://search.baidu.com/cse/search target="_blank">
                                            <label>Search</label>
                                        <input name="s" type="hidden" value= null ><input type="text" name="q" size="30" placeholder="搜索"><br>
					
					</li>
				</ul>
                            </nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/06/20/html5-xmlhttprequest-new-features/" title="HTML5 XMLHttpRequest中的新功能" itemprop="url">HTML5 XMLHttpRequest中的新功能</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://umitime.com" title="[object Object]">[object Object]</a>
    </p>
  <p class="article-time">
    <time datetime="2014-06-20T07:57:35.000Z" itemprop="datePublished">6月 20 2014</time>
    更新日期:<time datetime="2014-10-15T10:58:07.000Z" itemprop="dateModified">10月 15 2014</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#简介"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#抓取数据"><span class="toc-number">2.</span> <span class="toc-text">抓取数据</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Blob_响应"><span class="toc-number">2.0.1.</span> <span class="toc-text">Blob 响应</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#上传文件或_blob：xhr-send(Blob)"><span class="toc-number">2.1.</span> <span class="toc-text">上传文件或 blob：xhr.send(Blob)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#上传字节：xhr-send(ArrayBuffer)"><span class="toc-number">2.2.</span> <span class="toc-text">上传字节：xhr.send(ArrayBuffer)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#跨源资源共享_(CORS)"><span class="toc-number">3.</span> <span class="toc-text">跨源资源共享 (CORS)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#启用_CORS_请求"><span class="toc-number">3.1.</span> <span class="toc-text">启用 CORS 请求</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实际示例："><span class="toc-number">4.</span> <span class="toc-text">实际示例：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#下载文件并保存到_HTML5_文件系统"><span class="toc-number">4.1.</span> <span class="toc-text">下载文件并保存到 HTML5 文件系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分割文件并上传各个部分"><span class="toc-number">4.2.</span> <span class="toc-text">分割文件并上传各个部分</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-number">5.</span> <span class="toc-text">参考</span></a></li></ol>
		</div>
		
		<p>来源于：<a href="http://www.html5rocks.com/zh/tutorials/file/xhr2/" target="_blank" rel="external">http://www.html5rocks.com/zh/tutorials/file/xhr2/</a></p>
<h2 id="简介">简介</h2>
<p>HTML5 世界中有这样一位无名英雄：<code>XMLHttpRequest</code>。严格地说，XHR2 并不属于 HTML5。不过，它是浏览器供应商对于核心平台不断做出的改进中的一部分。我之所以将 XHR2 加入我们新的百宝囊中，就是因为它在如今复杂的网络应用中扮演了不可或缺的角色。</p>
<p>结果呢，我们这位老朋友来了个大变身，很多人都不知道它的新功能了。<a href="http://dev.w3.org/2006/webapi/XMLHttpRequest-2/" target="_blank" rel="external">2 级 XMLHttpRequest</a> 引入了大量的新功能（例如跨源请求、上传进度事件以及对上传/下载二进制数据的支持等），一举封杀了我们网络应用中的疯狂黑客。这使得 AJAX 可以与很多尖端的 HTML5 API 结合使用，例如 <a href="/tutorials/file/filesystem/">File System API</a>、<a href="http://chromium.googlecode.com/svn/trunk/samples/audio/specification/specification.html" target="_blank" rel="external">Web Audio API</a> 和 WebGL。</p>
<p>此教程重点介绍 <code>XMLHttpRequest</code> 中的新功能，尤其是可用于<a href="/tutorials/file/dndfiles/">处理文件</a>的功能。<br><a id="more"></a></p>
<p>&nbsp;</p>
<h2 id="抓取数据">抓取数据</h2>
<p>以前通过 XHR 抓取二进制 blob 形式的文件是很痛苦的事情。从技术上来说，这甚至是不可能的实现。有一种广为流传的一种技巧，是将 MIME 类型替换为由用户定义的字符集，如下所示：</p>
<p>提取图片的旧方法：</p>
<pre class="prettyprint"><span class="kwd">var</span><span class="pln"> xhr </span><span class="pun">=</span><span class="kwd">new</span><span class="typ">XMLHttpRequest</span><span class="pun">();</span><span class="pln">
xhr</span><span class="pun">.</span><span class="pln">open</span><span class="pun">(</span><span class="str">'GET'</span><span class="pun">,</span><span class="str">'/path/to/image.png'</span><span class="pun">,</span><span class="kwd">true</span><span class="pun">);</span><span class="com">// Hack to pass bytes through unprocessed.</span>**<span class="pln">xhr</span><span class="pun">.</span><span class="pln">overrideMimeType</span><span class="pun">(</span><span class="str">'text/plain; charset=x-user-defined'</span><span class="pun">);</span>**<span class="pln">

xhr</span><span class="pun">.</span><span class="pln">onreadystatechange </span><span class="pun">=</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">e</span><span class="pun">)</span><span class="pun">{</span><span class="kwd">if</span><span class="pun">(</span><span class="kwd">this</span><span class="pun">.</span><span class="pln">readyState </span><span class="pun">==</span><span class="lit">4</span><span class="pun">&amp;&amp;</span><span class="kwd">this</span><span class="pun">.</span><span class="pln">status </span><span class="pun">==</span><span class="lit">200</span><span class="pun">)</span><span class="pun">{</span><span class="kwd">var</span><span class="pln"> binStr </span><span class="pun">=</span><span class="kwd">this</span><span class="pun">.</span><span class="pln">responseText</span><span class="pun">;</span><span class="kwd">for</span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> i </span><span class="pun">=</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> len </span><span class="pun">=</span><span class="pln"> binStr</span><span class="pun">.</span><span class="pln">length</span><span class="pun">;</span><span class="pln"> i </span><span class="pun">&lt;</span><span class="pln"> len</span><span class="pun">;</span><span class="pun">++</span><span class="pln">i</span><span class="pun">)</span><span class="pun">{</span>**<span class="kwd">var</span><span class="pln"> c </span><span class="pun">=</span><span class="pln"> binStr</span><span class="pun">.</span><span class="pln">charCodeAt</span><span class="pun">(</span><span class="pln">i</span><span class="pun">);</span>****<span class="com">//String.fromCharCode(c &amp; 0xff);</span>****<span class="kwd">var</span><span class="kwd">byte</span><span class="pun">=</span><span class="pln"> c </span><span class="pun">&amp;</span><span class="lit">0xff</span><span class="pun">;</span><span class="com">// byte at offset i</span>**<span class="pun">}</span><span class="pun">}</span><span class="pun">};</span><span class="pln">

xhr</span><span class="pun">.</span><span class="pln">send</span><span class="pun">();</span></pre>
虽然这种方法可行，但是 `responseText` 中实际返回的并不是二进制 blob，而是代表图片文件的二进制字符串。我们要巧妙地让服务器在不作处理的情况下，将这些数据传递回去。虽然这个技巧有用，但是我不推荐大家走这种歪门邪道。只要是通过玩弄字符代码和字符串操控技巧，强行将数据转化成所需的格式，都会出现问题。

### 指定响应格式

在前一个示例中，我们通过替换服务器的 MIME 类型并将响应文本作为二进制字符串处理，下载了二进制“文件”形式的图片。现在，让我们利用 `XMLHttpRequest` 新增的 `responseType` 和 `response` 属性，告知浏览器我们希望返回什么格式的数据。

<dl><dt>xhr.**responseType**</dt><dt></dt><dd>在发送请求前，根据您的数据需要，将 `xhr.responseType` 设置为“text”、“arraybuffer”、“blob”或“document”。请注意，设置（或忽略）`xhr.responseType = ''` 会默认将响应设为“text”。</dd><dt>xhr.**response**</dt><dd>成功发送请求后，xhr 的响应属性会包含 `DOMString`、`ArrayBuffer`、`Blob` 或 `Document` 形式（具体取决于 `responseTyp ` 的设置）的请求数据。</dd></dl>凭借这个优秀的新属性，我们可以修改上一个示例：以 `ArrayBuffer` 而非字符串的形式抓取图片。将缓冲区移交给 `BlobBuilder` API 可创建 `Blob`：
<pre class="prettyprint"><span class="typ">BlobBuilder</span><span class="pun">=</span><span class="pln"> window</span><span class="pun">.</span><span class="typ">MozBlobBuilder</span><span class="pun">||</span><span class="pln"> window</span><span class="pun">.</span><span class="typ">WebKitBlobBuilder</span><span class="pun">||</span><span class="pln"> window</span><span class="pun">.</span><span class="typ">BlobBuilder</span><span class="pun">;</span><span class="kwd">var</span><span class="pln"> xhr </span><span class="pun">=</span><span class="kwd">new</span><span class="typ">XMLHttpRequest</span><span class="pun">();</span><span class="pln">
xhr</span><span class="pun">.</span><span class="pln">open</span><span class="pun">(</span><span class="str">'GET'</span><span class="pun">,</span><span class="str">'/path/to/image.png'</span><span class="pun">,</span><span class="kwd">true</span><span class="pun">);</span>**<span class="pln">xhr</span><span class="pun">.</span><span class="pln">responseType </span><span class="pun">=</span><span class="str">'arraybuffer'</span><span class="pun">;</span>****<span class="pln">xhr</span><span class="pun">.</span><span class="pln">onload</span>**<span class="pun">=</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">e</span><span class="pun">)</span><span class="pun">{</span><span class="kwd">if</span><span class="pun">(</span><span class="kwd">this</span><span class="pun">.</span><span class="pln">status </span><span class="pun">==</span><span class="lit">200</span><span class="pun">)</span><span class="pun">{</span><span class="kwd">var</span><span class="pln"> bb </span><span class="pun">=</span><span class="kwd">new</span><span class="typ">BlobBuilder</span><span class="pun">();</span><span class="pln">
    bb</span><span class="pun">.</span><span class="pln">append</span><span class="pun">(</span>**<span class="kwd">this</span><span class="pun">.</span><span class="pln">response</span>**<span class="pun">);</span><span class="com">// Note: not xhr.responseText</span><span class="kwd">var</span><span class="pln"> blob </span><span class="pun">=</span><span class="pln"> bb</span><span class="pun">.</span><span class="pln">getBlob</span><span class="pun">(</span><span class="str">'image/png'</span><span class="pun">);</span><span class="pun">...</span><span class="pun">}</span><span class="pun">};</span><span class="pln">

xhr</span><span class="pun">.</span><span class="pln">send</span><span class="pun">();</span></pre>
好多了！

#### ArrayBuffer 响应

[`ArrayBuffer`](https://developer.mozilla.org/en/JavaScript_typed_arrays/ArrayBuffer) 是二进制数据通用的固定长度容器。如果您需要原始数据的通用缓冲区，ArrayBuffer 就非常好用，但是它真正强大的功能是让您使用 [JavaScript 类型数组](https://developer.mozilla.org/en/JavaScript_typed_arrays)创建底层数据的“视图”。实际上，可以通过单个 `ArrayBuffer` 来源创建多个视图。例如，您可以创建一个 8 位整数数组，与来自相同数据的现有 32 位整数数组共享同一个 `ArrayBuffer`。底层数据保持不变，我们只是创建其不同的表示方法。

例如，下面以 `ArrayBuffer` 的形式抓取我们相同的图片，但是现在，会通过该数据缓冲区创建无符号的 8 位整数数组。
<pre class="prettyprint"><span class="kwd">var</span><span class="pln"> xhr </span><span class="pun">=</span><span class="kwd">new</span><span class="typ">XMLHttpRequest</span><span class="pun">();</span><span class="pln">
xhr</span><span class="pun">.</span><span class="pln">open</span><span class="pun">(</span><span class="str">'GET'</span><span class="pun">,</span><span class="str">'/path/to/image.png'</span><span class="pun">,</span><span class="kwd">true</span><span class="pun">);</span>**<span class="pln">xhr</span><span class="pun">.</span><span class="pln">responseType </span><span class="pun">=</span><span class="str">'arraybuffer'</span><span class="pun">;</span>****<span class="pln">xhr</span><span class="pun">.</span><span class="pln">onload</span>**<span class="pun">=</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">e</span><span class="pun">)</span><span class="pun">{</span><span class="kwd">var</span><span class="pln"> uInt8Array </span><span class="pun">=</span><span class="kwd">new</span>**<span class="typ">Uint8Array</span>**<span class="pun">(</span>**<span class="kwd">this</span><span class="pun">.</span><span class="pln">response</span>**<span class="pun">);</span><span class="com">// this.response == uInt8Array.buffer</span><span class="com">// var byte3 = uInt8Array[4]; // byte at offset 4</span><span class="pun">...</span><span class="pun">};</span><span class="pln">

xhr</span><span class="pun">.</span><span class="pln">send</span><span class="pun">();</span></pre>

<h4 id="Blob_响应">Blob 响应</h4>
<p>如果您要直接处理 <a href="https://developer.mozilla.org/en/DOM/Blob" target="_blank" rel="external"><code>Blob</code></a> 且/或不需要操作任何文件的字节，可使用 <code>xhr.responseType=&#39;blob&#39;</code>：</p>
<pre class="prettyprint"><span class="pln">window</span><span class="pun">.</span><span class="pln">URL </span><span class="pun">=</span><span class="pln"> window</span><span class="pun">.</span><span class="pln">URL </span><span class="pun">||</span><span class="pln"> window</span><span class="pun">.</span><span class="pln">webkitURL</span><span class="pun">;</span><span class="com">// Take care of vendor prefixes.</span><span class="kwd">var</span><span class="pln"> xhr </span><span class="pun">=</span><span class="kwd">new</span><span class="typ">XMLHttpRequest</span><span class="pun">();</span><span class="pln">
xhr</span><span class="pun">.</span><span class="pln">open</span><span class="pun">(</span><span class="str">'GET'</span><span class="pun">,</span><span class="str">'/path/to/image.png'</span><span class="pun">,</span><span class="kwd">true</span><span class="pun">);</span>**<span class="pln">xhr</span><span class="pun">.</span><span class="pln">responseType </span><span class="pun">=</span><span class="str">'blob'</span><span class="pun">;</span>****<span class="pln">xhr</span><span class="pun">.</span><span class="pln">onload</span>**<span class="pun">=</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">e</span><span class="pun">)</span><span class="pun">{</span><span class="kwd">if</span><span class="pun">(</span><span class="kwd">this</span><span class="pun">.</span><span class="pln">status </span><span class="pun">==</span><span class="lit">200</span><span class="pun">)</span><span class="pun">{</span><span class="kwd">var</span><span class="pln"> blob </span><span class="pun">=</span>**<span class="kwd">this</span><span class="pun">.</span><span class="pln">response</span>**<span class="pun">;</span><span class="kwd">var</span><span class="pln"> img </span><span class="pun">=</span><span class="pln"> document</span><span class="pun">.</span><span class="pln">createElement</span><span class="pun">(</span><span class="str">'img'</span><span class="pun">);</span><span class="pln">
    img</span><span class="pun">.</span><span class="pln">onload </span><span class="pun">=</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">e</span><span class="pun">)</span><span class="pun">{</span>**<span class="pln">window</span><span class="pun">.</span><span class="pln">URL</span><span class="pun">.</span><span class="pln">revokeObjectURL</span><span class="pun">(</span><span class="pln">img</span><span class="pun">.</span><span class="pln">src</span><span class="pun">);</span>**<span class="com">// Clean up after yourself.</span><span class="pun">};</span><span class="pln">
    img</span><span class="pun">.</span><span class="pln">src </span><span class="pun">=</span>**<span class="pln">window</span><span class="pun">.</span><span class="pln">URL</span><span class="pun">.</span><span class="pln">createObjectURL</span><span class="pun">(</span><span class="pln">blob</span><span class="pun">);</span>**<span class="pln">
    document</span><span class="pun">.</span><span class="pln">body</span><span class="pun">.</span><span class="pln">appendChild</span><span class="pun">(</span><span class="pln">img</span><span class="pun">);</span><span class="pun">...</span><span class="pun">}</span><span class="pun">};</span><span class="pln">

xhr</span><span class="pun">.</span><span class="pln">send</span><span class="pun">();</span></pre>
`Blob` 可用于很多场合，包括保存到 [indexedDB](/tutorials/indexeddb/todo/)、写入 HTML5 [文件系统](/tutorials/file/filesystem/) 或[创建 Blob 网址](/tutorials/workers/basics/#toc-inlineworkers-bloburis)（如本例中所示）。

## 发送数据

能够[下载各种格式的数据](#toc-response)固然是件好事，但是如果不能将这些丰富格式的数据送回本垒（服务器），那就毫无意义了。`XMLHttpRequest` 有时候会限制我们发送 `DOMString` 或 `Document` (XML) 数据。但是现在不会了。现已替换成经过修改的 `send()` 方法，可接受以下任何类型：`DOMString`、`Document`、`FormData`、`Blob`、`File`、`ArrayBuffer`。本部分的其余内容中的示例演示了如何使用各类型发送数据。

### 发送字符串数据：xhr.send(DOMString)

<pre class="prettyprint" style="display: inline-block; margin-right: 10px; vertical-align: top;"><span class="kwd">function</span><span class="pln"> sendText</span><span class="pun">(</span><span class="pln">txt</span><span class="pun">)</span><span class="pun">{</span><span class="kwd">var</span><span class="pln"> xhr </span><span class="pun">=</span><span class="kwd">new</span><span class="typ">XMLHttpRequest</span><span class="pun">();</span><span class="pln">
  xhr</span><span class="pun">.</span><span class="pln">open</span><span class="pun">(</span><span class="str">'POST'</span><span class="pun">,</span><span class="str">'/server'</span><span class="pun">,</span><span class="kwd">true</span><span class="pun">);</span><span class="pln">
  xhr</span><span class="pun">.</span><span class="pln">onload </span><span class="pun">=</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">e</span><span class="pun">)</span><span class="pun">{</span><span class="kwd">if</span><span class="pun">(</span><span class="kwd">this</span><span class="pun">.</span><span class="pln">status </span><span class="pun">==</span><span class="lit">200</span><span class="pun">)</span><span class="pun">{</span><span class="pln">
      console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span>**<span class="kwd">this</span><span class="pun">.</span><span class="pln">responseText</span>**<span class="pun">);</span><span class="pun">}</span><span class="pun">};</span><span class="pln">

  xhr</span><span class="pun">.</span><span class="pln">send</span><span class="pun">(</span><span class="pln">txt</span><span class="pun">);</span><span class="pun">}</span><span class="pln">

sendText</span><span class="pun">(</span>**<span class="str">'test string'</span>**<span class="pun">);</span></pre>
<pre class="prettyprint" style="display: inline-block;"><span class="kwd">function</span><span class="pln"> sendTextNew</span><span class="pun">(</span><span class="pln">txt</span><span class="pun">)</span><span class="pun">{</span><span class="kwd">var</span><span class="pln"> xhr </span><span class="pun">=</span><span class="kwd">new</span><span class="typ">XMLHttpRequest</span><span class="pun">();</span><span class="pln">
  xhr</span><span class="pun">.</span><span class="pln">open</span><span class="pun">(</span><span class="str">'POST'</span><span class="pun">,</span><span class="str">'/server'</span><span class="pun">,</span><span class="kwd">true</span><span class="pun">);</span>**<span class="pln">xhr</span><span class="pun">.</span><span class="pln">responseType </span><span class="pun">=</span><span class="str">'text'</span><span class="pun">;</span>**<span class="pln">
  xhr</span><span class="pun">.</span><span class="pln">onload </span><span class="pun">=</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">e</span><span class="pun">)</span><span class="pun">{</span><span class="kwd">if</span><span class="pun">(</span><span class="kwd">this</span><span class="pun">.</span><span class="pln">status </span><span class="pun">==</span><span class="lit">200</span><span class="pun">)</span><span class="pun">{</span><span class="pln">
      console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span>**<span class="kwd">this</span><span class="pun">.</span><span class="pln">response</span>**<span class="pun">);</span><span class="pun">}</span><span class="pun">};</span><span class="pln">
  xhr</span><span class="pun">.</span><span class="pln">send</span><span class="pun">(</span><span class="pln">txt</span><span class="pun">);</span><span class="pun">}</span><span class="pln">

sendText2</span><span class="pun">(</span>**<span class="str">'test string'</span>**<span class="pun">);</span></pre>
这没有新内容，只是正确的代码段略有不同。其中设置了 `responseType='text'` 作为对比。再次说明，省略此行会得到同样的结果。

### 提交表单：xhr.send(FormData)

很多人可能习惯于使用 [jQuery 插件](http://jquery.malsup.com/form/)或其他库来处理 AJAX 表单提交。而我们可以改用 [`FormData`](https://developer.mozilla.org/en/XMLHttpRequest/FormData)，这是另一种针对 XHR2 设计的新数据类型。使用 `FormData` 能够很方便地实时以 JavaScript 创建 HTML `&lt;form&gt;`。然后可以使用 AJAX 提交该表单：
<pre class="prettyprint"><span class="kwd">function</span><span class="pln"> sendForm</span><span class="pun">()</span><span class="pun">{</span><span class="kwd">var</span><span class="pln"> formData </span><span class="pun">=</span><span class="kwd">new</span>**<span class="typ">FormData</span>**<span class="pun">();</span>**<span class="pln">formData</span><span class="pun">.</span><span class="pln">append</span>**<span class="pun">(</span><span class="str">'username'</span><span class="pun">,</span><span class="str">'johndoe'</span><span class="pun">);</span>**<span class="pln">formData</span><span class="pun">.</span><span class="pln">append</span>**<span class="pun">(</span><span class="str">'id'</span><span class="pun">,</span><span class="lit">123456</span><span class="pun">);</span><span class="kwd">var</span><span class="pln"> xhr </span><span class="pun">=</span><span class="kwd">new</span><span class="typ">XMLHttpRequest</span><span class="pun">();</span><span class="pln">
  xhr</span><span class="pun">.</span><span class="pln">open</span><span class="pun">(</span><span class="str">'POST'</span><span class="pun">,</span><span class="str">'/server'</span><span class="pun">,</span><span class="kwd">true</span><span class="pun">);</span><span class="pln">
  xhr</span><span class="pun">.</span><span class="pln">onload </span><span class="pun">=</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">e</span><span class="pun">)</span><span class="pun">{</span><span class="pun">...</span><span class="pun">};</span><span class="pln">

  xhr</span><span class="pun">.</span><span class="pln">send</span><span class="pun">(</span>**<span class="pln">formData</span>**<span class="pun">);</span><span class="pun">}</span></pre>
实质上，我们只是动态创建了 `&lt;form&gt;`，并通过调用 append 方法为其附加了 `&lt;input&gt;` 值。

当然，您无需从一开始就创建 `&lt;form&gt;`。`FormData` 对象可通过页面上现有的 `HTMLFormElement` 进行初始化。例如：
<pre class="prettyprint"><span class="tag">&lt;form</span><span class="atn">id</span><span class="pun">=</span><span class="atv">"myform"</span><span class="atn">name</span><span class="pun">=</span><span class="atv">"myform"</span><span class="atn">action</span><span class="pun">=</span><span class="atv">"/server"</span><span class="tag">&gt;</span><span class="tag">&lt;input</span><span class="atn">type</span><span class="pun">=</span><span class="atv">"text"</span><span class="atn">name</span><span class="pun">=</span><span class="atv">"username"</span><span class="atn">value</span><span class="pun">=</span><span class="atv">"johndoe"</span><span class="tag">&gt;</span><span class="tag">&lt;input</span><span class="atn">type</span><span class="pun">=</span><span class="atv">"number"</span><span class="atn">name</span><span class="pun">=</span><span class="atv">"id"</span><span class="atn">value</span><span class="pun">=</span><span class="atv">"123456"</span><span class="tag">&gt;</span><span class="tag">&lt;input</span><span class="atn">type</span><span class="pun">=</span><span class="atv">"submit"</span><span class="atn">onclick</span><span class="pun">=</span><span class="atv">"</span>**<span class="kwd">return</span><span class="pln"> sendForm</span><span class="pun">(</span><span class="kwd">this</span><span class="pun">.</span><span class="pln">form</span><span class="pun">);</span>**<span class="atv">"</span><span class="tag">&gt;</span><span class="tag">&lt;/form&gt;</span></pre>
<pre class="prettyprint"><span class="kwd">function</span><span class="pln"> sendForm</span><span class="pun">(</span><span class="pln">form</span><span class="pun">)</span><span class="pun">{</span><span class="kwd">var</span><span class="pln"> formData </span><span class="pun">=</span><span class="kwd">new</span>**<span class="typ">FormData</span>**<span class="pun">(</span><span class="pln">form</span><span class="pun">);</span>**<span class="pln">formData</span><span class="pun">.</span><span class="pln">append</span>**<span class="pun">(</span><span class="str">'secret_token'</span><span class="pun">,</span><span class="str">'1234567890'</span><span class="pun">);</span><span class="com">// Append extra data before send.</span><span class="kwd">var</span><span class="pln"> xhr </span><span class="pun">=</span><span class="kwd">new</span><span class="typ">XMLHttpRequest</span><span class="pun">();</span><span class="pln">
  xhr</span><span class="pun">.</span><span class="pln">open</span><span class="pun">(</span><span class="str">'POST'</span><span class="pun">,</span><span class="pln"> form</span><span class="pun">.</span><span class="pln">action</span><span class="pun">,</span><span class="kwd">true</span><span class="pun">);</span><span class="pln">
  xhr</span><span class="pun">.</span><span class="pln">onload </span><span class="pun">=</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">e</span><span class="pun">)</span><span class="pun">{</span><span class="pun">...</span><span class="pun">};</span><span class="pln">

  xhr</span><span class="pun">.</span><span class="pln">send</span><span class="pun">(</span>**<span class="pln">formData</span>**<span class="pun">);</span><span class="kwd">return</span><span class="kwd">false</span><span class="pun">;</span><span class="com">// Prevent page from submitting.</span><span class="pun">}</span></pre>
HTML 表单可包含文件上传（例如 `&lt;input type="file"&gt;`），而 `FormData` 也可以处理此操作。只需附加文件，浏览器就会在调用 `send()` 时构建 `multipart/form-data` 请求。
<pre class="prettyprint"><span class="kwd">function</span><span class="pln"> uploadFiles</span><span class="pun">(</span><span class="pln">url</span><span class="pun">,</span><span class="pln"> files</span><span class="pun">)</span><span class="pun">{</span><span class="kwd">var</span><span class="pln"> formData </span><span class="pun">=</span><span class="kwd">new</span>**<span class="typ">FormData</span>**<span class="pun">();</span><span class="kwd">for</span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> i </span><span class="pun">=</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> file</span><span class="pun">;</span><span class="pln"> file </span><span class="pun">=</span><span class="pln"> files</span><span class="pun">[</span><span class="pln">i</span><span class="pun">];</span><span class="pun">++</span><span class="pln">i</span><span class="pun">)</span><span class="pun">{</span>**<span class="pln">formData</span><span class="pun">.</span><span class="pln">append</span><span class="pun">(</span><span class="pln">file</span><span class="pun">.</span><span class="pln">name</span><span class="pun">,</span><span class="pln"> file</span><span class="pun">);</span>**<span class="pun">}</span><span class="kwd">var</span><span class="pln"> xhr </span><span class="pun">=</span><span class="kwd">new</span><span class="typ">XMLHttpRequest</span><span class="pun">();</span><span class="pln">
  xhr</span><span class="pun">.</span><span class="pln">open</span><span class="pun">(</span><span class="str">'POST'</span><span class="pun">,</span><span class="pln"> url</span><span class="pun">,</span><span class="kwd">true</span><span class="pun">);</span><span class="pln">
  xhr</span><span class="pun">.</span><span class="pln">onload </span><span class="pun">=</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">e</span><span class="pun">)</span><span class="pun">{</span><span class="pun">...</span><span class="pun">};</span><span class="pln">

  xhr</span><span class="pun">.</span><span class="pln">send</span><span class="pun">(</span>**<span class="pln">formData</span>**<span class="pun">);</span><span class="com">// multipart/form-data</span><span class="pun">}</span><span class="pln">

document</span><span class="pun">.</span><span class="pln">querySelector</span><span class="pun">(</span><span class="str">'input[type="file"]'</span><span class="pun">).</span><span class="pln">addEventListener</span><span class="pun">(</span><span class="str">'change'</span><span class="pun">,</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">e</span><span class="pun">)</span><span class="pun">{</span><span class="pln">
  uploadFiles</span><span class="pun">(</span><span class="str">'/server'</span><span class="pun">,</span><span class="kwd">this</span><span class="pun">.</span><span class="pln">files</span><span class="pun">);</span><span class="pun">},</span><span class="kwd">false</span><span class="pun">);</span></pre>

<h3 id="上传文件或_blob：xhr-send(Blob)">上传文件或 blob：xhr.send(Blob)</h3>
<p>我们也可以使用 XHR 发送 <code>File</code> 或 <code>Blob</code>。请注意，所有 <code>File</code> 都是 <code>Blob</code>，所以在此使用两者皆可。</p>
<p>该示例使用 <code>BlobBuilder</code> API 从头开始创建新的文本文件，并将该 <code>Blob</code> 上传到服务器。该代码还设置了一个处理程序，用于通知用户上传进度：</p>
<pre class="prettyprint"><span class="tag">&lt;progress</span><span class="atn">min</span><span class="pun">=</span><span class="atv">"0"</span><span class="atn">max</span><span class="pun">=</span><span class="atv">"100"</span><span class="atn">value</span><span class="pun">=</span><span class="atv">"0"</span><span class="tag">&gt;</span><span class="pln">0% complete</span><span class="tag">&lt;/progress&gt;</span></pre>
<pre class="prettyprint"><span class="kwd">function</span><span class="pln"> upload</span><span class="pun">(</span><span class="pln">blobOrFile</span><span class="pun">)</span><span class="pun">{</span><span class="kwd">var</span><span class="pln"> xhr </span><span class="pun">=</span><span class="kwd">new</span><span class="typ">XMLHttpRequest</span><span class="pun">();</span><span class="pln">
  xhr</span><span class="pun">.</span><span class="pln">open</span><span class="pun">(</span><span class="str">'POST'</span><span class="pun">,</span><span class="str">'/server'</span><span class="pun">,</span><span class="kwd">true</span><span class="pun">);</span><span class="pln">
  xhr</span><span class="pun">.</span><span class="pln">onload </span><span class="pun">=</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">e</span><span class="pun">)</span><span class="pun">{</span><span class="pun">...</span><span class="pun">};</span><span class="com">// Listen to the upload progress.</span><span class="kwd">var</span><span class="pln"> progressBar </span><span class="pun">=</span><span class="pln"> document</span><span class="pun">.</span><span class="pln">querySelector</span><span class="pun">(</span><span class="str">'progress'</span><span class="pun">);</span>**<span class="pln">xhr</span><span class="pun">.</span><span class="pln">upload</span><span class="pun">.</span><span class="pln">onprogress</span>**<span class="pun">=</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">e</span><span class="pun">)</span><span class="pun">{</span><span class="kwd">if</span><span class="pun">(</span><span class="pln">e</span><span class="pun">.</span><span class="pln">lengthComputable</span><span class="pun">)</span><span class="pun">{</span><span class="pln">
      progressBar</span><span class="pun">.</span><span class="pln">value </span><span class="pun">=</span><span class="pun">(</span><span class="pln">e</span><span class="pun">.</span><span class="pln">loaded </span><span class="pun">/</span><span class="pln"> e</span><span class="pun">.</span><span class="pln">total</span><span class="pun">)</span><span class="pun">*</span><span class="lit">100</span><span class="pun">;</span><span class="pln">
      progressBar</span><span class="pun">.</span><span class="pln">textContent </span><span class="pun">=</span><span class="pln"> progressBar</span><span class="pun">.</span><span class="pln">value</span><span class="pun">;</span><span class="com">// Fallback for unsupported browsers.</span><span class="pun">}</span><span class="pun">};</span><span class="pln">

  xhr</span><span class="pun">.</span><span class="pln">send</span><span class="pun">(</span>**<span class="pln">blobOrFile</span>**<span class="pun">);</span><span class="pun">}</span><span class="com">// Take care of vendor prefixes.</span><span class="typ">BlobBuilder</span><span class="pun">=</span><span class="pln"> window</span><span class="pun">.</span><span class="typ">MozBlobBuilder</span><span class="pun">||</span><span class="pln"> window</span><span class="pun">.</span><span class="typ">WebKitBlobBuilder</span><span class="pun">||</span><span class="pln"> window</span><span class="pun">.</span><span class="typ">BlobBuilder</span><span class="pun">;</span><span class="kwd">var</span><span class="pln"> bb </span><span class="pun">=</span><span class="kwd">new</span>**<span class="typ">BlobBuilder</span>**<span class="pun">();</span>**<span class="pln">bb</span><span class="pun">.</span><span class="pln">append</span>**<span class="pun">(</span><span class="str">'hello world'</span><span class="pun">);</span><span class="pln">

upload</span><span class="pun">(</span>**<span class="pln">bb</span><span class="pun">.</span><span class="pln">getBlob</span><span class="pun">(</span><span class="str">'text/plain'</span><span class="pun">)</span>**<span class="pun">);</span></pre>

<h3 id="上传字节：xhr-send(ArrayBuffer)">上传字节：xhr.send(ArrayBuffer)</h3>
<p>最后也是相当重要的一点就是，我们能以 XHR 的有效负载形式发送 <code>ArrayBuffer</code>。</p>
<pre class="prettyprint"><span class="kwd">function</span><span class="pln"> sendArrayBuffer</span><span class="pun">()</span><span class="pun">{</span><span class="kwd">var</span><span class="pln"> xhr </span><span class="pun">=</span><span class="kwd">new</span><span class="typ">XMLHttpRequest</span><span class="pun">();</span><span class="pln">
  xhr</span><span class="pun">.</span><span class="pln">open</span><span class="pun">(</span><span class="str">'POST'</span><span class="pun">,</span><span class="str">'/server'</span><span class="pun">,</span><span class="kwd">true</span><span class="pun">);</span><span class="pln">
  xhr</span><span class="pun">.</span><span class="pln">onload </span><span class="pun">=</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">e</span><span class="pun">)</span><span class="pun">{</span><span class="pun">...</span><span class="pun">};</span>**<span class="kwd">var</span><span class="pln"> uInt8Array </span><span class="pun">=</span><span class="kwd">new</span>****<span class="typ">Uint8Array</span>**<span class="pun">([</span><span class="lit">1</span><span class="pun">,</span><span class="lit">2</span><span class="pun">,</span><span class="lit">3</span><span class="pun">]);</span><span class="pln">

  xhr</span><span class="pun">.</span><span class="pln">send</span><span class="pun">(</span>**<span class="pln">uInt8Array</span><span class="pun">.</span><span class="pln">buffer</span>**<span class="pun">);</span><span class="pun">}</span></pre>

<h2 id="跨源资源共享_(CORS)">跨源资源共享 (CORS)</h2>
<p><a href="http://dev.w3.org/2006/waf/access-control/" target="_blank" rel="external">CORS</a> 允许一个域上的网络应用向另一个域提交跨域 AJAX 请求。启用此功能非常简单，只需由服务器发送一个响应标头即可。</p>
<h3 id="启用_CORS_请求">启用 CORS 请求</h3>
<p>假设您的应用已经在 <code>example.com</code> 上了，而您想要从 <code>www.example2.com</code> 提取数据。一般情况下，如果您尝试进行这种类型的 AJAX 调用，请求将会失败，而浏览器将会出现“源不匹配”的错误。利用 CORS，<code>www.example2.com</code> 只需添加一个标头，就可以允许来自 <code>example.com</code> 的请求：</p>
<pre class="prettyprint"><span class="typ">Access</span><span class="pun">-</span><span class="typ">Control</span><span class="pun">-</span><span class="typ">Allow</span><span class="pun">-</span><span class="typ">Origin</span><span class="pun">:</span><span class="pln"> http</span><span class="pun">:</span><span class="com">//example.com</span></pre>
可将 `Access-Control-Allow-Origin` 添加到某网站下或整个域中的单个资源。要允许任何域向您提交请求，请设置如下：
<pre class="prettyprint"><span class="typ">Access</span><span class="pun">-</span><span class="typ">Control</span><span class="pun">-</span><span class="typ">Allow</span><span class="pun">-</span><span class="typ">Origin</span><span class="pun">:</span>**<span class="pun">*</span>**
</pre>
其实，该网站 (html5rocks.com) 已在其所有网页上均启用了 CORS。启用开发人员工具后，您就会在我们的响应中看到 `Access-Control-Allow-Origin` 了：

<figure>![Access-Control-Allow-Origin header on html5rocks.com](access_control_header.png "html5rocks.com 上的 Access-Control-Allow-Origin 标头")
<figcaption>html5rocks.com 上的 `Access-Control-Allow-Origin` 标头</figcaption></figure>启用跨源请求是非常简单的，因此如果您的数据是公开的，请务必[启用 CORS](http://enable-cors.org/)！

### 提交跨域请求

如果服务器端已启用了 CORS，那么提交跨域请求就和普通的 `XMLHttpRequest` 请求没什么区别。例如，现在 `example.com` 可以向 `www.example2.com` 提交请求了：
<pre class="prettyprint"><span class="kwd">var</span><span class="pln"> xhr </span><span class="pun">=</span><span class="kwd">new</span><span class="typ">XMLHttpRequest</span><span class="pun">();</span><span class="pln">
xhr</span><span class="pun">.</span><span class="pln">open</span><span class="pun">(</span><span class="str">'GET'</span><span class="pun">,</span><span class="str">'http://www.example2.com/hello.json'</span><span class="pun">);</span><span class="pln">
xhr</span><span class="pun">.</span><span class="pln">onload </span><span class="pun">=</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">e</span><span class="pun">)</span><span class="pun">{</span><span class="kwd">var</span><span class="pln"> data </span><span class="pun">=</span><span class="pln"> JSON</span><span class="pun">.</span><span class="pln">parse</span><span class="pun">(</span>**<span class="kwd">this</span><span class="pun">.</span><span class="pln">response</span>**<span class="pun">);</span><span class="pun">...</span><span class="pun">}</span><span class="pln">
xhr</span><span class="pun">.</span><span class="pln">send</span><span class="pun">();</span></pre>

<h2 id="实际示例：">实际示例：</h2>
<h3 id="下载文件并保存到_HTML5_文件系统">下载文件并保存到 HTML5 文件系统</h3>
<p>假设您有一个图片库，想要提取一些图片，然后使用 <a href="/tutorials/file/filesystem/">HTML5 文件系统</a>本地保存这些图片。一种方法是以 <code>ArrayBuffer</code> 形式请求图片，通过数据构建 <code>Blob</code>，并使用 <code>FileWriter</code> 写入 blob：</p>
<p><pre class="prettyprint"><span class="pln">window</span><span class="pun">.</span><span class="pln">requestFileSystem  </span><span class="pun">=</span><span class="pln"> window</span><span class="pun">.</span><span class="pln">requestFileSystem </span><span class="pun">||</span><span class="pln"> window</span><span class="pun">.</span><span class="pln">webkitRequestFileSystem</span><span class="pun">;</span><span class="kwd">function</span><span class="pln"> onError</span><span class="pun">(</span><span class="pln">e</span><span class="pun">)</span><span class="pun">{</span><span class="pln"><br>  console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="str">‘Error’</span><span class="pun">,</span><span class="pln"> e</span><span class="pun">);</span><span class="pun">}</span><span class="kwd">var</span><span class="pln"> xhr </span><span class="pun">=</span><span class="kwd">new</span><span class="typ">XMLHttpRequest</span><span class="pun">();</span><span class="pln"><br>xhr</span><span class="pun">.</span><span class="pln">open</span><span class="pun">(</span><span class="str">‘GET’</span><span class="pun">,</span><span class="str">‘/path/to/image.png’</span><span class="pun">,</span><span class="kwd">true</span><span class="pun">);</span><strong><span class="pln">xhr</span><span class="pun">.</span><span class="pln">responseType </span><span class="pun">=</span><span class="str">‘arraybuffer’</span><span class="pun">;</span>**</strong><span class="pln">xhr</span><span class="pun">.</span><span class="pln">onload</span><strong><span class="pun">=</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">e</span><span class="pun">)</span><span class="pun">{</span></strong><span class="pln">window</span><span class="pun">.</span><span class="pln">requestFileSystem</span><em>*<span class="pun">(</span><span class="pln">TEMPORARY</span><span class="pun">,</span><span class="lit">1024</span><span class="pun"></span></em><span class="lit">1024</span><span class="pun">,</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">fs</span><span class="pun">)</span><span class="pun">{</span><span class="pln"><br>    fs</span><span class="pun">.</span><span class="pln">root</span><span class="pun">.</span><span class="pln">getFile</span><span class="pun">(</span><span class="str">‘image.png’</span><span class="pun">,</span><span class="pun">{</span><span class="pln">create</span><span class="pun">:</span><span class="kwd">true</span><span class="pun">},</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">fileEntry</span><span class="pun">)</span><span class="pun">{</span><span class="pln"><br>      fileEntry</span><span class="pun">.</span><span class="pln">createWriter</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">writer</span><span class="pun">)</span><span class="pun">{</span><span class="pln"></span></pre></p>
<pre><code>    writer<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>.<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pln"</span>&gt;</span>onwrite <span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>=<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"kwd"</span>&gt;</span>function<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>(<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pln"</span>&gt;</span>e<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>)<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>{<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>...<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>};<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pln"</span>&gt;</span>
    writer<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>.<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pln"</span>&gt;</span>onerror <span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>=<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"kwd"</span>&gt;</span>function<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>(<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pln"</span>&gt;</span>e<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>)<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>{<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>...<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>};<span class="tag">&lt;/<span class="title">span</span>&gt;</span>**<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"kwd"</span>&gt;</span>var<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pln"</span>&gt;</span> bb <span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>=<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"kwd"</span>&gt;</span>new<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"typ"</span>&gt;</span>BlobBuilder<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>();<span class="tag">&lt;/<span class="title">span</span>&gt;</span>****<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pln"</span>&gt;</span>bb<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>.<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pln"</span>&gt;</span>append<span class="tag">&lt;/<span class="title">span</span>&gt;</span>**<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>(<span class="tag">&lt;/<span class="title">span</span>&gt;</span>**<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pln"</span>&gt;</span>xhr<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>.<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pln"</span>&gt;</span>response<span class="tag">&lt;/<span class="title">span</span>&gt;</span>**<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>);<span class="tag">&lt;/<span class="title">span</span>&gt;</span>**<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pln"</span>&gt;</span>writer<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>.<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pln"</span>&gt;</span>write<span class="tag">&lt;/<span class="title">span</span>&gt;</span>**<span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>(<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pln"</span>&gt;</span>bb<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>.<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pln"</span>&gt;</span>getBlob<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>(<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"str"</span>&gt;</span>'image/png'<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>));<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>},<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pln"</span>&gt;</span> onError<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>);<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>},<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pln"</span>&gt;</span> onError<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>);<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>},<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pln"</span>&gt;</span> onError<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>);<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>};<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pln"</span>&gt;</span>
</code></pre><p>xhr<span class="pun">.</span><span class="pln">send</span><span class="pun">();</span><br><strong>请注意</strong>：要使用此代码，请参阅“<a href="/tutorials/file/filesystem/">探索 FileSystem API</a>”教程中的<a href="/tutorials/file/filesystem/#toc-support">浏览器支持和存储限制</a>。</p>
<h3 id="分割文件并上传各个部分">分割文件并上传各个部分</h3>
<p>使用 <a href="/tutorials/file/dndfiles/">File API</a>，我们可以将操作简化为上传大文件。我们采用的技术是：将要上传的文件分割成多个部分，为每个部分生成一个 XHR，然后在服务器上将各部分组合成文件。这类似于 Gmail 快速上传大附件的方法。使用这种技术还可以规避 Google 应用引擎对 http 请求的 32 MB 限制。</p>
<p><pre class="prettyprint"><span class="pln">window</span><span class="pun">.</span><span class="typ">BlobBuilder</span><span class="pun">=</span><span class="pln"> window</span><span class="pun">.</span><span class="typ">MozBlobBuilder</span><span class="pun">||</span><span class="pln"> window</span><span class="pun">.</span><span class="typ">WebKitBlobBuilder</span><span class="pun">||</span><span class="pln"><br>                     window</span><span class="pun">.</span><span class="typ">BlobBuilder</span><span class="pun">;</span><span class="kwd">function</span><span class="pln"> upload</span><span class="pun">(</span><span class="pln">blobOrFile</span><span class="pun">)</span><span class="pun">{</span><span class="kwd">var</span><span class="pln"> xhr </span><span class="pun">=</span><span class="kwd">new</span><span class="typ">XMLHttpRequest</span><span class="pun">();</span><span class="pln"><br>  xhr</span><span class="pun">.</span><span class="pln">open</span><span class="pun">(</span><span class="str">‘POST’</span><span class="pun">,</span><span class="str">‘/server’</span><span class="pun">,</span><span class="kwd">true</span><span class="pun">);</span><span class="pln"><br>  xhr</span><span class="pun">.</span><span class="pln">onload </span><span class="pun">=</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">e</span><span class="pun">)</span><span class="pun">{</span><span class="pun">…</span><span class="pun">};</span><span class="pln"><br>  xhr</span><span class="pun">.</span><span class="pln">send</span><span class="pun">(</span><span class="pln">blobOrFile</span><span class="pun">);</span><span class="pun">}</span><span class="pln"></span></pre></p>
<p>document<span class="pun">.</span><span class="pln">querySelector</span><span class="pun">(</span><span class="str">‘input[type=”file”]’</span><span class="pun">).</span><span class="pln">addEventListener</span><span class="pun">(</span><span class="str">‘change’</span><span class="pun">,</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">e</span><span class="pun">)</span><span class="pun">{</span><span class="kwd">var</span><span class="pln"> blob </span><span class="pun">=</span><span class="kwd">this</span><span class="pun">.</span><span class="pln">files</span><span class="pun">[</span><span class="lit">0</span><span class="pun">];</span><span class="kwd">const</span><span class="pln"> BYTES_PER_CHUNK </span><span class="pun">=</span><span class="lit">1024</span><span class="pun">*</span><span class="lit">1024</span><span class="pun">;</span><span class="com">// 1MB chunk sizes.</span><span class="kwd">const</span><span class="pln"> SIZE </span><span class="pun">=</span><span class="pln"> blob</span><span class="pun">.</span><span class="pln">size</span><span class="pun">;</span><span class="kwd">var</span><span class="pln"> start </span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="kwd">var</span><span class="kwd">end</span><span class="pun">=</span><span class="pln"> BYTES_PER_CHUNK</span><span class="pun">;</span><span class="kwd">while</span><span class="pun">(</span><span class="pln">start </span><span class="pun">&lt;</span><span class="pln"> SIZE</span><span class="pun">)</span><span class="pun">{</span><span class="com">// Note: blob.slice has changed semantics and been prefixed. See <a href="http://goo.gl/U9mE5" target="_blank" rel="external">http://goo.gl/U9mE5</a>.</span><span class="kwd">if</span><span class="pun">(</span><span class="str">‘mozSlice’</span><span class="kwd">in</span><span class="pln"> blob</span><span class="pun">)</span><span class="pun">{</span><span class="kwd">var</span><span class="pln"> chunk </span><span class="pun">=</span><span class="pln"> blob</span><span class="pun">.</span><span class="pln">mozSlice</span><span class="pun">(</span><span class="pln">start</span><span class="pun">,</span><span class="kwd">end</span><span class="pun">);</span><span class="pun">}</span><span class="kwd">else</span><span class="pun">{</span><span class="kwd">var</span><span class="pln"> chunk </span><span class="pun">=</span><span class="pln"> blob</span><span class="pun">.</span><span class="pln">webkitSlice</span><span class="pun">(</span><span class="pln">start</span><span class="pun">,</span><span class="kwd">end</span><span class="pun">);</span><span class="pun">}</span><span class="pln"></span></p>
<pre><code>upload<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>(<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pln"</span>&gt;</span>chunk<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>);<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pln"</span>&gt;</span>

start <span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>=<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"kwd"</span>&gt;</span>end<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>;<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"kwd"</span>&gt;</span>end<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>=<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pln"</span>&gt;</span> start <span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>+<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pln"</span>&gt;</span> BYTES_PER_CHUNK<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>;<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>}<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>},<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"kwd"</span>&gt;</span>false<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>);<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;<span class="title">span</span> <span class="attribute">class</span>=<span class="value">"pun"</span>&gt;</span>})();<span class="tag">&lt;/<span class="title">span</span>&gt;</span><span class="tag">&lt;/<span class="title">pre</span>&gt;</span>
</code></pre><p>用于在服务器上重组文件的代码并未在此显示。</p>
<p><strong>赶快试试吧</strong>！</p>
<div class="example">#bytes/chunk: <input id="numChunks" min="1048576" type="number" value="1048576"><br><input id="afile" class="button" type="file"><br><div id="bars"></div><br></div>

<h2 id="参考">参考</h2>
<ul>
<li><a href="http://dev.w3.org/2006/webapi/XMLHttpRequest-2/" target="_blank" rel="external">2 级 XMLHttpRequest</a> 规范</li>
<li><a href="http://dev.w3.org/2006/waf/access-control/" target="_blank" rel="external">跨源资源共享 (CORS)</a> 规范</li>
<li><a href="http://www.w3.org/TR/file-upload/" target="_blank" rel="external">File API</a> 规范</li>
<li><a href="http://dev.w3.org/2009/dap/file-system/pub/FileSystem/" target="_blank" rel="external">FileSystem API</a> 规范</li>
</ul>
<a id="more"></a>

<a id="more"></a>

<a id="more"></a>  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/XMLHttpRequest/">XMLHttpRequest</a>
  </div>


<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/JavaScript/">JavaScript</a>
</div>



<div class="article-share" id="share">

  <div data-url="http://umitime.com/2014/06/20/html5-xmlhttprequest-new-features/" data-title="HTML5 XMLHttpRequest中的新功能 | 听雨~" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2014/06/24/start-to-love-photography/" title="摄影，从现在玩起~">
  <strong>PREVIOUS:</strong><br/>
  <span>
  摄影，从现在玩起~</span>
</a>
</div>


<div class="next">
<a href="/2014/06/19/google-visual-assets-guidelines/"  title="Google Visual Assets Guidelines">
 <strong>NEXT:</strong><br/> 
 <span>Google Visual Assets Guidelines
</span>
</a>
</div>

</nav>

	
</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#简介"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#抓取数据"><span class="toc-number">2.</span> <span class="toc-text">抓取数据</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Blob_响应"><span class="toc-number">2.0.1.</span> <span class="toc-text">Blob 响应</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#上传文件或_blob：xhr-send(Blob)"><span class="toc-number">2.1.</span> <span class="toc-text">上传文件或 blob：xhr.send(Blob)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#上传字节：xhr-send(ArrayBuffer)"><span class="toc-number">2.2.</span> <span class="toc-text">上传字节：xhr.send(ArrayBuffer)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#跨源资源共享_(CORS)"><span class="toc-number">3.</span> <span class="toc-text">跨源资源共享 (CORS)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#启用_CORS_请求"><span class="toc-number">3.1.</span> <span class="toc-text">启用 CORS 请求</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实际示例："><span class="toc-number">4.</span> <span class="toc-text">实际示例：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#下载文件并保存到_HTML5_文件系统"><span class="toc-number">4.1.</span> <span class="toc-text">下载文件并保存到 HTML5 文件系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分割文件并上传各个部分"><span class="toc-number">4.2.</span> <span class="toc-text">分割文件并上传各个部分</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-number">5.</span> <span class="toc-text">参考</span></a></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">
<div id="authorInfo">
	
		<div class="author-logo"></div>		
	
	<div class="social-list" class="clearfix">
		
		
		
		<a href="https://github.com/tofishes" target="_blank" title="github"></a>
		
		
		
	</div>
</div>

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
			<li><a href="/categories/Books/" title="Books">Books<sup>4</sup></a></li>
		
			<li><a href="/categories/html-amp-css/JavaScript/" title="JavaScript">JavaScript<sup>2</sup></a></li>
		
			<li><a href="/categories/JavaScript/" title="JavaScript">JavaScript<sup>41</sup></a></li>
		
			<li><a href="/categories/code/WordPress/" title="WordPress">WordPress<sup>1</sup></a></li>
		
			<li><a href="/categories/Books/WordPress/" title="WordPress">WordPress<sup>1</sup></a></li>
		
			<li><a href="/categories/linux/WordPress/" title="WordPress">WordPress<sup>1</sup></a></li>
		
			<li><a href="/categories/solution/WordPress/" title="WordPress">WordPress<sup>3</sup></a></li>
		
			<li><a href="/categories/WordPress/" title="WordPress">WordPress<sup>2</sup></a></li>
		
			<li><a href="/categories/code/" title="code">code<sup>7</sup></a></li>
		
			<li><a href="/categories/database/" title="database">database<sup>5</sup></a></li>
		
			<li><a href="/categories/code/html-amp-css/" title="html&amp;amp;css">html&amp;amp;css<sup>1</sup></a></li>
		
			<li><a href="/categories/html-amp-css/" title="html&amp;amp;css">html&amp;amp;css<sup>23</sup></a></li>
		
			<li><a href="/categories/JavaScript/jQuery/" title="jQuery">jQuery<sup>2</sup></a></li>
		
			<li><a href="/categories/code/jQuery/" title="jQuery">jQuery<sup>1</sup></a></li>
		
			<li><a href="/categories/html-amp-css/jQuery/" title="jQuery">jQuery<sup>2</sup></a></li>
		
			<li><a href="/categories/jQuery/" title="jQuery">jQuery<sup>17</sup></a></li>
		
			<li><a href="/categories/java/" title="java">java<sup>11</sup></a></li>
		
			<li><a href="/categories/linux/" title="linux">linux<sup>20</sup></a></li>
		
			<li><a href="/categories/python/" title="python">python<sup>1</sup></a></li>
		
			<li><a href="/categories/share/" title="share">share<sup>1</sup></a></li>
		
			<li><a href="/categories/soft/" title="soft">soft<sup>4</sup></a></li>
		
			<li><a href="/categories/code/solution/" title="solution">solution<sup>1</sup></a></li>
		
			<li><a href="/categories/jQuery/solution/" title="solution">solution<sup>5</sup></a></li>
		
			<li><a href="/categories/JavaScript/solution/" title="solution">solution<sup>2</sup></a></li>
		
			<li><a href="/categories/solution/" title="solution">solution<sup>25</sup></a></li>
		
			<li><a href="/categories/html-amp-css/solution/" title="solution">solution<sup>2</sup></a></li>
		
			<li><a href="/categories/database/solution/" title="solution">solution<sup>2</sup></a></li>
		
			<li><a href="/categories/html-amp-css/jQuery/solution/" title="solution">solution<sup>1</sup></a></li>
		
			<li><a href="/categories/java/solution/" title="solution">solution<sup>3</sup></a></li>
		
			<li><a href="/categories/linux/solution/" title="solution">solution<sup>4</sup></a></li>
		
			<li><a href="/categories/solution/thinking/" title="thinking">thinking<sup>5</sup></a></li>
		
			<li><a href="/categories/thinking/" title="thinking">thinking<sup>10</sup></a></li>
		
			<li><a href="/categories/vim/" title="vim">vim<sup>9</sup></a></li>
		
			<li><a href="/categories/thinking/前端优化/" title="前端优化">前端优化<sup>1</sup></a></li>
		
			<li><a href="/categories/JavaScript/前端优化/" title="前端优化">前端优化<sup>1</sup></a></li>
		
			<li><a href="/categories/前端优化/" title="前端优化">前端优化<sup>8</sup></a></li>
		
			<li><a href="/categories/拓展/" title="拓展">拓展<sup>22</sup></a></li>
		
			<li><a href="/categories/java/拓展/" title="拓展">拓展<sup>2</sup></a></li>
		
			<li><a href="/categories/solution/拓展/" title="拓展">拓展<sup>4</sup></a></li>
		
			<li><a href="/categories/JavaScript/拓展/" title="拓展">拓展<sup>2</sup></a></li>
		
			<li><a href="/categories/前端优化/拓展/" title="拓展">拓展<sup>1</sup></a></li>
		
			<li><a href="/categories/WordPress/服务器/" title="服务器">服务器<sup>1</sup></a></li>
		
			<li><a href="/categories/服务器/" title="服务器">服务器<sup>13</sup></a></li>
		
			<li><a href="/categories/拓展/服务器/" title="服务器">服务器<sup>1</sup></a></li>
		
			<li><a href="/categories/solution/服务器/" title="服务器">服务器<sup>3</sup></a></li>
		
			<li><a href="/categories/前端优化/服务器/" title="服务器">服务器<sup>1</sup></a></li>
		
			<li><a href="/categories/linux/solution/服务器/" title="服务器">服务器<sup>1</sup></a></li>
		
			<li><a href="/categories/linux/服务器/" title="服务器">服务器<sup>4</sup></a></li>
		
			<li><a href="/categories/JavaScript/移动开发/" title="移动开发">移动开发<sup>1</sup></a></li>
		
			<li><a href="/categories/移动开发/" title="移动开发">移动开发<sup>3</sup></a></li>
		
			<li><a href="/categories/solution/自然/" title="自然">自然<sup>2</sup></a></li>
		
			<li><a href="/categories/html-amp-css/jQuery/自然/" title="自然">自然<sup>1</sup></a></li>
		
			<li><a href="/categories/自然/" title="自然">自然<sup>17</sup></a></li>
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			<li><a href="/tags/2012/" title="2012">2012<sup>1</sup></a></li>
		
			<li><a href="/tags/3cols-layout/" title="3cols layout">3cols layout<sup>1</sup></a></li>
		
			<li><a href="/tags/3栏布局/" title="3栏布局">3栏布局<sup>1</sup></a></li>
		
			<li><a href="/tags/Balsamiq-Mockups/" title="Balsamiq Mockups">Balsamiq Mockups<sup>1</sup></a></li>
		
			<li><a href="/tags/BigPipe/" title="BigPipe">BigPipe<sup>1</sup></a></li>
		
			<li><a href="/tags/CORS/" title="CORS">CORS<sup>1</sup></a></li>
		
			<li><a href="/tags/CSS3背景透明/" title="CSS3背景透明">CSS3背景透明<sup>1</sup></a></li>
		
			<li><a href="/tags/CSS背景透明/" title="CSS背景透明">CSS背景透明<sup>1</sup></a></li>
		
			<li><a href="/tags/Callbacks/" title="Callbacks">Callbacks<sup>1</sup></a></li>
		
			<li><a href="/tags/Error-configuring-AutoCommit/" title="Error configuring AutoCommit">Error configuring AutoCommit<sup>1</sup></a></li>
		
			<li><a href="/tags/Finder/" title="Finder">Finder<sup>1</sup></a></li>
		
			<li><a href="/tags/HTML5专业编程/" title="HTML5专业编程">HTML5专业编程<sup>1</sup></a></li>
		
			<li><a href="/tags/Hadoop/" title="Hadoop">Hadoop<sup>1</sup></a></li>
		
			<li><a href="/tags/Hammer-js/" title="Hammer.js">Hammer.js<sup>1</sup></a></li>
		
			<li><a href="/tags/JavaScript作用域/" title="JavaScript作用域">JavaScript作用域<sup>1</sup></a></li>
		
			<li><a href="/tags/MapReduce/" title="MapReduce">MapReduce<sup>1</sup></a></li>
		
			<li><a href="/tags/NERDTree/" title="NERDTree">NERDTree<sup>1</sup></a></li>
		
			<li><a href="/tags/RequireJS/" title="RequireJS">RequireJS<sup>1</sup></a></li>
		
			<li><a href="/tags/TransactionException/" title="TransactionException">TransactionException<sup>1</sup></a></li>
		
			<li><a href="/tags/Varnish/" title="Varnish">Varnish<sup>1</sup></a></li>
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
      <li><a href="http://gengbiao.me" target="_blank" title="gengbiao">Coney's Blog</a></li>
      <li><a href="http://hexo.io" target="_blank" title="Hexo">Hexo</a></li>
    </ul>
</div>


  <div class="rsspart">
	<a href="atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  
  <div class="tagcloudlist">
    <p class="asidetitle">标签云</p>
    <div class="tagcloudlist clearfix">
       <a href="/tags/2012/" style="font-size: 10.00px;">2012</a><a href="/tags/3cols-layout/" style="font-size: 10.00px;">3cols layout</a><a href="/tags/3栏布局/" style="font-size: 10.00px;">3栏布局</a><a href="/tags/Balsamiq-Mockups/" style="font-size: 10.00px;">Balsamiq Mockups</a><a href="/tags/BigPipe/" style="font-size: 10.00px;">BigPipe</a><a href="/tags/CORS/" style="font-size: 10.00px;">CORS</a><a href="/tags/CSS3背景透明/" style="font-size: 10.00px;">CSS3背景透明</a><a href="/tags/CSS背景透明/" style="font-size: 10.00px;">CSS背景透明</a><a href="/tags/Callbacks/" style="font-size: 10.00px;">Callbacks</a><a href="/tags/Error-configuring-AutoCommit/" style="font-size: 10.00px;">Error configuring AutoCommit</a><a href="/tags/Finder/" style="font-size: 10.00px;">Finder</a><a href="/tags/HTML5专业编程/" style="font-size: 10.00px;">HTML5专业编程</a><a href="/tags/Hadoop/" style="font-size: 10.00px;">Hadoop</a><a href="/tags/Hammer-js/" style="font-size: 10.00px;">Hammer.js</a><a href="/tags/JavaScript作用域/" style="font-size: 10.00px;">JavaScript作用域</a><a href="/tags/MapReduce/" style="font-size: 10.00px;">MapReduce</a><a href="/tags/NERDTree/" style="font-size: 10.00px;">NERDTree</a><a href="/tags/RequireJS/" style="font-size: 10.00px;">RequireJS</a><a href="/tags/TransactionException/" style="font-size: 10.00px;">TransactionException</a><a href="/tags/Varnish/" style="font-size: 10.00px;">Varnish</a><a href="/tags/Weinre/" style="font-size: 10.00px;">Weinre</a><a href="/tags/WordPress/" style="font-size: 20.00px;">WordPress</a><a href="/tags/WordPress，代码高亮，定制样式，自定义css，自定义js/" style="font-size: 10.00px;">WordPress，代码高亮，定制样式，自定义css，自定义js</a><a href="/tags/XMLHttpRequest/" style="font-size: 10.00px;">XMLHttpRequest</a><a href="/tags/ajax/" style="font-size: 10.00px;">ajax</a><a href="/tags/ajax登录/" style="font-size: 10.00px;">ajax登录</a><a href="/tags/angular-js/" style="font-size: 10.00px;">angular.js</a><a href="/tags/animate/" style="font-size: 10.00px;">animate</a><a href="/tags/api/" style="font-size: 10.00px;">api</a><a href="/tags/attribute/" style="font-size: 10.00px;">attribute</a><a href="/tags/backbone/" style="font-size: 10.00px;">backbone</a><a href="/tags/bad-gateway/" style="font-size: 10.00px;">bad gateway</a><a href="/tags/base64/" style="font-size: 10.00px;">base64</a><a href="/tags/bug/" style="font-size: 10.00px;">bug</a><a href="/tags/canvas/" style="font-size: 10.00px;">canvas</a><a href="/tags/canvas-图片/" style="font-size: 10.00px;">canvas 图片</a><a href="/tags/cdn/" style="font-size: 10.00px;">cdn</a><a href="/tags/checked-exception/" style="font-size: 10.00px;">checked exception</a><a href="/tags/closest-method/" style="font-size: 10.00px;">closest method</a><a href="/tags/cookie-free/" style="font-size: 10.00px;">cookie free</a>
    </div>
  </div>


</aside>
</div>
    </div>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>





<script>
     window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["qzone","tsina","weixin","renren","tqq","tieba","douban","sqq","diandian","huaban","youdao","mail","ty","fbook","twi","linkedin","copy","print"],"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"4","bdPos":"right","bdTop":"350"},"image":{"viewList":["weixin","qzone","tsina","renren","douban","tqq"],"viewText":"分享：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["weixin","qzone","tsina","renren","douban","tqq"]}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script>


  </body>
</html>
